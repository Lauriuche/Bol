<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Configurações PWA (Para instalar como App) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Industrial Offline">
    
    <title>Industrial Offline</title>
    
    <!-- Bibliotecas Visuais e Funcionais -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Dexie.js (Banco de Dados Local) e JSZip (Gerador de ZIP) -->
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Estilos e Animações */
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; padding-bottom: env(safe-area-inset-bottom); }
        
        .view-container { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .view-container.active { display: block; opacity: 1; transform: translateY(0); }
        
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .glass-panel-dark { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); }
        
        .photo-grid-item { position: relative; overflow: hidden; }
        .photo-grid-item.selected img { filter: brightness(0.6); transform: scale(1.05); }
        .photo-grid-item.selected .check-icon { opacity: 1; transform: scale(1); }
        .check-icon { opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #3b82f6; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 pb-24">

    <!-- CABEÇALHO -->
    <header class="fixed top-0 w-full z-50 glass-panel transition-all duration-300" id="mainHeader">
        <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 overflow-hidden">
                <button id="backBtn" class="hidden w-10 h-10 rounded-full flex items-center justify-center text-slate-600 hover:bg-slate-100 transition-colors" onclick="goBack()">
                    <i class="fas fa-arrow-left text-lg"></i>
                </button>
                <div class="flex flex-col">
                    <h1 id="appTitle" class="text-lg font-bold text-slate-900 truncate">Indústrias</h1>
                    <span id="appSubtitle" class="text-xs text-slate-500 font-medium"> <i class="fas fa-database text-orange-500 mr-1"></i> Armazenamento Local</span>
                </div>
            </div>
            
            <!-- Botão de Backup ZIP -->
            <button id="exportBtn" class="text-slate-600 hover:text-blue-600 p-2 relative" onclick="exportDataToZip()">
                <i class="fas fa-file-zipper text-xl"></i>
            </button>
            
            <button id="selectModeBtn" class="hidden text-sm font-semibold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors active:scale-95" onclick="toggleSelectionMode()">
                Selecionar
            </button>
        </div>
    </header>

    <div class="h-20"></div>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="max-w-md mx-auto px-4 w-full">

        <!-- TELA 1: LISTA DE INDÚSTRIAS -->
        <div id="view-industries" class="view-container active">
            <!-- Estatísticas -->
            <div class="mb-6 grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                    <p class="text-xs text-slate-400 font-bold uppercase">Indústrias</p>
                    <p class="text-2xl font-bold text-slate-800" id="statTotalIndustries">0</p>
                    <div class="absolute right-0 top-0 p-4 opacity-5"><i class="fas fa-industry text-4xl"></i></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                    <p class="text-xs text-slate-400 font-bold uppercase">Fotos (Total)</p>
                    <p class="text-2xl font-bold text-orange-500" id="statTotalPhotos">0</p>
                     <div class="absolute right-0 top-0 p-4 opacity-5"><i class="fas fa-sd-card text-4xl"></i></div>
                </div>
            </div>

            <div id="industriesList" class="space-y-3 pb-20"></div>
            
            <div id="emptyIndustries" class="hidden flex flex-col items-center justify-center py-20 opacity-60">
                <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-slate-300"><i class="fas fa-city text-4xl"></i></div>
                <h3 class="text-slate-900 font-semibold text-lg">Memória Vazia</h3>
                <p class="text-slate-500 text-sm mt-1">Crie pastas locais para organizar.</p>
            </div>

            <!-- Botão Adicionar -->
            <button onclick="showAddIndustryModal()" class="fixed bottom-8 right-6 w-14 h-14 bg-blue-600 rounded-full text-white flex items-center justify-center text-2xl shadow-lg hover:shadow-blue-500/50 active:scale-90 transition-all z-40">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- TELA 2: LISTA DE DATAS -->
        <div id="view-dates" class="view-container">
            <div id="datesList" class="space-y-3 pb-20"></div>
            <div id="emptyDates" class="hidden flex flex-col items-center justify-center py-20 opacity-60">
                <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-4 text-slate-300"><i class="fas fa-camera text-4xl"></i></div>
                <h3 class="text-slate-900 font-semibold text-lg">Sem Fotos</h3>
                <p class="text-slate-500 text-sm mt-1">Tire fotos para criar datas automaticamente.</p>
            </div>
            <label for="cameraInput" class="fixed bottom-8 right-6 w-14 h-14 bg-slate-900 rounded-full text-white flex items-center justify-center text-2xl shadow-lg hover:shadow-slate-900/50 active:scale-90 transition-all cursor-pointer z-40">
                <i class="fas fa-camera"></i>
            </label>
        </div>

        <!-- TELA 3: GALERIA DE FOTOS -->
        <div id="view-gallery" class="view-container">
            <div id="galleryGrid" class="grid grid-cols-3 gap-1 pb-32"></div>
            <label id="fabCamera" for="cameraInput" class="fixed bottom-8 right-6 w-14 h-14 bg-slate-900 rounded-full text-white flex items-center justify-center text-2xl shadow-lg hover:shadow-slate-900/50 active:scale-90 transition-all cursor-pointer z-40">
                <i class="fas fa-camera"></i>
            </label>
            
            <!-- Painel de Seleção -->
            <div id="selectionActions" class="fixed bottom-6 left-4 right-4 glass-panel-dark rounded-2xl p-4 flex justify-between items-center shadow-2xl z-50 transform translate-y-[150%] transition-transform duration-300">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white font-bold text-sm" id="countIndicator">0</div>
                    <span class="text-white text-sm font-medium">Fotos</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="deleteSelectedPhotos()" class="w-10 h-10 rounded-full bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center"><i class="fas fa-trash-alt text-sm"></i></button>
                    <button onclick="shareSelectedPhotos()" class="h-10 px-5 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center gap-2 font-semibold text-sm shadow-lg active:scale-95 transition-all">Enviar <i class="fab fa-whatsapp text-lg"></i></button>
                </div>
            </div>
        </div>
    </main>

    <!-- COMPONENTES INVISÍVEIS E MODAIS -->
    
    <!-- Input da Câmera -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="handleCameraCapture(this)">

    <!-- Modal Nova Indústria -->
    <div id="modalAddIndustry" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">Nova Pasta Local</h2>
                <button onclick="closeModal('modalAddIndustry')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <input type="text" id="newIndustryName" placeholder="Nome da Indústria" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 mb-4 text-slate-800 focus:outline-none focus:ring-2 focus:ring-orange-500 transition-all">
            <button id="btnAddInd" onclick="addIndustry()" class="w-full bg-blue-600 text-white font-semibold py-4 rounded-xl shadow-lg hover:bg-blue-700 active:scale-[0.98] transition-all flex justify-center items-center">Criar Pasta</button>
        </div>
    </div>

    <!-- Modal Ver Foto (Fullscreen) -->
    <div id="modalViewPhoto" class="fixed inset-0 bg-black z-[70] hidden flex flex-col items-center justify-center opacity-0 transition-opacity duration-300">
        <button onclick="closeModal('modalViewPhoto')" class="absolute top-4 right-4 text-white/80 p-4 z-20"><i class="fas fa-times text-2xl"></i></button>
        <div id="photoLoader" class="absolute text-white"><div class="spinner"></div></div>
        <img id="photoPreview" src="" class="max-h-[80vh] max-w-full object-contain relative z-10" onload="document.getElementById('photoLoader').classList.add('hidden')">
        <div class="absolute bottom-0 w-full p-8 pb-12 flex justify-center gap-8 bg-gradient-to-t from-black/90 to-transparent z-20">
            <button onclick="deleteCurrentPhoto()" class="flex flex-col items-center gap-1 text-white/60 hover:text-red-400"><i class="fas fa-trash-alt text-2xl mb-1"></i><span class="text-[10px]">Excluir</span></button>
            <button onclick="shareSinglePhoto()" class="flex flex-col items-center gap-1 text-white transform -translate-y-6"><div class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center shadow-lg shadow-green-500/40 mb-1 active:scale-95 transition-transform"><i class="fab fa-whatsapp text-3xl"></i></div><span class="text-xs font-bold">Enviar</span></button>
            <button onclick="downloadCurrentPhoto()" class="flex flex-col items-center gap-1 text-white/60 hover:text-blue-400"><i class="fas fa-download text-2xl mb-1"></i><span class="text-[10px]">Salvar</span></button>
        </div>
    </div>

    <!-- Tela de Loading do ZIP -->
    <div id="zipLoader" class="fixed inset-0 bg-slate-900/90 z-[100] hidden flex flex-col items-center justify-center text-white">
        <div class="w-16 h-16 border-4 border-white/20 border-t-blue-500 rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold">Criando Backup...</h2>
        <p class="text-sm text-slate-400 mt-2">Organizando pastas e compactando fotos.</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 glass-panel-dark text-white px-6 py-3 rounded-full shadow-2xl text-sm font-medium flex items-center gap-3 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none z-[100] whitespace-nowrap">
        <i class="fas fa-check-circle text-green-400"></i><span id="toastMsg">Sucesso</span>
    </div>

    <!-- LÓGICA DO APP -->
    <script>
        // --- 1. BANCO DE DADOS LOCAL (Dexie.js) ---
        const db = new Dexie('IndustrialAppDB');
        db.version(1).stores({
            industries: '++id, name, timestamp',
            photos: '++id, industryId, dateString, timestamp'
        });

        const state = {
            view: 'industries',
            currentIndustryId: null,
            currentDate: null,
            isSelectionMode: false,
            selectedPhotoIds: new Set(),
            currentPhotoId: null,
            industries: [],
            photos: [] 
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await refreshData();
            renderView();
        });

        async function refreshData() {
            state.industries = await db.industries.orderBy('timestamp').reverse().toArray();
            state.photos = await db.photos.orderBy('timestamp').reverse().toArray();
            updateStats();
        }

        // --- 2. SISTEMA DE EXPORTAÇÃO ZIP ---
        async function exportDataToZip() {
            const loader = document.getElementById('zipLoader');
            loader.classList.remove('hidden');

            try {
                const zip = new JSZip();
                const industries = await db.industries.toArray();
                const photos = await db.photos.toArray();

                if (photos.length === 0) {
                    alert("Sem fotos para exportar.");
                    loader.classList.add('hidden');
                    return;
                }

                for (const ind of industries) {
                    const indFolder = zip.folder(sanitizeName(ind.name));
                    const indPhotos = photos.filter(p => p.industryId === ind.id);
                    
                    for (const photo of indPhotos) {
                        // Formata nome da pasta: DD-MM-YYYY
                        const [y, m, d] = photo.dateString.split('-');
                        const folderDateName = `${d}-${m}-${y}`;
                        
                        const dateFolder = indFolder.folder(folderDateName);
                        const blob = dataURLtoBlob(photo.dataUrl);
                        const fileName = `Foto_${photo.id}.jpg`;
                        
                        dateFolder.file(fileName, blob);
                    }
                }

                const content = await zip.generateAsync({type: "blob"});
                const now = new Date();
                const timeStr = `${now.getDate()}-${now.getMonth()+1}_${now.getHours()}h${now.getMinutes()}`;
                saveAs(content, `Backup_Industrial_${timeStr}.zip`);
                showToast("Backup baixado!");

            } catch (e) {
                console.error(e);
                alert("Erro ao criar backup: " + e.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function sanitizeName(name) {
            return name.replace(/[^a-z0-9áéíóúãõâêîôûç -]/gim, "_").trim();
        }

        // --- 3. AÇÕES (CRUD) ---
        
        async function addIndustry() {
            const nameInput = document.getElementById('newIndustryName');
            const name = nameInput.value.trim();
            if (!name) return;

            await db.industries.add({ name: name, timestamp: Date.now() });

            closeModal('modalAddIndustry');
            nameInput.value = '';
            await refreshData();
            renderIndustriesList();
            showToast("Pasta criada!");
        }

        async function deleteIndustry(id) {
            if (!confirm("Apagar pasta local e todas as fotos dentro dela?")) return;
            
            await db.transaction('rw', db.industries, db.photos, async () => {
                await db.industries.delete(id);
                await db.photos.where('industryId').equals(id).delete();
            });

            await refreshData();
            renderIndustriesList();
            showToast("Apagado do celular.");
        }

        async function handleCameraCapture(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                showToast("Salvando na memória...", false);
                
                try {
                    const resizedDataUrl = await resizeImage(file);
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('pt-BR').split('/').reverse().join('-');
                    
                    await db.photos.add({
                        industryId: state.currentIndustryId,
                        dateString: dateStr,
                        dataUrl: resizedDataUrl,
                        timestamp: Date.now()
                    });
                    
                    await refreshData();
                    showToast("Salvo!");
                    
                    if (state.view !== 'gallery' || state.currentDate !== dateStr) {
                        navigateTo('gallery', { industryId: state.currentIndustryId, date: dateStr });
                    } else {
                        renderGallery();
                    }
                } catch (e) {
                    console.error(e);
                    showToast("Erro: Memória cheia?", true);
                }
            }
            input.value = '';
        }

        async function deleteCurrentPhoto() {
            if(!confirm("Apagar foto?")) return;
            await db.photos.delete(state.currentPhotoId);
            await refreshData();
            closeModal('modalViewPhoto');
            renderGallery();
            showToast("Foto apagada");
        }

        async function deleteSelectedPhotos() {
            const count = state.selectedPhotoIds.size;
            if(!confirm(`Apagar ${count} fotos?`)) return;
            
            await db.transaction('rw', db.photos, async () => {
                for (const id of state.selectedPhotoIds) {
                    await db.photos.delete(id);
                }
            });

            await refreshData();
            exitSelectionMode();
            showToast("Fotos apagadas");
        }

        // --- 4. RENDERIZAÇÃO ---

        function renderIndustriesList() {
            const list = document.getElementById('industriesList');
            const empty = document.getElementById('emptyIndustries');
            list.innerHTML = '';
            
            if (state.industries.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            state.industries.forEach(ind => {
                const count = state.photos.filter(p => p.industryId === ind.id).length;
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between interactive-card cursor-pointer';
                div.onclick = () => navigateTo('dates', { industryId: ind.id });
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center"><i class="fas fa-industry text-xl"></i></div>
                        <div><h3 class="font-bold text-slate-800">${ind.name}</h3><p class="text-xs text-slate-500">${count} fotos locais</p></div>
                    </div>
                    <button class="w-8 h-8 rounded-full text-slate-300 hover:text-red-500" onclick="event.stopPropagation(); deleteIndustry(${ind.id})"><i class="fas fa-trash-alt text-xs"></i></button>
                `;
                list.appendChild(div);
            });
        }

        function renderDatesList() {
            const list = document.getElementById('datesList');
            const empty = document.getElementById('emptyDates');
            list.innerHTML = '';
            
            const indPhotos = state.photos.filter(p => p.industryId === state.currentIndustryId);
            if (indPhotos.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            const dates = [...new Set(indPhotos.map(p => p.dateString))].sort((a,b) => new Date(b) - new Date(a));
            dates.forEach(dateStr => {
                const count = indPhotos.filter(p => p.dateString === dateStr).length;
                const [y,m,d] = dateStr.split('-');
                const month = new Date(y, m-1, d).toLocaleString('pt-BR',{month:'short'}).replace('.','');
                
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between interactive-card cursor-pointer';
                div.onclick = () => navigateTo('gallery', { industryId: state.currentIndustryId, date: dateStr });
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-xl flex flex-col items-center justify-center border border-indigo-100">
                            <span class="text-[10px] font-bold uppercase mt-1 leading-none">${month}</span><span class="text-lg font-bold leading-none">${d}</span>
                        </div>
                        <div><h3 class="font-bold text-slate-800">Pasta do Dia</h3><p class="text-xs text-slate-500">${count} arquivos</p></div>
                    </div>
                    <i class="fas fa-chevron-right text-slate-300 text-xs"></i>
                `;
                list.appendChild(div);
            });
        }

        function renderGallery() {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = '';
            
            const photos = state.photos
                .filter(p => p.industryId === state.currentIndustryId && p.dateString === state.currentDate)
                .sort((a,b) => b.timestamp - a.timestamp);

            photos.forEach(photo => {
                const isSel = state.selectedPhotoIds.has(photo.id);
                const div = document.createElement('div');
                div.className = `aspect-square bg-slate-200 cursor-pointer photo-grid-item ${isSel ? 'selected' : ''}`;
                div.onclick = () => state.isSelectionMode ? togglePhotoSelection(photo.id) : openPhotoModal(photo);
                div.innerHTML = `
                    <img src="${photo.dataUrl}" class="w-full h-full object-cover">
                    <div class="check-icon absolute top-2 right-2 w-6 h-6 bg-blue-500 border-2 border-white rounded-full flex items-center justify-center shadow-md"><i class="fas fa-check text-white text-[10px]"></i></div>
                `;
                grid.appendChild(div);
            });
            updateSelectionUI();
        }

        // --- 5. NAVEGAÇÃO ---
        function navigateTo(view, params = {}) {
            if(state.view === 'gallery' && view !== 'gallery') exitSelectionMode();
            state.view = view;
            if(params.industryId) state.currentIndustryId = params.industryId;
            if(params.date) state.currentDate = params.date;
            renderView();
        }

        function goBack() {
            if(state.isSelectionMode) { exitSelectionMode(); return; }
            if(state.view === 'gallery') navigateTo('dates', { industryId: state.currentIndustryId });
            else if(state.view === 'dates') { state.currentIndustryId = null; navigateTo('industries'); }
        }

        function renderView() {
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            const backBtn = document.getElementById('backBtn');
            const title = document.getElementById('appTitle');
            const selectBtn = document.getElementById('selectModeBtn');
            const exportBtn = document.getElementById('exportBtn');

            selectBtn.classList.add('hidden');
            if (state.view === 'industries') exportBtn.classList.remove('hidden');
            else exportBtn.classList.add('hidden');

            if (state.view === 'industries') {
                document.getElementById('view-industries').classList.add('active');
                backBtn.classList.add('hidden');
                title.innerText = "Indústrias";
                renderIndustriesList();
            } else if (state.view === 'dates') {
                document.getElementById('view-dates').classList.add('active');
                backBtn.classList.remove('hidden');
                const ind = state.industries.find(i => i.id === state.currentIndustryId);
                title.innerText = ind ? ind.name : 'Indústria';
                renderDatesList();
            } else if (state.view === 'gallery') {
                document.getElementById('view-gallery').classList.add('active');
                backBtn.classList.remove('hidden');
                title.innerText = formatDateTitle(state.currentDate);
                selectBtn.classList.remove('hidden');
                selectBtn.innerText = state.isSelectionMode ? 'Cancelar' : 'Selecionar';
                renderGallery();
            }
        }

        function updateStats() {
            document.getElementById('statTotalIndustries').innerText = state.industries.length;
            document.getElementById('statTotalPhotos').innerText = state.photos.length;
        }

        // --- 6. UTILITÁRIOS ---
        
        function toggleSelectionMode() {
            state.isSelectionMode = !state.isSelectionMode;
            state.selectedPhotoIds.clear();
            const btn = document.getElementById('selectModeBtn');
            const fab = document.getElementById('fabCamera');
            if(state.isSelectionMode) {
                btn.innerText = "Cancelar";
                btn.className = "text-sm font-semibold text-red-500 bg-red-50 px-3 py-1.5 rounded-full";
                fab.classList.add('hidden');
            } else {
                btn.innerText = "Selecionar";
                btn.className = "text-sm font-semibold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full";
                fab.classList.remove('hidden');
                document.getElementById('selectionActions').classList.add('translate-y-[150%]');
            }
            renderGallery();
        }

        function togglePhotoSelection(id) {
            state.selectedPhotoIds.has(id) ? state.selectedPhotoIds.delete(id) : state.selectedPhotoIds.add(id);
            renderGallery();
        }

        function exitSelectionMode() {
            state.isSelectionMode = false;
            state.selectedPhotoIds.clear();
            toggleSelectionMode();
        }
        
        function openPhotoModal(p) {
            state.currentPhotoId = p.id;
            document.getElementById('photoLoader').classList.remove('hidden');
            document.getElementById('photoPreview').src = p.dataUrl;
            const m = document.getElementById('modalViewPhoto');
            m.classList.remove('hidden'); setTimeout(()=>m.classList.remove('opacity-0'),10);
        }

        async function shareSelectedPhotos() {
            const count = state.selectedPhotoIds.size;
            if(count === 0) return;
            const selected = state.photos.filter(p => state.selectedPhotoIds.has(p.id));
            try {
                const files = selected.map((p,i) => dataURLtoFile(p.dataUrl, `Foto_${i+1}.jpg`));
                if(navigator.canShare && navigator.canShare({files})) {
                    await navigator.share({files});
                    exitSelectionMode();
                } else alert("Envio múltiplo não suportado neste navegador. Use o botão ZIP para baixar.");
            } catch(e) { console.error(e); }
        }

        async function shareSinglePhoto() {
            const p = state.photos.find(x=>x.id===state.currentPhotoId);
            const f = dataURLtoFile(p.dataUrl, 'foto.jpg');
            if(navigator.canShare && navigator.canShare({files:[f]})) navigator.share({files:[f]});
        }

        function resizeImage(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const max = 1200; // Alta qualidade local
                        const scale = max/Math.max(img.width,img.height);
                        const w = (scale<1)?img.width*scale:img.width;
                        const h = (scale<1)?img.height*scale:img.height;
                        cvs.width=w; cvs.height=h;
                        cvs.getContext('2d').drawImage(img,0,0,w,h);
                        resolve(cvs.toDataURL('image/jpeg', 0.8));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        function dataURLtoFile(url, fn) {
            const arr = url.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]);
            let n = bstr.length, u8 = new Uint8Array(n);
            while(n--) u8[n] = bstr.charCodeAt(n);
            return new File([u8], fn, {type:mime});
        }

        function dataURLtoBlob(dataurl) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8 = new Uint8Array(n);
            while(n--){
                u8[n] = bstr.charCodeAt(n);
            }
            return new Blob([u8], {type:mime});
        }

        function formatDateTitle(s) { if(!s)return''; const [y,m,d]=s.split('-'); return new Date(y,m-1,d).toLocaleDateString('pt-BR',{weekday:'short',day:'numeric',month:'long'}); }
        
        function showToast(m,err=false) {
            const t=document.getElementById('toast'), i=t.querySelector('i');
            document.getElementById('toastMsg').innerText=m;
            i.className = err ? 'fas fa-exclamation-circle text-red-400' : 'fas fa-check-circle text-green-400';
            t.classList.remove('opacity-0','translate-y-[-20px]');
            setTimeout(()=>t.classList.add('opacity-0','translate-y-[-20px]'),3000);
        }

        function closeModal(id) {
            const el = document.getElementById(id);
            if(id==='modalViewPhoto') { el.classList.add('opacity-0'); setTimeout(()=>el.classList.add('hidden'),300); }
            else el.classList.add('hidden');
        }

        function showAddIndustryModal() { document.getElementById('newIndustryName').value = ''; document.getElementById('modalAddIndustry').classList.remove('hidden'); }
        
        function downloadCurrentPhoto() {
            const p = state.photos.find(x=>x.id===state.currentPhotoId);
            saveAs(dataURLtoBlob(p.dataUrl), `Foto_${p.id}.jpg`);
        }
    </script>
</body>
</html>

