<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Gestor Industrial Pro</title>

    <!-- Depend√™ncias -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.9);
            --border: #e2e8f0;
            --primary: #2563eb;
        }

        .dark {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-glass: rgba(15, 23, 42, 0.95);
            --border: #334155;
            --primary: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .glass {
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
        }

        .bottom-nav {
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid var(--border);
        }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .cal-day {
            aspect-ratio: 1;
            display: flex; align-items: center; justify-content: center;
            border-radius: 14px; font-size: 0.875rem; font-weight: 600;
            transition: all 0.2s;
        }
        .cal-day.has-photos {
            background-color: var(--primary); color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .cal-day.empty { color: #94a3b8; }

        .photo-card {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-card);
        }
        .photo-card.selected {
            border-color: var(--primary);
            transform: scale(0.9);
            box-shadow: 0 0 0 2px var(--bg-body), 0 0 10px rgba(37, 99, 235, 0.4);
        }
        .photo-card.selected::before {
            content: "";
            position: absolute;
            inset: 0;
            background: rgba(37, 99, 235, 0.2);
            z-index: 10;
        }
        .photo-card.selected::after {
            content: "‚úì";
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--primary);
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 900;
            z-index: 20;
        }

        .btn-action { transition: all 0.2s; }
        .btn-action:active { transform: scale(0.95); }

        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .recent-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="fixed top-0 w-full h-16 glass z-50 flex items-center justify-between px-4">
        <div class="flex items-center gap-3">
            <button id="backBtn" onclick="window.history.back()" class="hidden w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center active:scale-90 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="dark:text-white"><path d="m15 18-6-6 6-6"/></svg>
            </button>
            <div class="overflow-hidden">
                <h1 id="headerTitle" class="font-extrabold text-base dark:text-white truncate">Gestor Industrial Pro</h1>
                <p id="headerSubtitle" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Painel de Controlo</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="selectAllBtn" onclick="app.selectAllInGallery()" class="hidden px-3 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-800 text-[10px] font-bold uppercase dark:text-white transition">Tudo</button>
            <button id="selectModeBtn" onclick="app.toggleSelectionMode()" class="hidden px-3 py-1.5 rounded-lg bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 text-[10px] font-black uppercase border border-blue-100 dark:border-blue-800 transition">
                Selecionar
            </button>
            <button id="settingsBtn" onclick="app.openModal('settings')" class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 transition shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
            <button onclick="app.toggleDarkMode()" class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 transition shadow-sm">
                <span id="themeIcon" class="text-lg">üåô</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto p-4 pt-20 pb-28">
        
        <!-- View: Home -->
        <section id="view-home" class="view-section active">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <div id="stat-industries" class="text-3xl font-black text-blue-600">0</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">Total de Locais</div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <div id="stat-photos" class="text-3xl font-black dark:text-white">0</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mt-1">Total de Fotos</div>
                </div>
            </div>

            <!-- √ÅREA SELECIONADA: CARD DE ATIVIDADE RECENTE -->
            <div class="bg-white dark:bg-slate-900 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-800 shadow-sm mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Registos Recentes</h3>
                    <button onclick="app.navigateTo('all')" class="text-[9px] font-bold text-blue-500 uppercase tracking-tighter">Ver Tudo</button>
                </div>
                <div id="recentActivityList" class="flex gap-2 overflow-x-auto recent-scroll pb-1">
                    <!-- Injetado via JS -->
                    <div class="w-20 h-20 rounded-2xl bg-slate-50 dark:bg-slate-800 animate-pulse"></div>
                    <div class="w-20 h-20 rounded-2xl bg-slate-50 dark:bg-slate-800 animate-pulse"></div>
                    <div class="w-20 h-20 rounded-2xl bg-slate-50 dark:bg-slate-800 animate-pulse"></div>
                </div>
            </div>

            <div id="alert-late" onclick="app.openLateAlerts()" class="hidden mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 rounded-2xl flex items-center gap-4 cursor-pointer active:scale-95 transition-all">
                <div class="w-11 h-11 bg-red-100 dark:bg-red-800 text-red-600 rounded-2xl flex items-center justify-center shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                </div>
                <div class="flex-1">
                    <p class="text-[11px] font-black text-red-800 dark:text-red-400 uppercase tracking-tight">Alerta de Visita</p>
                    <p id="alert-text" class="text-[11px] font-medium dark:text-red-300 opacity-80">0 locais em atraso (+7 dias).</p>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-red-300"><path d="m9 18 6-6-6-6"/></svg>
            </div>

            <div class="relative mb-6">
                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                </div>
                <input type="text" id="searchInput" oninput="app.filterIndustries()" placeholder="Pesquisar local ou empresa..." class="w-full pl-12 pr-4 py-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl text-sm font-medium outline-none shadow-sm focus:ring-2 ring-blue-500/10 transition-all dark:text-white">
            </div>

            <div id="industriesList" class="flex flex-col gap-2.5 pb-10">
                <!-- Lista de Ind√∫strias -->
            </div>
            
            <button onclick="app.saveNewIndustry()" class="fixed bottom-24 right-6 w-16 h-16 bg-blue-600 text-white rounded-full shadow-xl flex items-center justify-center active:scale-90 transition-all z-40 shadow-blue-500/30">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
            </button>
        </section>

        <!-- View: Dates (Calend√°rio) -->
        <section id="view-dates" class="view-section">
            <div class="flex items-center justify-between mb-6">
                <button onclick="window.history.back()" class="w-11 h-11 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 flex items-center justify-center active:scale-90 transition dark:text-white shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
                <h2 id="calendarMonth" class="font-extrabold text-base capitalize dark:text-white text-center">M√™s</h2>
                <button onclick="app.changeMonth(1)" class="w-11 h-11 rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 flex items-center justify-center active:scale-90 transition dark:text-white shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg></button>
            </div>
            
            <div id="calendarGrid" class="bg-white dark:bg-slate-900 p-5 rounded-[2rem] border border-slate-100 dark:border-slate-800 mb-8 shadow-sm">
                <!-- Grid injetada via JS -->
            </div>

            <div class="grid grid-cols-2 gap-4">
                <label class="bg-blue-600 text-white p-7 rounded-[2rem] flex flex-col items-center gap-2 cursor-pointer shadow-lg shadow-blue-500/30 active:scale-95 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                    <span class="text-[10px] font-black uppercase tracking-widest">C√¢mara</span>
                    <input type="file" capture="environment" accept="image/*" class="hidden" onchange="app.handleUpload(this)">
                </label>
                <label class="bg-slate-800 dark:bg-slate-700 text-white p-7 rounded-[2rem] flex flex-col items-center gap-2 cursor-pointer active:scale-95 transition shadow-lg shadow-slate-900/20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    <span class="text-[10px] font-black uppercase tracking-widest">Galeria</span>
                    <input type="file" accept="image/*" class="hidden" onchange="app.handleUpload(this)">
                </label>
            </div>
            
            <button onclick="app.editCurrentIndustry()" class="mt-12 w-full py-4 text-blue-500/40 text-[10px] font-black uppercase tracking-[0.2em] active:text-blue-500 transition-colors flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                Configurar Unidade
            </button>
        </section>

        <!-- View: Gallery (Grade de 5 colunas) -->
        <section id="view-gallery" class="view-section">
            <div id="galleryContainer" class="grid grid-cols-5 gap-1.5 mb-10"></div>
            <div class="grid grid-cols-2 gap-4 mt-8 pb-10">
                <label class="bg-blue-600 text-white p-6 rounded-[2rem] flex flex-col items-center gap-2 cursor-pointer shadow-lg active:scale-95 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                    <span class="text-[10px] font-black uppercase tracking-widest text-center">Tirar Foto</span>
                    <input type="file" capture="environment" accept="image/*" class="hidden" onchange="app.handleUpload(this)">
                </label>
                <label class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 p-6 rounded-[2rem] flex flex-col items-center gap-2 cursor-pointer active:scale-95 transition border border-slate-200 dark:border-slate-700 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    <span class="text-[10px] font-black uppercase tracking-widest text-center">Galeria</span>
                    <input type="file" accept="image/*" class="hidden" onchange="app.handleUpload(this)">
                </label>
            </div>
        </section>

        <!-- View: Global Gallery (Separado por datas) -->
        <section id="view-all" class="view-section">
            <div id="allPhotosContainer" class="pb-10"></div>
        </section>

        <!-- View: Reports -->
        <section id="view-reports" class="view-section text-center py-10">
            <div class="w-24 h-24 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </div>
            <h2 class="text-2xl font-black dark:text-white">Partilhar Registos</h2>
            <p class="text-sm text-slate-500 mt-2 mb-10 px-6">Envie relat√≥rios fotogr√°ficos profissionais via WhatsApp.</p>
            <div class="bg-white dark:bg-slate-900 p-6 rounded-[2rem] border border-slate-100 dark:border-slate-800 shadow-sm text-left mb-8">
                <label class="text-[10px] font-black text-slate-400 uppercase block mb-3 tracking-widest">Mensagem Padr√£o</label>
                <textarea id="shareMessage" class="w-full p-5 bg-slate-50 dark:bg-slate-800 rounded-2xl text-sm font-medium outline-none border-0 h-32 resize-none dark:text-white focus:ring-2 ring-blue-500/10 transition-all" placeholder="Texto de envio..."></textarea>
            </div>
            <button onclick="app.shareViaWhatsapp()" class="w-full py-5 bg-blue-600 text-white rounded-[1.5rem] font-black text-xs uppercase tracking-widest shadow-xl shadow-blue-500/30 active:scale-95 transition-all">PREPARAR WHATSAPP</button>
        </section>

    </main>

    <!-- Selection Bar -->
    <div id="selectionBar" class="fixed bottom-20 left-4 right-4 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border border-slate-200 dark:border-slate-800 p-4 rounded-3xl z-[60] flex items-center justify-between shadow-2xl transition-all duration-300 translate-y-[150%] opacity-0 pointer-events-none">
        <div class="flex flex-col">
            <span id="selectionCount" class="text-xs font-black dark:text-white uppercase tracking-tight">0 selecionadas</span>
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">A√ß√µes em lote</span>
        </div>
        <div class="flex gap-2">
            <button onclick="app.confirmDeleteSelected()" class="w-12 h-12 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-2xl flex items-center justify-center active:scale-90 transition shadow-sm border border-red-100 dark:border-red-900/40">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            </button>
            <button id="shareBtn" onclick="app.shareSelectedPhotos()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl text-[11px] font-black uppercase shadow-lg shadow-blue-500/30 active:scale-95 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                <span id="shareBtnText">Enviar Fotos</span>
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 h-16 bottom-nav z-50 flex justify-around items-center px-4 pb-safe shadow-[0_-10px_20px_rgba(0,0,0,0.03)]">
        <button onclick="app.navigateTo('home')" class="nav-item flex flex-col items-center gap-1 text-blue-600 group" data-tab="home">
            <div class="p-1 rounded-xl group-active:bg-blue-50 dark:group-active:bg-blue-900/20 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21v-9l11-4v5l7-2v10H3Z"/><path d="M9 21v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"/><path d="M14 8V4L3 9v3"/></svg>
            </div>
            <span class="text-[10px] font-black uppercase tracking-tighter">Locais</span>
        </button>
        <button onclick="app.navigateTo('all')" class="nav-item flex flex-col items-center gap-1 text-slate-400 group" data-tab="all">
            <div class="p-1 rounded-xl group-active:bg-slate-100 dark:group-active:bg-slate-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
            </div>
            <span class="text-[10px] font-black uppercase tracking-tighter">Galeria</span>
        </button>
        <button onclick="app.navigateTo('reports')" class="nav-item flex flex-col items-center gap-1 text-slate-400 group" data-tab="reports">
            <div class="p-1 rounded-xl group-active:bg-slate-100 dark:group-active:bg-slate-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
            </div>
            <span class="text-[10px] font-black uppercase tracking-tighter">Partilhar</span>
        </button>
    </nav>

    <!-- Modais -->
    <div id="modal-confirm" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden items-center justify-center p-6">
        <div class="bg-white dark:bg-slate-900 w-full max-w-xs rounded-3xl p-6 shadow-2xl text-center">
            <h3 class="text-lg font-black dark:text-white mb-2">Confirmar A√ß√£o</h3>
            <p id="confirmMsg" class="text-sm text-slate-500 dark:text-slate-400 mb-6 font-medium text-center">Tem a certeza?</p>
            <div class="flex gap-3">
                <button onclick="window.history.back()" class="flex-1 py-3.5 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-black text-[10px] uppercase rounded-2xl">Cancelar</button>
                <button id="confirmActionBtn" class="flex-1 py-3.5 bg-red-600 text-white font-black text-[10px] uppercase rounded-2xl shadow-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Gest√£o Unidade -->
    <div id="modal-addIndustry" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex flex-col justify-end p-0">
        <div class="bg-white dark:bg-slate-900 w-full rounded-t-[2.5rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-800 rounded-full mx-auto mb-6"></div>
            <h3 id="industryFormTitle" class="text-xl font-black mb-8 dark:text-white text-center">Configura√ß√£o de Unidade</h3>
            <div class="space-y-6 mb-8">
                <div class="relative w-full aspect-video rounded-3xl overflow-hidden bg-slate-100 dark:bg-slate-800 border-2 border-dashed border-slate-200 dark:border-slate-700 flex flex-col items-center justify-center">
                    <img id="coverPreview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                    <div id="coverPlaceholder" class="flex flex-col items-center gap-2 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                        <span class="text-[9px] font-black uppercase">Foto de Capa</span>
                    </div>
                    <input type="file" id="coverInput" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="app.handleCoverPreview(this)">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase block mb-3 tracking-widest text-center">Nome da Unidade</label>
                    <input type="text" id="newIndName" class="w-full p-5 bg-slate-50 dark:bg-slate-800 rounded-2xl font-bold outline-none dark:text-white border-2 border-transparent focus:border-blue-500 transition-all text-center shadow-inner">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase block mb-3 tracking-widest text-center">√çcone (Emoji)</label>
                    <input type="text" id="newIndIcon" class="w-full p-5 bg-slate-50 dark:bg-slate-800 rounded-2xl font-bold outline-none dark:text-white border-2 border-transparent focus:border-blue-500 transition-all text-center" placeholder="üè≠">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase block mb-3 tracking-widest text-center">Categoria</label>
                    <div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar pb-2" id="categoriesChips"></div>
                    <div class="flex gap-2">
                        <input type="text" id="newCatName" placeholder="Nova Categoria..." class="flex-1 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl text-xs font-bold outline-none dark:text-white border border-transparent focus:border-blue-500 shadow-inner">
                        <button onclick="app.addCategory()" class="bg-blue-600 text-white px-5 rounded-xl font-black text-xs uppercase shadow-lg">Add</button>
                    </div>
                </div>
            </div>
            <div class="flex flex-col gap-4">
                <div class="flex gap-4">
                    <button onclick="window.history.back()" class="flex-1 py-5 text-slate-400 font-black text-xs uppercase tracking-widest">Sair</button>
                    <button onclick="app.saveIndustry()" class="flex-[2] py-5 bg-blue-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl">Guardar Tudo</button>
                </div>
                <button id="deleteIndustryBtn" onclick="app.confirmDeleteIndustry()" class="hidden w-full py-4 text-red-500 bg-red-50 dark:bg-red-900/10 rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] border border-red-100 dark:border-red-900/20 active:bg-red-100">ELIMINAR ESTE LOCAL</button>
            </div>
        </div>
    </div>

    <!-- Modal Settings -->
    <div id="modal-settings" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex flex-col justify-end p-0">
        <div class="bg-white dark:bg-slate-900 w-full rounded-t-[2.5rem] p-8 shadow-2xl text-center">
            <h3 class="text-xl font-black mb-8 dark:text-white">Configura√ß√µes</h3>
            <textarea id="settingDefaultCaption" class="w-full p-5 bg-slate-50 dark:bg-slate-800 rounded-2xl font-medium text-sm outline-none dark:text-white h-28 resize-none mb-8 shadow-inner"></textarea>
            <div class="flex gap-4">
                <button onclick="window.history.back()" class="flex-1 py-5 text-slate-400 font-black text-xs uppercase">Fechar</button>
                <button onclick="app.saveSettings()" class="flex-1 py-5 bg-blue-600 text-white rounded-2xl font-black text-xs uppercase shadow-xl">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Photo Preview -->
    <div id="modal-photoPreview" class="fixed inset-0 bg-black/98 z-[110] hidden flex flex-col justify-center items-center p-0">
        <button onclick="window.history.back()" class="absolute top-12 left-6 text-white w-12 h-12 flex items-center justify-center bg-white/10 rounded-2xl backdrop-blur-md active:scale-90 transition shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg></button>
        <div class="w-full h-full flex items-center justify-center p-4">
            <img id="previewImg" src="" class="max-h-[70vh] w-auto max-w-full object-contain rounded-2xl shadow-2xl">
        </div>
        <div class="w-full p-6 pb-12 bg-black/40 backdrop-blur-2xl border-t border-white/10">
            <div class="max-w-md mx-auto">
                <textarea id="previewDescInput" class="w-full bg-white/5 rounded-2xl p-4 text-white text-sm font-medium outline-none resize-none h-20 mb-4 border border-white/10 shadow-inner" placeholder="Sem anota√ß√£o..."></textarea>
                <div class="flex gap-3">
                    <button onclick="app.savePhotoDesc()" class="flex-1 py-4 bg-blue-600 text-white font-black text-[10px] uppercase rounded-2xl shadow-lg shadow-blue-500/10">Guardar Nota</button>
                    <button onclick="app.confirmDeleteSingle()" class="w-16 h-14 bg-red-500/20 text-red-500 rounded-2xl flex items-center justify-center border border-red-500/30 active:scale-95 transition"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Alerts -->
    <div id="modal-lateAlerts" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex flex-col justify-end p-0">
        <div class="bg-white dark:bg-slate-900 w-full rounded-t-[2.5rem] p-8 h-[70vh] flex flex-col shadow-2xl text-center">
            <h3 class="text-xl font-black mb-6 text-red-600 uppercase tracking-tight">Locais em Atraso</h3>
            <div id="lateIndustriesList" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll text-left"></div>
            <button onclick="window.history.back()" class="mt-6 py-5 bg-slate-100 dark:bg-slate-800 rounded-2xl font-black text-[11px] dark:text-white uppercase tracking-widest active:bg-slate-200 transition-colors">Fechar</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 z-[130] transition-all duration-500 transform -translate-y-20 opacity-0 pointer-events-none">
        <div class="bg-slate-900 text-white px-7 py-4 rounded-full shadow-2xl flex items-center gap-3 border border-white/10">
            <div id="toastSpinner" class="hidden w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <span id="toastMsg" class="text-[11px] font-black uppercase tracking-wider"></span>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://hluxaxbjdpbezvffisns.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsdXhheGJqZHBiZXp2ZmZpc25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTg3NDgsImV4cCI6MjA4MDU5NDc0OH0.lia_McknZ7SD2EGlNchRVZ9d359bFkk7hSJXJYhJzig';
        const BUCKET = 'galeria';

        const app = {
            supabase: null, view: 'home', history: [], darkMode: false, industries: [], allPhotos: [], categories: [],
            currentIndustry: null, currentDateFolder: null, calendarCursor: new Date(),
            selectedPhoto: null, isSelectionMode: false, selectedPhotos: new Set(),
            defaultCaption: "Ol√°! Seguem os registos industriais:",
            selectedCategory: 'Geral', coverFile: null,

            init: async function() {
                window.history.replaceState({ viewId: 'home' }, "");
                if (typeof window.supabase !== 'undefined' && window.supabase) {
                    app.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                } else {
                    setTimeout(() => app.init(), 1000);
                    return;
                }
                const savedCaption = localStorage.getItem('industrial_default_caption');
                if (savedCaption) {
                    app.defaultCaption = savedCaption;
                    document.getElementById('settingDefaultCaption').value = savedCaption;
                }
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) app.toggleDarkMode();
                
                window.onpopstate = (event) => {
                    app.closeAllModals();
                    if (event.state && event.state.viewId) {
                        if (!['photo_preview', 'settings', 'addIndustry', 'lateAlerts', 'confirm'].includes(event.state.viewId)) {
                            app.renderInternalView(event.state.viewId, event.state.data, false);
                        }
                    }
                };
                await app.fetchData();
            },

            closeAllModals: function() {
                ['photoPreview', 'settings', 'addIndustry', 'lateAlerts', 'confirm'].forEach(m => {
                    const el = document.getElementById(`modal-${m}`);
                    if (el) { el.classList.add('hidden'); el.classList.remove('flex'); }
                });
            },

            formatToISO: (date) => {
                if (!date) return "";
                const d = new Date(date);
                if (isNaN(d.getTime())) return "";
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            },

            fetchData: async function() {
                if (!app.supabase) return;
                try {
                    const { data: indData, error: indError } = await app.supabase.from('industrias').select('*').order('nome');
                    if (indError) throw indError;
                    const { data: photoData, error: photoError } = await app.supabase.from('fotos').select('*').order('created_at', { ascending: false });
                    if (photoError) throw photoError;
                    const { data: catData } = await app.supabase.from('categorias').select('*').order('nome');

                    app.industries = indData || [];
                    app.allPhotos = photoData || [];
                    app.categories = catData || [];
                    
                    app.updateStats(); 
                    app.renderIndustries(); 
                    app.renderRecentActivity();
                    app.checkAlerts();
                } catch (e) { 
                    app.showToast("Erro de Sincroniza√ß√£o", "error"); 
                }
            },

            updateStats: function() {
                document.getElementById('stat-industries').innerText = app.industries.length;
                document.getElementById('stat-photos').innerText = app.allPhotos.length;
            },

            renderIndustries: function() {
                const list = document.getElementById('industriesList');
                const term = document.getElementById('searchInput').value.toLowerCase();
                list.innerHTML = '';
                app.industries.filter(i => i.nome.toLowerCase().includes(term)).forEach(ind => {
                    const item = document.createElement('div');
                    item.className = 'bg-white dark:bg-slate-900 rounded-[1.8rem] border border-slate-100 dark:border-slate-800 flex items-center p-3 active:scale-[0.98] transition shadow-sm';
                    item.innerHTML = `
                        <div class="w-14 h-14 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center overflow-hidden shrink-0 shadow-inner border border-slate-50 dark:border-slate-700">
                            ${ind.cover_url ? `<img src="${ind.cover_url}" class="w-full h-full object-cover">` : `<span class="text-2xl">${ind.icone || 'üè≠'}</span>`}
                        </div>
                        <div class="flex-1 ml-4 overflow-hidden" onclick="app.selectIndustry('${ind.id}')">
                            <h3 class="font-black text-sm dark:text-white truncate">${ind.nome}</h3>
                            <p class="text-[9px] text-slate-400 font-black uppercase tracking-widest">${ind.categoria || 'Geral'}</p>
                        </div>
                        <button onclick="app.editIndustry('${ind.id}')" class="p-3 text-slate-300 dark:text-slate-700 active:text-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                        </button>
                    `;
                    list.appendChild(item);
                });
            },

            renderRecentActivity: function() {
                const list = document.getElementById('recentActivityList');
                list.innerHTML = '';
                if (app.allPhotos.length === 0) {
                    list.innerHTML = '<p class="text-[9px] text-slate-400 uppercase italic py-4">Nenhuma atividade recente</p>';
                    return;
                }
                app.allPhotos.slice(0, 10).forEach(photo => {
                    const div = document.createElement('div');
                    div.className = 'w-20 h-20 rounded-2xl overflow-hidden shrink-0 active:scale-90 transition cursor-pointer shadow-sm';
                    div.innerHTML = `<img src="${photo.url_publica}" class="w-full h-full object-cover" loading="lazy">`;
                    div.onclick = () => app.openPhotoPreview(photo);
                    list.appendChild(div);
                });
            },

            selectIndustry: function(id) {
                const ind = app.industries.find(i => String(i.id) === String(id));
                if (ind) { app.currentIndustry = ind; app.navigateTo('dates'); }
            },

            checkAlerts: function() {
                const threshold = new Date(); threshold.setDate(threshold.getDate() - 7);
                const lastVisits = {};
                app.allPhotos.forEach(p => { if (!lastVisits[p.industria_id]) lastVisits[p.industria_id] = new Date(p.created_at); });
                const lateOnes = app.industries.filter(ind => !lastVisits[ind.id] || lastVisits[ind.id] < threshold);
                const alertEl = document.getElementById('alert-late');
                if (lateOnes.length > 0) {
                    alertEl.classList.remove('hidden');
                    document.getElementById('alert-text').innerText = `${lateOnes.length} em atraso.`;
                    const modalList = document.getElementById('lateIndustriesList');
                    modalList.innerHTML = '';
                    lateOnes.forEach(ind => {
                        const row = document.createElement('div');
                        row.className = 'p-4 bg-red-50 dark:bg-red-900/10 rounded-2xl border border-red-100 dark:border-red-900/30 flex justify-between items-center cursor-pointer active:scale-95 transition-transform';
                        row.onclick = () => { app.currentIndustry = ind; window.history.back(); setTimeout(() => app.navigateTo('dates'), 100); };
                        row.innerHTML = `<span class="font-black text-sm dark:text-red-400">${ind.nome}</span> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><path d="m9 18 6-6-6-6"/></svg>`;
                        modalList.appendChild(row);
                    });
                } else alertEl.classList.add('hidden');
            },

            editIndustry: function(id) {
                const ind = app.industries.find(i => String(i.id) === String(id));
                app.currentIndustry = ind;
                document.getElementById('industryFormTitle').innerText = "Editar Unidade";
                document.getElementById('newIndName').value = ind.nome;
                document.getElementById('newIndIcon').value = ind.icone || 'üè≠';
                app.selectedCategory = ind.categoria || 'Geral';
                const preview = document.getElementById('coverPreview');
                if (ind.cover_url) { preview.src = ind.cover_url; preview.classList.remove('hidden'); document.getElementById('coverPlaceholder').classList.add('hidden'); }
                else { preview.classList.add('hidden'); document.getElementById('coverPlaceholder').classList.remove('hidden'); }
                document.getElementById('deleteIndustryBtn').classList.remove('hidden');
                app.renderCategoriesChips();
                app.openModal('addIndustry');
            },

            saveNewIndustry: function() {
                app.currentIndustry = null;
                document.getElementById('industryFormTitle').innerText = "Novo Local Industrial";
                document.getElementById('newIndName').value = '';
                document.getElementById('newIndIcon').value = 'üè≠';
                app.selectedCategory = 'Geral';
                app.coverFile = null;
                document.getElementById('coverPreview').classList.add('hidden');
                document.getElementById('coverPlaceholder').classList.remove('hidden');
                document.getElementById('deleteIndustryBtn').classList.add('hidden');
                app.renderCategoriesChips();
                app.openModal('addIndustry');
            },

            editCurrentIndustry: function() { if (app.currentIndustry) app.editIndustry(app.currentIndustry.id); },

            handleCoverPreview: function(input) {
                const file = input.files[0]; if (!file) return;
                app.coverFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('coverPreview');
                    img.src = e.target.result; img.classList.remove('hidden');
                    document.getElementById('coverPlaceholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            },

            renderCategoriesChips: function() {
                const c = document.getElementById('categoriesChips');
                c.innerHTML = '';
                const cats = app.categories.length > 0 ? app.categories : [{nome: 'Geral'}];
                if (!cats.find(cat => cat.nome === app.selectedCategory)) cats.unshift({nome: app.selectedCategory});
                cats.forEach(cat => {
                    const div = document.createElement('div');
                    const isActive = cat.nome === app.selectedCategory;
                    div.className = `px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest cursor-pointer whitespace-nowrap border-2 transition ${isActive ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-slate-50 dark:bg-slate-800 text-slate-400 border-transparent'}`;
                    div.innerHTML = `<span onclick="app.setCategory('${cat.nome}')">${cat.nome}</span>`;
                    if (cat.id) {
                        const del = document.createElement('button');
                        del.innerHTML = '&times;'; del.className = 'ml-2 text-red-400 font-bold text-sm';
                        del.onclick = (e) => { e.stopPropagation(); app.deleteCategory(cat.id); };
                        div.appendChild(del);
                    }
                    c.appendChild(div);
                });
            },

            setCategory: function(name) { app.selectedCategory = name; app.renderCategoriesChips(); },
            addCategory: async function() {
                const name = document.getElementById('newCatName').value.trim();
                if (!name) return;
                await app.supabase.from('categorias').insert({ nome: name });
                document.getElementById('newCatName').value = '';
                await app.fetchData(); app.renderCategoriesChips();
            },
            deleteCategory: async function(id) { app.openConfirm("Apagar esta categoria?", async () => { await app.supabase.from('categorias').delete().eq('id', id); await app.fetchData(); app.renderCategoriesChips(); }); },

            saveIndustry: async function() {
                const name = document.getElementById('newIndName').value;
                const icon = document.getElementById('newIndIcon').value || 'üè≠';
                if (!name) return;
                app.showToast("A Guardar...", "loading");
                let coverUrl = app.currentIndustry?.cover_url || null;
                try {
                    if (app.coverFile) {
                        const fileName = `capas/${Date.now()}_${app.coverFile.name}`;
                        await app.supabase.storage.from(BUCKET).upload(fileName, app.coverFile);
                        const { data } = app.supabase.storage.from(BUCKET).getPublicUrl(fileName);
                        coverUrl = data.publicUrl;
                    }
                    const payload = { nome: name, categoria: app.selectedCategory, icone: icon, cover_url: coverUrl };
                    if (app.currentIndustry) await app.supabase.from('industrias').update(payload).eq('id', app.currentIndustry.id);
                    else await app.supabase.from('industrias').insert(payload);
                    window.history.back();
                    await app.fetchData();
                    app.showToast("Local Guardado", "success");
                } catch(e) { app.showToast("Erro ao guardar", "error"); }
            },

            confirmDeleteIndustry: function() { app.openConfirm(`Deseja eliminar ${app.currentIndustry.nome} e tudo o que lhe pertence?`, () => app.deleteIndustryDefinitive()); },
            deleteIndustryDefinitive: async function() { app.showToast("A eliminar...", "loading"); try { await app.supabase.from('industrias').delete().eq('id', app.currentIndustry.id); app.renderInternalView('home', null, false); await app.fetchData(); app.showToast("Removido", "success"); } catch(e) { app.showToast("Erro", "error"); } },

            navigateTo: function(v, d=null) { app.renderInternalView(v, d, true); },
            renderInternalView: function(v, d, s) {
                if (d) { if (d.currentIndustry) app.currentIndustry = d.currentIndustry; if (d.currentDateFolder) app.currentDateFolder = d.currentDateFolder; }
                if (s) window.history.pushState({ viewId: v, data: { currentIndustry: app.currentIndustry, currentDateFolder: app.currentDateFolder } }, "");
                document.querySelectorAll('.view-section').forEach(sec => sec.classList.remove('active'));
                const target = document.getElementById(`view-${v}`); if (target) target.classList.add('active');
                document.getElementById('headerSubtitle').innerText = { home: 'Monitoriza√ß√£o', dates: 'Calend√°rio', gallery: 'Registos', all: 'Arquivo', reports: 'Partilha' }[v] || 'Gestor';
                document.getElementById('headerTitle').innerText = (v==='dates'||v==='gallery') ? app.currentIndustry?.nome : 'Gestor Industrial Pro';
                document.getElementById('backBtn').classList.toggle('hidden', v === 'home');
                document.getElementById('selectModeBtn').classList.toggle('hidden', v !== 'gallery' && v !== 'all');
                document.getElementById('settingsBtn').classList.toggle('hidden', v !== 'home');
                app.cancelSelection();
                document.querySelectorAll('.nav-item').forEach(item => { item.classList.toggle('text-blue-600', item.dataset.tab === v); item.classList.toggle('text-slate-400', item.dataset.tab !== v); });
                if (v === 'all') app.renderGlobalGallery();
                if (v === 'dates') app.renderCalendar();
                if (v === 'gallery') app.renderGallery(app.currentDateFolder);
                app.view = v;
            },

            toggleSelectionMode: function() { app.isSelectionMode = !app.isSelectionMode; const btn = document.getElementById('selectModeBtn'); if (app.isSelectionMode) { btn.innerText = 'Cancelar'; btn.classList.add('bg-red-50', 'text-red-500'); document.getElementById('selectAllBtn').classList.remove('hidden'); app.updateSelectionBar(); } else { app.cancelSelection(); } if (app.view === 'gallery') app.renderGallery(app.currentDateFolder); else if (app.view === 'all') app.renderGlobalGallery(); },
            cancelSelection: function() { app.isSelectionMode = false; app.selectedPhotos.clear(); document.getElementById('selectionBar').classList.add('translate-y-[150%]', 'opacity-0', 'pointer-events-none'); const btn = document.getElementById('selectModeBtn'); if (btn) { btn.innerText = 'Selecionar'; btn.classList.remove('bg-red-50', 'text-red-500'); } document.getElementById('selectAllBtn').classList.add('hidden'); },
            updateSelectionBar: function() { const bar = document.getElementById('selectionBar'); const size = app.selectedPhotos.size; document.getElementById('selectionCount').innerText = `${size} selecionada${size!==1?'s':''}`; if (app.isSelectionMode) bar.classList.remove('translate-y-[150%]', 'opacity-0', 'pointer-events-none'); else bar.classList.add('translate-y-[150%]', 'opacity-0', 'pointer-events-none'); },
            handlePhotoClick: function(p) { if (app.isSelectionMode) { if (app.selectedPhotos.has(p.id)) app.selectedPhotos.delete(p.id); else app.selectedPhotos.add(p.id); app.updateSelectionBar(); if (app.view === 'gallery') app.renderGallery(app.currentDateFolder); else if (app.view === 'all') app.renderGlobalGallery(); } else app.openPhotoPreview(p); },
            selectAllInGallery: function() { const set = (app.view === 'gallery' ? app.allPhotos.filter(p => String(p.industria_id) === String(app.currentIndustry?.id) && app.formatToISO(p.created_at) === app.currentDateFolder) : app.allPhotos.slice(0, 50)); if (app.selectedPhotos.size === set.length) app.selectedPhotos.clear(); else set.forEach(p => app.selectedPhotos.add(p.id)); app.updateSelectionBar(); if (app.view === 'gallery') app.renderGallery(app.currentDateFolder); else if (app.view === 'all') app.renderGlobalGallery(); },
            shareSelectedPhotos: async function() {
                if (app.selectedPhotos.size === 0) return;
                const sel = app.allPhotos.filter(p => app.selectedPhotos.has(p.id));
                app.showToast("A processar...", "loading");
                try {
                    const files = [];
                    for (const p of sel) {
                        const res = await fetch(p.url_publica);
                        const blob = await res.blob();
                        files.push(new File([blob], `registo_${String(p.id).substring(0,5)}.jpg`, { type: 'image/jpeg' }));
                    }
                    if (navigator.share && navigator.canShare && navigator.canShare({ files })) { await navigator.share({ files, title: 'Registos', text: app.defaultCaption }); app.showToast("Sucesso", "success"); }
                    else throw new Error();
                } catch (e) {
                    app.showToast("A abrir links...", "success");
                    let links = `${app.defaultCaption}\n\n`; sel.forEach((p, i) => links += `${i+1}: ${p.url_publica}\n`);
                    window.open(`https://wa.me/?text=${encodeURIComponent(links)}`, '_blank');
                }
            },

            openConfirm: function(msg, on) { document.getElementById('confirmMsg').innerText = msg; document.getElementById('confirmActionBtn').onclick = () => { on(); }; app.openModal('confirm'); },
            confirmDeleteSingle: function() { app.openConfirm("Eliminar este registo?", () => app.deletePhoto()); },
            confirmDeleteSelected: function() { app.openConfirm(`Eliminar ${app.selectedPhotos.size} registos?`, () => app.deleteSelectedPhotos()); },
            deletePhoto: async function() { app.showToast("A eliminar...", "loading"); try { await app.supabase.from('fotos').delete().eq('id', app.selectedPhoto.id); window.history.back(); await app.fetchData(); if (app.view === 'gallery') app.renderGallery(app.currentDateFolder); else if (app.view === 'all') app.renderGlobalGallery(); } catch(e) { app.showToast("Erro", "error"); } },
            deleteSelectedPhotos: async function() { app.showToast("A eliminar lote...", "loading"); try { await app.supabase.from('fotos').delete().in('id', Array.from(app.selectedPhotos)); app.cancelSelection(); await app.fetchData(); if (app.view === 'gallery') app.renderGallery(app.currentDateFolder); else if (app.view === 'all') app.renderGlobalGallery(); } catch(e) { app.showToast("Erro", "error"); } },

            renderCalendar: function() {
                const grid = document.getElementById('calendarGrid');
                grid.innerHTML = '<div class="grid grid-cols-7 gap-2 text-center text-[10px] font-black text-slate-400 uppercase mb-4 tracking-tighter"><span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span></div>';
                const gridDays = document.createElement('div'); gridDays.className = 'grid grid-cols-7 gap-2';
                const y = app.calendarCursor.getFullYear(), m = app.calendarCursor.getMonth();
                document.getElementById('calendarMonth').innerText = new Intl.DateTimeFormat('pt-PT', { month: 'long', year: 'numeric' }).format(app.calendarCursor);
                const first = new Date(y, m, 1).getDay(), total = new Date(y, m + 1, 0).getDate();
                const dates = new Set(); app.allPhotos.filter(p => String(p.industria_id) === String(app.currentIndustry?.id)).forEach(p => dates.add(app.formatToISO(p.created_at)));
                for (let i=0; i<first; i++) gridDays.appendChild(document.createElement('div'));
                for (let d=1; d<=total; d++) {
                    const iso = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const btn = document.createElement('button');
                    btn.className = `cal-day ${dates.has(iso) ? 'has-photos' : 'empty dark:text-slate-600'} shadow-sm`;
                    btn.innerText = d;
                    if (dates.has(iso)) btn.onclick = () => { app.currentDateFolder = iso; app.navigateTo('gallery'); };
                    gridDays.appendChild(btn);
                }
                grid.appendChild(gridDays);
            },

            changeMonth: function(delta) { app.calendarCursor.setMonth(app.calendarCursor.getMonth() + delta); app.renderCalendar(); },
            renderGallery: function(iso) {
                const c = document.getElementById('galleryContainer'); c.innerHTML = '';
                const phs = app.allPhotos.filter(p => String(p.industria_id) === String(app.currentIndustry?.id) && app.formatToISO(p.created_at) === iso);
                phs.forEach(p => { const d = document.createElement('div'); d.className = `photo-card shadow-sm active:scale-95 transition cursor-pointer ${app.selectedPhotos.has(p.id) ? 'selected' : ''}`; d.innerHTML = `<img src="${p.url_publica}" class="w-full h-full object-cover" loading="lazy">`; d.onclick = () => app.handlePhotoClick(p); c.appendChild(d); });
                if (phs.length === 0) c.innerHTML = '<div class="col-span-5 py-10 text-center text-slate-400 font-bold text-[10px] uppercase opacity-50 tracking-widest">Sem fotos</div>';
            },

            renderGlobalGallery: function() {
                const c = document.getElementById('allPhotosContainer'); c.innerHTML = '';
                if (app.allPhotos.length === 0) { c.innerHTML = '<div class="py-20 text-center text-slate-300 font-bold text-xs uppercase opacity-50 tracking-widest">Arquivo Vazio</div>'; return; }
                const groups = {}; app.allPhotos.forEach(p => { const key = app.formatToISO(p.created_at); if (!groups[key]) groups[key] = []; groups[key].push(p); });
                Object.keys(groups).sort((a,b)=>b.localeCompare(a)).forEach(date => {
                    const h = document.createElement('div'); h.className = 'w-full mt-6 mb-3 px-1 border-b border-slate-100 dark:border-slate-800 pb-2'; const [y,m,d] = date.split('-'); h.innerHTML = `<span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${d}/${m}/${y}</span>`; c.appendChild(h);
                    const g = document.createElement('div'); g.className = 'grid grid-cols-5 gap-1.5 mb-6'; groups[date].forEach(p => { const d = document.createElement('div'); d.className = `photo-card shadow-sm cursor-pointer ${app.selectedPhotos.has(p.id) ? 'selected' : ''}`; d.innerHTML = `<img src="${p.url_publica}" class="w-full h-full object-cover" loading="lazy">`; d.onclick = () => app.handlePhotoClick(p); g.appendChild(d); }); c.appendChild(g);
                });
            },

            handleUpload: async function(input) {
                const file = input.files[0]; if (!file || !app.supabase || !app.currentIndustry) return;
                app.showToast("A Carregar Registo...", "loading");
                const now = new Date();
                const targetIso = (app.view === 'gallery' && app.currentDateFolder) ? app.currentDateFolder : app.formatToISO(now);
                const safeName = app.currentIndustry.nome.replace(/[^a-zA-Z0-9]/g, '_');
                const fileName = `${safeName}/${targetIso}/FOTO_${now.getTime()}.jpg`;
                try {
                    await app.supabase.storage.from(BUCKET).upload(fileName, file);
                    const { data: urlData } = app.supabase.storage.from(BUCKET).getPublicUrl(fileName);
                    let createdAt = now.toISOString();
                    if (app.view === 'gallery' && app.currentDateFolder) {
                        const [y, m, d] = app.currentDateFolder.split('-');
                        createdAt = new Date(Date.UTC(y, m - 1, d, 12, 0, 0)).toISOString();
                    }
                    const { data: newRecords, error: dbError } = await app.supabase.from('fotos').insert({ 
                        created_at: createdAt, 
                        nome_arquivo: fileName, 
                        url_publica: urlData.publicUrl, 
                        industria_id: app.currentIndustry.id, 
                        descricao: "" 
                    }).select();
                    if (dbError) throw dbError;
                    if (newRecords && newRecords[0]) app.allPhotos.unshift(newRecords[0]);
                    app.showToast("Registo Guardado", "success"); 
                    if (app.view === 'gallery') app.renderGallery(app.currentDateFolder); else app.renderCalendar();
                    app.renderRecentActivity();
                } catch (e) { app.showToast("Falha no Envio", "error"); }
            },

            openPhotoPreview: function(photo) { app.selectedPhoto = photo; document.getElementById('previewImg').src = photo.url_publica; document.getElementById('previewDescInput').value = photo.descricao || ''; window.history.pushState({ viewId: 'photo_preview', data: { currentIndustry: app.currentIndustry, currentDateFolder: app.currentDateFolder } }, ""); app.openModal('photoPreview'); },
            savePhotoDesc: async function() { const desc = document.getElementById('previewDescInput').value; app.showToast("A Guardar...", "loading"); try { await app.supabase.from('fotos').update({ descricao: desc }).eq('id', app.selectedPhoto.id); app.selectedPhoto.descricao = desc; app.showToast("Nota Guardada", "success"); } catch(e) { app.showToast("Erro", "error"); } },
            toggleDarkMode: function() { app.darkMode = !app.darkMode; document.documentElement.classList.toggle('dark', app.darkMode); document.getElementById('themeIcon').innerText = app.darkMode ? '‚òÄÔ∏è' : 'üåô'; },
            openModal: function(id) { const m = document.getElementById(`modal-${id}`); if(m) { m.classList.remove('hidden'); m.classList.add('flex'); if (!['photoPreview', 'confirm'].includes(id)) window.history.pushState({ viewId: id, data: { currentIndustry: app.currentIndustry } }, ""); } },
            closeModal: function(id) { const m = document.getElementById(`modal-${id}`); if(m) { m.classList.add('hidden'); m.classList.remove('flex'); } },
            showToast: function(msg, type = 'success') { const toast = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg; document.getElementById('toastSpinner').classList.toggle('hidden', type !== 'loading'); toast.classList.remove('-translate-y-20', 'opacity-0'); if (type !== 'loading') setTimeout(() => toast.classList.add('-translate-y-20', 'opacity-0'), 2500); },
            openLateAlerts: function() { app.openModal('lateAlerts'); },
            shareViaWhatsapp: function() { window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('shareMessage').value || app.defaultCaption)}`, '_blank'); }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
