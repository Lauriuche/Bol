<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA / APK Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4300/4300058.png">

    <title>Gestor Industrial Pro</title>

    <!-- Depend√™ncias -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #ffffff;
            --text-main: #000000;
            --border-color: #000000;
            --card-bg: #ffffff;
            --primary: #2563eb;
            --safe-top: env(safe-area-inset-top, 24px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        .dark {
            --bg-body: #121212;
            --text-main: #ffffff;
            --border-color: #ffffff;
            --primary: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- PADR√ÉO VISUAL UNIFICADO --- */

        /* Borda padr√£o */
        .sketch-border {
            border: 2px solid var(--border-color);
        }

        /* Header */
        header {
            padding-top: calc(var(--safe-top) + 10px);
            padding-bottom: 10px;
            text-align: center;
            background: var(--bg-body);
            z-index: 50;
            flex-shrink: 0;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Main */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 24px; /* Espa√ßamento mais generoso */
            padding-bottom: 120px;
            display: flex;
            flex-direction: column;
            gap: 24px; /* Ritmo vertical consistente */
        }

        /* Footer */
        .bottom-bar {
            height: calc(70px + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            padding-left: 30px;
            padding-right: 30px;
            background: var(--bg-body);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 2px solid var(--border-color);
            z-index: 100;
            flex-shrink: 0;
        }

        /* ELEMENTOS UI PADRONIZADOS */
        
        /* Cart√µes de Estat√≠sticas - Redondos e Centralizados */
        .stats-card {
            @apply sketch-border rounded-3xl bg-transparent flex flex-col items-center justify-center text-center;
            aspect-ratio: 1.3/1;
        }

        /* Container Gen√©rico */
        .recents-container {
            @apply sketch-border rounded-3xl p-5 w-full bg-transparent flex flex-col justify-center;
        }

        /* Barra de Pesquisa */
        .search-bar {
            @apply sketch-border rounded-full w-full py-4 px-6 flex items-center justify-center gap-3 bg-transparent;
        }

        /* Grelha de Ind√∫strias */
        .industry-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .industry-card {
            @apply sketch-border rounded-3xl bg-transparent flex flex-col items-center justify-center relative overflow-hidden transition-transform;
            aspect-ratio: 1/1;
        }
        .industry-card:active { transform: scale(0.95); }
        .industry-card img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 20px;
        }

        /* FAB (+) */
        .fab-btn {
            position: absolute;
            bottom: calc(90px + var(--safe-bottom));
            right: 24px;
            width: 64px; height: 64px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%; /* Sempre Circular */
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            z-index: 90;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        .fab-btn:active { transform: translateY(4px); box-shadow: none; }

        /* Scroller Horizontal */
        .h-scroll {
            display: flex; gap: 12px; overflow-x: auto; padding: 4px 0; scrollbar-width: none;
            justify-content: flex-start; /* Alinhamento inicial */
            align-items: center;
        }
        .h-scroll::-webkit-scrollbar { display: none; }
        
        .circle-thumb {
            @apply sketch-border rounded-full flex-shrink-0 bg-gray-50 dark:bg-zinc-800 overflow-hidden flex items-center justify-center;
            width: 58px; height: 58px;
        }

        /* Links Footer */
        .nav-link {
            font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-main); opacity: 0.4; padding: 10px 5px; text-align: center;
        }
        .nav-link.active { opacity: 1; color: var(--primary); }

        /* Modais */
        .modal-overlay { z-index: 200; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; align-items: flex-end; justify-content: center; }
        .modal-content { @apply sketch-border bg-white dark:bg-zinc-900 rounded-t-[40px] w-full p-8 text-center; border-bottom: none; }
        .sketch-input { @apply sketch-border rounded-2xl p-4 w-full bg-transparent outline-none font-bold text-center; }
        
        .view-section { display: none; width: 100%; height: 100%; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { z-index: 300; }
        
        /* Calend√°rio */
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 16px; font-weight: 700; font-size: 14px; }
        .cal-day.has-photos { background: var(--primary); color: white; }
    </style>
</head>
<body>

    <!-- CABE√áALHO -->
    <header>
        <div class="w-full flex justify-center items-center relative px-4">
            <!-- Bot√£o Voltar -->
            <button id="backBtn" onclick="window.history.back()" class="hidden absolute left-0 w-10 h-10 sketch-border rounded-full flex items-center justify-center bg-transparent z-50 hover:bg-gray-100 dark:hover:bg-zinc-800 transition">
                <i class="fas fa-chevron-left text-sm"></i>
            </button>
            
            <div class="flex flex-col items-center">
                <h1 id="headerTitle" class="text-xl font-black uppercase tracking-tight leading-none">Gestor promoter</h1>
                <p id="headerSubtitle" class="text-[10px] font-bold opacity-60 mt-1">Merchandising - Mateus</p>
            </div>
            
            <!-- Bot√£o Selecionar -->
             <button id="selectModeBtn" onclick="app.toggleSelectionMode()" class="hidden absolute right-0 text-[10px] font-black uppercase bg-transparent border-b-2 border-current pb-0.5">Selecionar</button>
        </div>
    </header>

    <!-- √ÅREA PRINCIPAL -->
    <main>
        
        <!-- VIEW: HOME -->
        <section id="view-home" class="view-section active">
            
            <!-- Stats -->
            <div class="grid grid-cols-2 gap-4">
                <div class="stats-card">
                    <span id="stat-industries" class="text-5xl font-black tracking-tighter">00</span>
                    <span class="text-[10px] font-bold uppercase mt-1 opacity-60 tracking-widest">Locais</span>
                </div>
                <div class="stats-card">
                    <span id="stat-photos" class="text-5xl font-black tracking-tighter">00</span>
                    <span class="text-[10px] font-bold uppercase mt-1 opacity-60 tracking-widest">Fotos</span>
                </div>
            </div>

            <!-- Fotos Recentes -->
            <div class="recents-container">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-black">Fotos recentes</h3>
                    <button onclick="app.navigateTo('all')" class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Ver +</button>
                </div>
                <div id="recentActivityList" class="h-scroll">
                    <!-- Circles injected via JS -->
                </div>
            </div>

            <!-- Pesquisa -->
            <div class="search-bar">
                <i class="fas fa-search text-gray-400"></i>
                <input type="text" id="searchInput" oninput="app.filterIndustries()" placeholder="Pesquisar..." class="bg-transparent w-full outline-none text-sm font-bold placeholder-gray-400 text-center">
            </div>

            <!-- Grelha de Locais (3 Colunas) -->
            <div id="industriesList" class="industry-grid">
                <!-- Squares injected via JS -->
            </div>
        </section>

        <!-- VIEW: DATES (Calend√°rio) -->
        <section id="view-dates" class="view-section">
            <button class="w-full py-5 bg-blue-600 text-white font-black text-sm uppercase rounded-full shadow-md mb-6 sketch-border border-black flex items-center justify-center gap-2" id="industryNameBanner" onclick="app.editCurrentIndustry()">
                Nome da Ind√∫stria
            </button>

            <div class="recents-container mb-6 bg-gray-50 dark:bg-zinc-800 border-none">
                <div class="flex justify-between items-center mb-4 px-4">
                    <button onclick="app.changeMonth(-1)" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendarMonth" class="text-xl font-black capitalize">M√™s</h2>
                    <button onclick="app.changeMonth(1)" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-zinc-700 transition"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendarGrid" class="pb-2"></div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-auto">
                <label class="stats-card bg-blue-600 text-white border-blue-900 cursor-pointer active:scale-95 transition">
                    <i class="fas fa-camera text-3xl mb-2"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">C√ÇMARA</span>
                    <input type="file" capture="environment" accept="image/*" class="hidden" onchange="app.handleUpload(this)">
                </label>
                <label class="stats-card bg-zinc-800 text-white border-black cursor-pointer active:scale-95 transition">
                    <i class="fas fa-images text-3xl mb-2"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">GALERIA</span>
                    <input type="file" accept="image/*" class="hidden" onchange="app.handleUpload(this)">
                </label>
            </div>
            
            <p onclick="app.editCurrentIndustry()" class="text-center text-[10px] font-bold text-blue-600 uppercase mt-8 cursor-pointer opacity-80 border-b border-blue-600 inline-block mx-auto w-fit pb-1">CONFIGURAR</p>
        </section>

        <!-- VIEW: GALLERY -->
        <section id="view-gallery" class="view-section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">Galeria</h2>
            </div>
            <div id="galleryContainer" class="industry-grid"></div>
        </section>

        <!-- VIEW: ALL FILES -->
        <section id="view-all" class="view-section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">Arquivo</h2>
            </div>
            <div id="allPhotosContainer"></div>
        </section>

        <!-- VIEW: REPORTS -->
        <section id="view-reports" class="view-section text-center">
            <h2 class="text-2xl font-black mb-8 mt-4">Partilhar</h2>
            <div class="recents-container mb-6 text-left h-48 flex flex-col">
                <label class="text-[10px] font-bold uppercase opacity-50 block mb-2 text-center w-full">Mensagem</label>
                <textarea id="shareMessage" class="w-full h-full bg-transparent outline-none font-bold resize-none text-sm p-2 text-center leading-relaxed" placeholder="Escreva a mensagem..."></textarea>
            </div>
            <button onclick="app.shareViaWhatsapp()" class="w-full py-5 bg-blue-600 text-white rounded-full font-black uppercase text-sm shadow-lg active:scale-95 transition border-2 border-black tracking-widest">Enviar WhatsApp</button>
        </section>

    </main>

    <!-- FAB -->
    <button onclick="app.saveNewIndustry()" class="fab-btn" id="fabAdd">
        <i class="fas fa-plus"></i>
    </button>

    <!-- BARRA DE SELE√á√ÉO -->
    <div id="selectionBar" class="fixed bottom-24 left-4 right-4 bg-black text-white p-4 rounded-full flex items-center justify-between shadow-2xl transition-all duration-300 translate-y-[200%] z-[95] sketch-border border-white dark:border-black">
        <span id="selectionCount" class="text-xs font-bold ml-2">0</span>
        <div class="flex gap-3">
            <button onclick="app.confirmDeleteSelected()" class="text-red-500 w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 transition"><i class="fas fa-trash"></i></button>
            <button onclick="app.shareSelectedPhotos()" class="bg-blue-600 text-white px-6 py-2 rounded-full text-[10px] font-black uppercase">Enviar</button>
        </div>
    </div>

    <!-- RODAP√â -->
    <nav class="bottom-bar">
        <div class="flex gap-8">
            <div onclick="app.navigateTo('home')" class="nav-link active" data-tab="home">Local</div>
            <div onclick="app.navigateTo('all')" class="nav-link" data-tab="all">Arquivos</div>
            <div onclick="app.navigateTo('reports')" class="nav-link" data-tab="reports">Partilhar</div>
        </div>
        <div class="flex gap-5 text-xl opacity-80">
            <button onclick="app.openModal('settings')"><i class="fas fa-cog"></i></button>
            <button onclick="app.toggleDarkMode()"><i class="fas fa-adjust" id="themeIcon"></i></button>
        </div>
    </nav>

    <!-- MODAIS -->
    
    <!-- Add/Edit Industry -->
    <div id="modal-addIndustry" class="modal-overlay fixed inset-0 hidden flex-col justify-end p-0">
        <div class="modal-content max-h-[85vh] overflow-y-auto">
            <div class="w-16 h-1.5 bg-gray-300 rounded-full mx-auto mb-8"></div>
            <h3 id="industryFormTitle" class="text-2xl font-black mb-8 text-center uppercase tracking-tight">Unidade</h3>
            <div class="space-y-6 mb-8 w-full">
                <input type="text" id="newIndName" class="sketch-input" placeholder="Nome da Empresa">
                <input type="text" id="newIndIcon" class="sketch-input" placeholder="√çcone (Emoji) üè≠">
                
                <div class="relative w-full aspect-video sketch-border rounded-3xl overflow-hidden flex flex-col items-center justify-center bg-gray-50 dark:bg-zinc-800">
                    <img id="coverPreview" src="" class="absolute inset-0 w-full h-full object-cover hidden">
                    <div id="coverPlaceholder" class="flex flex-col items-center gap-2 opacity-40">
                        <i class="fas fa-camera text-3xl"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">Capa</span>
                    </div>
                    <input type="file" id="coverInput" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="app.handleCoverPreview(this)">
                </div>
            </div>
            <div class="flex gap-4 w-full">
                <button onclick="window.history.back()" class="flex-1 py-4 font-black text-xs uppercase opacity-60">Sair</button>
                <button onclick="app.saveIndustry()" class="flex-[2] py-4 bg-black text-white dark:bg-white dark:text-black rounded-2xl font-black text-xs uppercase shadow-lg">Guardar</button>
            </div>
            <button id="deleteIndustryBtn" onclick="app.confirmDeleteIndustry()" class="hidden w-full mt-8 py-3 text-red-500 text-[10px] font-black uppercase border-t-2 border-current">ELIMINAR</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="modal-confirm" class="modal-overlay fixed inset-0 hidden items-center justify-center p-6"><div class="sketch-border bg-white dark:bg-zinc-900 w-full max-w-xs rounded-[30px] p-8 text-center"><h3 class="text-xl font-black mb-2 uppercase">Confirmar?</h3><div class="flex gap-3 mt-8"><button onclick="window.history.back()" class="flex-1 py-4 bg-gray-100 dark:bg-zinc-800 text-xs font-black uppercase rounded-2xl sketch-border">N√£o</button><button id="confirmActionBtn" class="flex-1 py-4 bg-black text-white dark:bg-white dark:text-black text-xs font-black uppercase rounded-2xl border-2 border-black dark:border-white">Sim</button></div></div></div>

    <!-- Photo Preview -->
    <div id="modal-photoPreview" class="modal-overlay fixed inset-0 hidden flex-col justify-center items-center p-0 bg-black"><button onclick="window.history.back()" class="absolute top-10 left-6 text-white w-12 h-12 flex items-center justify-center bg-white/20 rounded-full backdrop-blur-md z-50"><i class="fas fa-arrow-left"></i></button><div class="flex-1 w-full flex items-center justify-center p-2"><img id="previewImg" src="" class="max-h-full max-w-full object-contain rounded-lg"></div><div class="w-full p-8 bg-white dark:bg-zinc-900 rounded-t-[40px]"><textarea id="previewDescInput" class="sketch-input h-20 resize-none mb-6" placeholder="Adicionar nota..."></textarea><div class="flex gap-4"><button onclick="app.savePhotoDesc()" class="flex-1 py-4 bg-black text-white dark:bg-white dark:text-black rounded-2xl font-black text-xs uppercase">Salvar</button><button onclick="app.confirmDeleteSingle()" class="w-20 sketch-border rounded-2xl flex items-center justify-center text-red-500"><i class="fas fa-trash"></i></button></div></div></div>

    <!-- Settings -->
    <div id="modal-settings" class="modal-overlay fixed inset-0 hidden flex-col justify-end p-0"><div class="modal-content"><h3 class="text-xl font-black mb-8 text-center uppercase tracking-tight">Configura√ß√µes</h3><div class="mb-8 w-full"><label class="text-[10px] font-black uppercase mb-3 block text-center opacity-60 tracking-widest">Legenda Padr√£o</label><textarea id="settingDefaultCaption" class="sketch-input h-32 resize-none"></textarea></div><div class="flex gap-4 w-full"><button onclick="window.history.back()" class="flex-1 py-4 font-black text-xs uppercase opacity-60">Fechar</button><button onclick="app.saveSettings()" class="flex-1 py-4 bg-black text-white dark:bg-white dark:text-black rounded-2xl font-black text-xs uppercase">Salvar</button></div></div></div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 z-[300] transition-all duration-300 transform -translate-y-24 opacity-0 pointer-events-none"><div class="bg-black text-white px-8 py-4 rounded-full shadow-xl flex items-center gap-4 text-xs font-black border-2 border-white uppercase tracking-widest"><span id="toastMsg"></span></div></div>

    <script>
        const SUPABASE_URL = 'https://hluxaxbjdpbezvffisns.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsdXhheGJqZHBiZXp2ZmZpc25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTg3NDgsImV4cCI6MjA4MDU5NDc0OH0.lia_McknZ7SD2EGlNchRVZ9d359bFkk7hSJXJYhJzig';
        const BUCKET = 'galeria';

        const app = {
            supabase: null, view: 'home', darkMode: false, industries: [], allPhotos: [],
            currentIndustry: null, currentDateFolder: null, calendarCursor: new Date(),
            selectedPhoto: null, isSelectionMode: false, selectedPhotos: new Set(),
            defaultCaption: "Registos:", coverFile: null,

            init: async function() {
                window.history.replaceState({ viewId: 'home' }, "");
                if (typeof window.supabase !== 'undefined') app.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                else { setTimeout(() => app.init(), 1000); return; }
                const savedCaption = localStorage.getItem('industrial_default_caption');
                if (savedCaption) app.defaultCaption = savedCaption;
                document.getElementById('settingDefaultCaption').value = app.defaultCaption;
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) app.toggleDarkMode();
                window.onpopstate = (e) => { app.closeAllModals(); if (e.state?.viewId && !['photo_preview', 'settings', 'addIndustry', 'lateAlerts', 'confirm'].includes(e.state.viewId)) app.renderInternalView(e.state.viewId, e.state.data, false); };
                await app.fetchData();
            },

            closeAllModals: function() { ['photoPreview', 'settings', 'addIndustry', 'lateAlerts', 'confirm'].forEach(m => { const el = document.getElementById(`modal-${m}`); if(el) { el.classList.remove('flex'); el.classList.add('hidden'); } }); },
            formatToISO: (d) => { const x = new Date(d); if(isNaN(x)) return ""; return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`; },
            showToast: function(msg) { const t=document.getElementById('toast'); document.getElementById('toastMsg').innerText=msg; t.classList.remove('-translate-y-24','opacity-0'); setTimeout(()=>t.classList.add('-translate-y-24','opacity-0'), 2500); },
            
            fetchData: async function() {
                if(!app.supabase) return;
                try {
                    const [ind, pho] = await Promise.all([app.supabase.from('industrias').select('*').order('nome'), app.supabase.from('fotos').select('*').order('created_at', {ascending: false})]);
                    app.industries = ind.data || []; app.allPhotos = pho.data || [];
                    app.updateStats(); app.renderIndustries(); app.renderRecentActivity();
                } catch(e) { app.showToast("Erro de rede"); }
            },
            
            updateStats: function() { document.getElementById('stat-industries').innerText = app.industries.length; document.getElementById('stat-photos').innerText = app.allPhotos.length; },
            
            renderIndustries: function() {
                const list = document.getElementById('industriesList');
                const term = document.getElementById('searchInput').value.toLowerCase();
                list.innerHTML = '';
                app.industries.filter(i => i.nome.toLowerCase().includes(term)).forEach(ind => {
                    const d = document.createElement('div');
                    d.className = 'industry-card cursor-pointer';
                    d.onclick = () => { app.currentIndustry = ind; app.navigateTo('dates'); };
                    d.innerHTML = `
                        ${ind.cover_url ? `<img src="${ind.cover_url}">` : `<span class="text-3xl">${ind.icone || 'üè≠'}</span>`}
                        <button onclick="event.stopPropagation(); app.editIndustry('${ind.id}')" class="absolute top-1 right-1 w-7 h-7 bg-white/30 backdrop-blur-md rounded-full flex items-center justify-center text-black sketch-border border-black"><i class="fas fa-pencil text-[10px]"></i></button>
                    `;
                    list.appendChild(d);
                });
            },

            renderRecentActivity: function() {
                const list = document.getElementById('recentActivityList'); list.innerHTML = '';
                app.allPhotos.slice(0, 10).forEach(photo => {
                    const d = document.createElement('div'); d.className = 'circle-thumb cursor-pointer';
                    d.innerHTML = `<img src="${photo.url_publica}" class="w-full h-full object-cover">`;
                    d.onclick = () => app.openPhotoPreview(photo);
                    list.appendChild(d);
                });
            },

            navigateTo: function(v, d=null) { app.renderInternalView(v, d, true); },
            renderInternalView: function(v, d, s) {
                if(d) { if(d.currentIndustry) app.currentIndustry=d.currentIndustry; if(d.currentDateFolder) app.currentDateFolder=d.currentDateFolder; }
                if(s) window.history.pushState({ viewId: v, data: { currentIndustry: app.currentIndustry, currentDateFolder: app.currentDateFolder } }, "");
                document.querySelectorAll('.view-section').forEach(sec => sec.classList.remove('active'));
                document.getElementById(`view-${v}`).classList.add('active');
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const navItem = document.querySelector(`.nav-link[data-tab="${v}"]`);
                if(navItem) navItem.classList.add('active');

                document.getElementById('backBtn').classList.toggle('hidden', v === 'home');
                const title = document.getElementById('headerTitle');
                if (v === 'home') { title.innerText = 'Gestor promoter'; document.getElementById('headerSubtitle').innerText = 'Merchandising - Mateus'; }
                else if (v === 'dates') { 
                    title.innerText = 'Unidade'; 
                    document.getElementById('headerSubtitle').innerText = 'Painel';
                    document.getElementById('industryNameBanner').innerText = app.currentIndustry.nome;
                }
                else { title.innerText = 'Gestor Pro'; document.getElementById('headerSubtitle').innerText = 'Painel'; }

                const fab = document.getElementById('fabAdd');
                const selBar = document.getElementById('selectionBar');
                const selBtn = document.getElementById('selectModeBtn');
                
                if(v === 'home') { fab.classList.remove('hidden'); selBar.classList.add('translate-y-[200%]'); selBtn.classList.add('hidden'); }
                else if (v === 'gallery' || v === 'all') { fab.classList.add('hidden'); selBtn.classList.remove('hidden'); }
                else { fab.classList.add('hidden'); selBar.classList.add('translate-y-[200%]'); selBtn.classList.add('hidden'); }

                if(v === 'dates') app.renderCalendar();
                if(v === 'gallery') app.renderGallery(app.currentDateFolder);
                if(v === 'all') app.renderGlobalGallery();
                app.view = v;
            },

            toggleSelectionMode: function() { app.isSelectionMode = !app.isSelectionMode; const bar = document.getElementById('selectionBar'); const btn = document.getElementById('selectModeBtn'); if (app.isSelectionMode) { bar.classList.remove('translate-y-[200%]'); btn.innerText="Cancelar"; } else { app.selectedPhotos.clear(); bar.classList.add('translate-y-[200%]'); btn.innerText="Selecionar"; } app.updateSelectionCount(); if (app.view === 'gallery') app.renderGallery(app.currentDateFolder); if (app.view === 'all') app.renderGlobalGallery(); },
            updateSelectionCount: function() { document.getElementById('selectionCount').innerText = `${app.selectedPhotos.size} selecionadas`; },
            handlePhotoClick: function(p) { if (app.isSelectionMode) { if (app.selectedPhotos.has(p.id)) app.selectedPhotos.delete(p.id); else app.selectedPhotos.add(p.id); app.updateSelectionCount(); if (app.view === 'gallery') app.renderGallery(app.currentDateFolder); if (app.view === 'all') app.renderGlobalGallery(); } else app.openPhotoPreview(p); },
            selectAllInGallery: function() { const set = (app.view === 'gallery' ? app.allPhotos.filter(p => String(p.industria_id) === String(app.currentIndustry?.id) && app.formatToISO(p.created_at) === app.currentDateFolder) : app.allPhotos.slice(0, 50)); if (app.selectedPhotos.size === set.length) app.selectedPhotos.clear(); else set.forEach(p => app.selectedPhotos.add(p.id)); app.updateSelectionCount(); if (app.view === 'gallery') app.renderGallery(app.currentDateFolder); else if (app.view === 'all') app.renderGlobalGallery(); },
            
            saveNewIndustry: function() { app.currentIndustry = null; document.getElementById('industryFormTitle').innerText="Nova Unidade"; document.getElementById('newIndName').value=""; document.getElementById('deleteIndustryBtn').classList.add('hidden'); app.openModal('addIndustry'); },
            editIndustry: function(id) { const ind = app.industries.find(i=>String(i.id)===String(id)); app.currentIndustry = ind; document.getElementById('industryFormTitle').innerText="Editar Unidade"; document.getElementById('newIndName').value=ind.nome; document.getElementById('deleteIndustryBtn').classList.remove('hidden'); app.openModal('addIndustry'); },
            editCurrentIndustry: function() { app.editIndustry(app.currentIndustry.id); },
            saveIndustry: async function() { const name = document.getElementById('newIndName').value; if(!name) return; const payload = { nome: name, icone: 'üè≠' }; 
                if(app.coverFile) { 
                    const fileName = `capas/${Date.now()}_cover.jpg`;
                    await app.supabase.storage.from(BUCKET).upload(fileName, app.coverFile);
                    const { data } = app.supabase.storage.from(BUCKET).getPublicUrl(fileName);
                    payload.cover_url = data.publicUrl;
                }
                if(app.currentIndustry) await app.supabase.from('industrias').update(payload).eq('id', app.currentIndustry.id); else await app.supabase.from('industrias').insert(payload); window.history.back(); await app.fetchData(); 
            },
            confirmDeleteIndustry: function() { app.openModal('confirm'); document.getElementById('confirmActionBtn').onclick = async () => { await app.supabase.from('industrias').delete().eq('id', app.currentIndustry.id); window.history.go(-2); await app.fetchData(); }; },
            
            renderCalendar: function() {
                const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
                const y = app.calendarCursor.getFullYear(), m = app.calendarCursor.getMonth();
                document.getElementById('calendarMonth').innerText = new Intl.DateTimeFormat('pt-PT', { month: 'long', year: 'numeric' }).format(app.calendarCursor);
                const first = new Date(y, m, 1).getDay(), total = new Date(y, m + 1, 0).getDate();
                ['D','S','T','Q','Q','S','S'].forEach(d => grid.innerHTML += `<div class="text-center text-xs font-bold opacity-50 py-2">${d}</div>`);
                for(let i=0; i<first; i++) grid.innerHTML += `<div></div>`;
                const dates = new Set(); app.allPhotos.filter(p => String(p.industria_id) === String(app.currentIndustry?.id)).forEach(p => dates.add(app.formatToISO(p.created_at)));
                for(let d=1; d<=total; d++) {
                    const iso = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const has = dates.has(iso);
                    const btn = document.createElement('button');
                    btn.className = `aspect-square flex items-center justify-center rounded-xl text-sm font-bold ${has ? 'bg-blue-600 text-white' : 'sketch-border'}`;
                    btn.innerText = d;
                    if(has) btn.onclick = () => { app.currentDateFolder = iso; app.navigateTo('gallery'); };
                    grid.appendChild(btn);
                }
                grid.className = "grid grid-cols-7 gap-2";
            },
            changeMonth: function(d) { app.calendarCursor.setMonth(app.calendarCursor.getMonth() + d); app.renderCalendar(); },
            
            renderGallery: function(iso) {
                const c = document.getElementById('galleryContainer'); c.innerHTML = '';
                const photos = app.allPhotos.filter(p => String(p.industria_id) === String(app.currentIndustry?.id) && app.formatToISO(p.created_at) === iso);
                photos.forEach(p => {
                    const d = document.createElement('div');
                    d.className = `photo-card ${app.selectedPhotos.has(p.id) ? 'selected' : ''}`;
                    d.innerHTML = `<img src="${p.url_publica}" class="w-full h-full object-cover">`;
                    d.onclick = () => app.handlePhotoClick(p);
                    c.appendChild(d);
                });
            },
            
            renderGlobalGallery: function() {
                 const c = document.getElementById('allPhotosContainer'); c.innerHTML = '';
                 app.allPhotos.slice(0,50).forEach(p => {
                    const d = document.createElement('div');
                    d.className = `photo-card ${app.selectedPhotos.has(p.id) ? 'selected' : ''}`;
                    d.innerHTML = `<img src="${p.url_publica}" class="w-full h-full object-cover">`;
                    d.onclick = () => app.handlePhotoClick(p);
                    c.appendChild(d);
                 });
                 c.className = "industry-grid"; // Reusing 3-column grid
            },

            handleUpload: async function(input) {
                const file = input.files[0]; if (!file) return;
                app.showToast("Enviando...");
                const now = new Date();
                const targetDateISO = (app.view === 'gallery' && app.currentDateFolder) ? app.currentDateFolder : app.formatToISO(now);
                const safeName = app.currentIndustry.nome.replace(/[^a-zA-Z0-9]/g, '_');
                const fileName = `${safeName}/${targetDateISO}/FOTO_${now.getTime()}.jpg`;
                try {
                    await app.supabase.storage.from(BUCKET).upload(fileName, file);
                    const { data: urlData } = app.supabase.storage.from(BUCKET).getPublicUrl(fileName);
                    let createdAt = now.toISOString();
                    if (app.view === 'gallery' && app.currentDateFolder) {
                        const [y, m, d] = app.currentDateFolder.split('-');
                        createdAt = new Date(Date.UTC(y, m - 1, d, 12, 0, 0)).toISOString();
                    }
                    await app.supabase.from('fotos').insert({ created_at: createdAt, nome_arquivo: fileName, url_publica: urlData.publicUrl, industria_id: app.currentIndustry.id, descricao: "" });
                    app.showToast("Guardado!"); await app.fetchData();
                    if(app.view === 'gallery') app.renderGallery(app.currentDateFolder); else app.renderCalendar();
                    app.renderRecentActivity();
                } catch(e) { app.showToast("Erro"); }
            },

            handleCoverPreview: function(input) { const file = input.files[0]; if (!file) return; app.coverFile = file; const reader = new FileReader(); reader.onload = (e) => { const img = document.getElementById('coverPreview'); img.src = e.target.result; img.classList.remove('hidden'); document.getElementById('coverPlaceholder').classList.add('hidden'); }; reader.readAsDataURL(file); },
            openPhotoPreview: function(p) { 
                app.selectedPhoto = p; 
                document.getElementById('previewImg').src = p.url_publica; 
                app.openModal('photoPreview'); 
            },
            
            openModal: function(id) { 
                const m = document.getElementById(`modal-${id}`);
                m.classList.remove('hidden'); m.classList.add('flex'); 
                window.history.pushState({ viewId: id }, ""); 
            },
            
            toggleDarkMode: function() { document.documentElement.classList.toggle('dark'); },
            shareViaWhatsapp: function() { window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('shareMessage').value)}`, '_blank'); },
            // Helpers
            checkAlerts: function() {},
            openLateAlerts: function() { app.openModal('lateAlerts'); },
            confirmDeleteSelected: function() { app.openModal('confirm'); },
            shareSelectedPhotos: function() { app.shareViaWhatsapp(); },
            saveSettings: function() { app.defaultCaption = document.getElementById('settingDefaultCaption').value; localStorage.setItem('industrial_default_caption', app.defaultCaption); app.showToast("Salvo!"); window.history.back(); },
            savePhotoDesc: function() { window.history.back(); app.showToast("Salvo"); },
            confirmDeleteSingle: function() { window.history.back(); }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>


