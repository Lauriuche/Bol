<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <title>Industrial Manager Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Cores estendidas para usar com Tailwind se necessário
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* =========================================
           1. VARIÁVEIS & RESET (O Segredo do Dark Mode Leve)
        ========================================== */
        :root {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.90);
            --border-color: #e2e8f0;
            --text-main: #334155;
            --text-muted: #94a3b8;
            --primary: #3b82f6;
            --primary-light: #eff6ff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        html.dark :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-glass: rgba(30, 41, 59, 0.90);
            --border-color: #334155;
            --text-main: #e2e8f0;
            --text-muted: #64748b;
            --primary: #60a5fa;
            --primary-light: rgba(59, 130, 246, 0.15);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.3);
        }

        * { -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            padding-bottom: calc(100px + env(safe-area-inset-bottom)); 
            transition: background-color 0.3s ease, color 0.3s ease;
            user-select: none;
        }

        /* =========================================
           2. COMPONENTES DE UI (Reutilizáveis)
        ========================================== */
        
        /* Glass Header Otimizado */
        .glass-header { 
            background: var(--bg-glass); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px); 
            border-bottom: 1px solid var(--border-color); 
            transition: all 0.3s ease;
        }

        /* Cards Gerais */
        .card-base {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
        }

        /* Indústria Card (Otimizado para Grid) */
        .ind-card { 
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 8px; 
            height: 140px; /* Altura fixa para alinhar grid */
            justify-content: space-between; 
            box-shadow: var(--shadow-sm); 
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.2s;
            overflow: hidden;
        }
        .ind-card:active { transform: scale(0.96); border-color: var(--primary); }
        
        .ind-card .cover-wrapper { 
            width: 100%; 
            height: 70px; 
            border-radius: 12px; 
            overflow: hidden; 
            background: var(--bg-body); 
            position: relative;
        }
        .ind-card .cover-img { width: 100%; height: 100%; object-fit: cover; }

        /* Abas de Dias (Cronograma) */
        .day-tab { 
            font-weight: 800; font-size: 10px; color: var(--text-muted); background: var(--bg-body); 
            padding: 12px 0; width: 100%; border-radius: 8px 8px 0 0; 
            text-transform: uppercase; transition: all 0.2s; border-bottom: 2px solid transparent; 
            display: flex; justify-content: center; align-items: center; letter-spacing: 0.5px;
        }
        .day-tab.active { 
            background: var(--bg-card); 
            color: var(--primary); 
            box-shadow: 0 -4px 10px rgba(0,0,0,0.03); 
            position: relative; z-index: 10; 
        }
        .day-tab.active::after { 
            content: ''; position: absolute; top: 0; left: 20%; right: 20%; height: 3px; 
            background: var(--primary); border-radius: 0 0 4px 4px; 
        }

        /* Lista de Rotas */
        .route-row {
            display: flex; align-items: center; justify-content: space-between; padding: 16px;
            border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.1s;
        }
        .route-row:active { background-color: var(--primary-light); }
        .route-row:last-child { border-bottom: none; }

        /* Barras Fixas (Bottom Bar & Nav) */
        .fixed-bottom-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; width: 100%; 
            background: var(--bg-glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color); 
            z-index: 60; padding-bottom: calc(20px + env(safe-area-inset-bottom)); 
            padding-top: 16px; padding-left: 16px; padding-right: 16px; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .fixed-bottom-bar.hidden-bar { transform: translateY(120%); }

        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            height: calc(60px + env(safe-area-inset-bottom)); 
            padding-bottom: env(safe-area-inset-bottom); 
            background: var(--bg-card); 
            border-top: 1px solid var(--border-color); 
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 50; transition: transform 0.3s;
        }
        .bottom-nav.hidden-nav { transform: translateY(100%); }
        
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 10px; font-weight: 600; width: 100%; height: 100%;
            transition: color 0.2s;
        }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: transform 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-2px); }

        /* =========================================
           3. CALENDÁRIO OTIMIZADO
        ========================================== */
        .cal-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; 
        }
        .cal-day-btn { 
            aspect-ratio: 1/1; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 14px; font-weight: 600; color: var(--text-muted); 
            background: transparent; border: 1px solid transparent; 
            position: relative; transition: all 0.2s; 
        }
        .cal-day-btn.active-day { 
            background: var(--primary-light); 
            color: var(--primary); 
            border-color: var(--primary); 
            font-weight: 800;
        }
        .cal-day-btn.today { border: 1px solid var(--primary); }
        .cal-day-btn .dot { 
            width: 5px; height: 5px; background: var(--primary); 
            border-radius: 50%; margin-top: 4px; 
        }

        /* =========================================
           4. FORMULÁRIOS & INPUTS
        ========================================== */
        .input-std {
            width: 100%; background-color: var(--bg-body); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 12px; font-size: 14px; color: var(--text-main); outline: none;
            transition: border-color 0.2s;
        }
        .input-std:focus { border-color: var(--primary); }

        .time-input { 
            background: var(--bg-body); border: 1px solid var(--border-color); 
            border-radius: 8px; padding: 4px; font-size: 12px; width: 75px; 
            text-align: center; font-weight: bold; color: var(--text-main);
        }

        /* Badges de Status/Hora */
        .hour-badge { font-size: 9px; padding: 3px 8px; border-radius: 6px; font-weight: 700; margin-top: 2px; display: inline-block; letter-spacing: 0.3px; }
        .hour-ok { background: rgba(34, 197, 94, 0.15); color: #15803d; } /* Verde suave */
        .hour-warn { background: rgba(234, 179, 8, 0.15); color: #a16207; } /* Amarelo suave */
        .hour-err { background: rgba(239, 68, 68, 0.15); color: #b91c1c; } /* Vermelho suave */
        
        html.dark .hour-ok { color: #4ade80; }
        html.dark .hour-warn { color: #facc15; }
        html.dark .hour-err { color: #f87171; }

        /* Categorias Badge */
        .cat-badge { font-size: 9px; font-weight: 800; text-transform: uppercase; padding: 2px 8px; border-radius: 4px; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.5px; }

        /* =========================================
           5. UTILITÁRIOS & ANIMAÇÕES
        ========================================== */
        .loader { border: 3px solid var(--border-color); border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .view-section { display: none; opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .view-section.active { display: block; opacity: 1; transform: translateY(0); }
        
        .photo-item { position: relative; overflow: hidden; border-radius: 12px; background: var(--border-color); aspect-ratio: 1/1; }
        .photo-item.selected { border: 4px solid var(--primary); }
        .photo-item.selected img { opacity: 0.6; }
        .photo-item.selected::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-200">

    <header class="fixed top-0 w-full z-50 glass-header h-16 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center gap-3 w-2/3">
            <button id="backBtn" onclick="goBack()" class="hidden w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-200 hover:bg-slate-200 flex items-center justify-center active:scale-90 transition"><i class="fas fa-arrow-left"></i></button>
            <div class="overflow-hidden">
                <h1 id="pageTitle" class="font-bold text-base text-slate-800 dark:text-white truncate tracking-tight">Cronograma</h1>
                <p id="pageSubtitle" class="text-[11px] text-slate-500 dark:text-slate-400 flex items-center gap-1.5 truncate">Visão Semanal</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-yellow-400 flex items-center justify-center active:scale-90 border border-slate-200 dark:border-slate-600 transition"><i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i></button>
            
            <button id="selectBtn" onclick="toggleSelectionMode()" class="hidden text-xs font-bold bg-slate-100 dark:bg-slate-700 text-blue-600 dark:text-blue-400 px-4 py-2 rounded-full border border-slate-200 dark:border-slate-600 active:scale-95 transition">Selecionar</button>
            <button id="editIndBtn" onclick="openEditIndustryModal()" class="hidden w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-blue-600 flex items-center justify-center active:scale-95 border border-slate-200 dark:border-slate-600 transition"><i class="fas fa-pencil-alt text-sm"></i></button>
            <button id="configRouteBtn" onclick="openRouteConfig()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-blue-600 flex items-center justify-center active:scale-90 border border-slate-200 dark:border-slate-600 transition"><i class="fas fa-cog text-sm"></i></button>
            <button onclick="refreshCurrentView()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-blue-600 flex items-center justify-center active:scale-90 border border-slate-200 dark:border-slate-600 transition"><i class="fas fa-sync-alt text-sm"></i></button>
            <button id="installBtn" class="hidden bg-blue-600 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-md shadow-blue-200 flex items-center gap-1 animate-pulse"><i class="fas fa-download"></i></button>
        </div>
    </header>

    <div class="h-20"></div>

    <main class="max-w-md mx-auto px-4 pb-32">

        <div id="view-home" class="view-section active">
            <div id="homeDashboard" class="grid grid-cols-2 gap-3 mb-5">
                <div class="p-4 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-lg shadow-blue-200 dark:shadow-none flex flex-col justify-center">
                    <div class="text-2xl font-extrabold leading-none mb-1" id="dashTotalInd">0</div>
                    <div class="text-[10px] uppercase font-bold opacity-80"><i class="fas fa-industry mr-1"></i> Cadastrados</div>
                </div>
                <div class="p-4 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 text-white shadow-lg shadow-purple-200 dark:shadow-none flex flex-col justify-center">
                    <div class="text-2xl font-extrabold leading-none mb-1" id="dashWorkLoad">00:00h</div>
                    <div class="text-[10px] uppercase font-bold opacity-80"><i class="fas fa-clock mr-1"></i> Carga Hoje</div>
                </div>
            </div>

            <div class="mb-4 px-1 text-xs font-bold text-slate-400 uppercase tracking-widest text-center">Agenda Semanal</div>
            <div class="grid grid-cols-7 gap-1 mb-0 px-1 pb-1" id="routeTabsContainer"></div>
            
            <div class="card-base rounded-t-none border-t-0 min-h-[300px]">
                <div id="routeListContent" class="flex flex-col">
                    <div class="p-6 text-center text-slate-400 text-sm">Carregando...</div>
                </div>
            </div>
            
            <button onclick="openAllPhotos()" class="mt-4 w-full bg-white dark:bg-card border border-slate-200 dark:border-slate-700 py-4 rounded-xl font-bold text-slate-600 dark:text-slate-300 text-xs uppercase shadow-sm active:scale-95 transition">
                <i class="fas fa-images mr-2"></i> Feed de Fotos
            </button>
        </div>

        <div id="view-routes" class="view-section">
            <div class="search-container mb-4 sticky top-20 z-30">
                <div class="relative">
                    <i class="fas fa-search search-icon absolute left-3 top-3 text-slate-400"></i>
                    <input type="text" id="searchInput" onkeyup="filterIndustries()" placeholder="Buscar local..." class="input-std pl-10">
                </div>
            </div>
            
            <div class="mb-2 flex justify-between items-end px-1">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Todos os Locais</span>
                <span id="indCount" class="text-[10px] bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded font-mono font-bold">0</span>
            </div>
            
            <div id="industriesList" class="grid grid-cols-3 gap-3"></div>
            
            <button onclick="openAddModal()" class="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 rounded-full text-white shadow-xl flex items-center justify-center text-2xl active:scale-90 transition z-40 transform hover:-translate-y-1">
                <i class="fas fa-plus"></i>
            </button>
            
            <div id="industryActions" class="fixed-bottom-bar flex gap-3 hidden-bar">
                <button onclick="deleteSelectedIndustries()" class="w-14 h-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center border border-red-100 active:scale-90"><i class="fas fa-trash-alt text-lg"></i></button>
                <button onclick="openBulkCategoryModal()" class="flex-1 bg-blue-600 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95">Mudar Categoria</button>
            </div>
        </div>

        <div id="view-dates" class="view-section">
            <div class="flex justify-between items-center mb-4 px-1">
                <button onclick="changeCalendarMonth(-1)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center"><i class="fas fa-chevron-left text-xs"></i></button>
                <span id="calendarTitle" class="text-sm font-bold uppercase">...</span>
                <button onclick="changeCalendarMonth(1)" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center"><i class="fas fa-chevron-right text-xs"></i></button>
            </div>
            
            <div class="card-base p-4">
                <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                    <div class="text-[10px] font-bold text-red-400">D</div>
                    <div class="text-[10px] font-bold text-slate-400">S</div>
                    <div class="text-[10px] font-bold text-slate-400">T</div>
                    <div class="text-[10px] font-bold text-slate-400">Q</div>
                    <div class="text-[10px] font-bold text-slate-400">Q</div>
                    <div class="text-[10px] font-bold text-slate-400">S</div>
                    <div class="text-[10px] font-bold text-slate-400">S</div>
                </div>
                <div id="calendarGrid" class="cal-grid"></div>
            </div>
            
            <div class="mt-4 grid grid-cols-2 gap-3">
                <label class="bg-blue-600 text-white py-4 rounded-xl flex flex-col items-center justify-center active:scale-95 transition shadow-lg cursor-pointer">
                    <i class="fas fa-camera text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase">Câmera</span>
                    <input type="file" accept="image/*" capture="environment" class="hidden" onchange="uploadPhoto(this)">
                </label>
                <label class="bg-purple-600 text-white py-4 rounded-xl flex flex-col items-center justify-center active:scale-95 transition shadow-lg cursor-pointer">
                    <i class="fas fa-images text-2xl mb-1"></i><span class="text-[10px] font-bold uppercase">Galeria</span>
                    <input type="file" accept="image/*" class="hidden" onchange="uploadPhoto(this)">
                </label>
            </div>
        </div>

        <div id="view-gallery" class="view-section">
            <button onclick="generatePDF()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-xs mb-4 flex items-center justify-center gap-2 shadow-lg active:scale-95">
                <i class="fas fa-file-pdf text-red-400"></i> GERAR RELATÓRIO PDF
            </button>
            <div id="photosContainer" class="grid grid-cols-3 gap-1 pb-48 select-none"></div>
            
            <div id="selectionControls" class="fixed-bottom-bar flex gap-3 hidden-bar">
                <button onclick="selectAllPhotos()" class="bg-blue-600 text-white font-bold rounded-xl px-4 py-3 active:scale-95">Todas</button>
                <button onclick="deleteSelected()" class="w-14 h-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center border border-red-100 active:scale-90"><i class="fas fa-trash-alt text-lg"></i></button>
                <button onclick="shareSelected()" class="flex-1 bg-green-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 active:scale-95">Compartilhar (<span id="selCount">0</span>)</button>
            </div>
        </div>

        <div id="view-all" class="view-section">
            <div id="allPhotosContainer" class="grid grid-cols-3 gap-1 pb-48 select-none"></div>
            <div id="selectionControlsAll" class="fixed-bottom-bar flex gap-3 hidden-bar">
                <button onclick="selectAllPhotos()" class="bg-blue-600 text-white font-bold rounded-xl px-4 py-3 active:scale-95">Todas</button>
                <button onclick="deleteSelected()" class="w-14 h-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center border border-red-100 active:scale-90"><i class="fas fa-trash-alt text-lg"></i></button>
                <button onclick="shareSelected()" class="flex-1 bg-green-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 active:scale-95">Compartilhar (<span id="selCountAll">0</span>)</button>
            </div>
        </div>
    </main>

    <nav id="mainNavBar" class="bottom-nav">
        <div id="nav-general" class="nav-item active" onclick="switchMainTab('general')">
            <i class="fas fa-calendar-alt"></i><span>Geral</span>
        </div>
        <div id="nav-routes" class="nav-item" onclick="switchMainTab('routes')">
            <i class="fas fa-th-large"></i><span>Locais</span>
        </div>
    </nav>

    <div id="routeConfigModal" class="fixed inset-0 bg-black/50 z-[80] hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm">
        <div class="card-base w-full max-w-sm p-6 shadow-2xl h-[85vh] flex flex-col">
            <h3 class="text-sm font-bold text-slate-700 dark:text-white mb-2 uppercase">Planejamento Semanal</h3>
            
            <div class="grid grid-cols-7 gap-1 mb-3">
                <button onclick="selectRouteConfigDay('Domingo')" class="day-cfg-btn bg-red-50 dark:bg-red-900/30 px-0 py-2 rounded text-[9px] text-red-500 font-bold border border-red-100 dark:border-red-900 flex justify-center">DOM</button>
                <button onclick="selectRouteConfigDay('Segunda')" class="day-cfg-btn bg-slate-100 dark:bg-slate-700 px-0 py-2 rounded text-[9px] text-slate-500 font-bold border border-slate-200 dark:border-slate-600 flex justify-center">SEG</button>
                <button onclick="selectRouteConfigDay('Terça')" class="day-cfg-btn bg-slate-100 dark:bg-slate-700 px-0 py-2 rounded text-[9px] text-slate-500 font-bold border border-slate-200 dark:border-slate-600 flex justify-center">TER</button>
                <button onclick="selectRouteConfigDay('Quarta')" class="day-cfg-btn bg-slate-100 dark:bg-slate-700 px-0 py-2 rounded text-[9px] text-slate-500 font-bold border border-slate-200 dark:border-slate-600 flex justify-center">QUA</button>
                <button onclick="selectRouteConfigDay('Quinta')" class="day-cfg-btn bg-slate-100 dark:bg-slate-700 px-0 py-2 rounded text-[9px] text-slate-500 font-bold border border-slate-200 dark:border-slate-600 flex justify-center">QUI</button>
                <button onclick="selectRouteConfigDay('Sexta')" class="day-cfg-btn bg-slate-100 dark:bg-slate-700 px-0 py-2 rounded text-[9px] text-slate-500 font-bold border border-slate-200 dark:border-slate-600 flex justify-center">SEX</button>
                <button onclick="selectRouteConfigDay('Sábado')" class="day-cfg-btn bg-slate-100 dark:bg-slate-700 px-0 py-2 rounded text-[9px] text-slate-500 font-bold border border-slate-200 dark:border-slate-600 flex justify-center">SÁB</button>
            </div>

            <div class="text-xs text-slate-400 mb-2 flex justify-between">
                <span>Agendar para: <span id="currentConfigDay" class="text-blue-600 font-bold">...</span></span>
            </div>

            <div id="routeChecklist" class="flex-1 overflow-y-auto space-y-2 mb-4 bg-slate-50 dark:bg-slate-900 p-2 rounded-lg border border-slate-100 dark:border-slate-700"></div>

            <div class="flex gap-3 mt-auto">
                <button onclick="document.getElementById('routeConfigModal').classList.add('hidden')" class="flex-1 py-3 text-slate-400 text-xs font-medium hover:text-slate-600">Fechar</button>
                <button onclick="saveRouteConfig()" class="flex-1 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg">SALVAR</button>
            </div>
        </div>
    </div>

    <div id="addModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="card-base w-full max-w-xs p-6 shadow-2xl">
            <h3 id="modalTitle" class="text-sm font-bold text-slate-700 dark:text-white mb-4 uppercase">Nova Indústria</h3>
            <input type="hidden" id="editIndId">
            <input type="text" id="newIndName" placeholder="Nome (ex: Fabrica X)" class="input-std mb-3">
            
            <div class="mb-3">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Carga Horária Semanal (Horas)</label>
                <input type="number" id="newIndHours" placeholder="Ex: 7" class="input-std">
            </div>

            <div class="flex gap-2 mb-4">
                <div class="relative w-full">
                    <select id="catSelect" class="input-std appearance-none"><option value="">Sem Categoria</option></select>
                    <i class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 text-xs"></i>
                </div>
                <button onclick="document.getElementById('newCatContainer').classList.toggle('hidden')" class="w-12 bg-blue-50 dark:bg-slate-700 text-blue-600 rounded-xl border border-blue-200 dark:border-slate-600 flex items-center justify-center"><i class="fas fa-plus"></i></button>
            </div>
            <div id="newCatContainer" class="hidden mb-4 flex gap-2"><input type="text" id="newCatName" placeholder="Nova Categoria..." class="input-std text-xs"><button onclick="addNewCategory()" class="bg-green-500 text-white px-3 rounded-lg text-xs font-bold">OK</button></div>

            <div class="mb-4">
                <label class="block mb-1 font-semibold text-sm text-slate-700 dark:text-slate-300">Foto de Capa</label>
                <div class="flex items-center gap-3">
                    <img id="coverPreview" src="" alt="Capa" class="w-20 h-20 object-cover rounded-lg bg-slate-200 border border-slate-300 hidden">
                    <div id="coverPlaceholder" class="w-20 h-20 bg-slate-100 dark:bg-slate-700 rounded-lg border border-slate-300 dark:border-slate-600 flex items-center justify-center text-slate-300"><i class="fas fa-image text-xl"></i></div>
                    <label for="coverInput" class="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs active:scale-95 transition shadow">Selecionar</label>
                </div>
                <input type="file" id="coverInput" accept="image/*" class="hidden" onchange="handleCoverChange(event)">
            </div>

            <button id="btnDeleteInd" onclick="deleteCurrentIndustry()" class="w-full bg-red-50 dark:bg-red-900/30 text-red-500 py-3 rounded-xl font-bold text-xs mb-3 border border-red-100 dark:border-red-900 hidden flex items-center justify-center gap-2 active:scale-95 transition">
                <i class="fas fa-trash-alt"></i> EXCLUIR INDÚSTRIA
            </button>

            <div class="flex gap-3"><button onclick="closeAddModal()" class="flex-1 py-3 text-slate-400 text-xs font-medium hover:text-slate-600">Cancelar</button><button onclick="saveIndustry()" class="flex-1 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg">SALVAR</button></div>
        </div>
    </div>

    <div id="bulkCatModal" class="fixed inset-0 bg-black/50 z-[90] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="card-base w-full max-w-xs p-6 shadow-2xl">
            <h3 class="text-sm font-bold text-slate-700 dark:text-white mb-4 uppercase">Mudar Categoria</h3>
            <p class="text-xs text-slate-500 mb-2">Aplicar para <span id="bulkCountDisplay" class="font-bold">0</span> indústrias:</p>
            <div class="relative w-full mb-4">
                <select id="bulkCatSelect" class="input-std appearance-none"><option value="">Sem Categoria</option></select>
            </div>
            <div class="flex gap-3"><button onclick="document.getElementById('bulkCatModal').classList.add('hidden')" class="flex-1 py-3 text-slate-400 text-xs font-medium hover:text-slate-600">Cancelar</button><button onclick="saveBulkCategory()" class="flex-1 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg">APLICAR</button></div>
        </div>
    </div>

    <div id="photoModal" class="fixed inset-0 bg-black z-[70] hidden flex flex-col justify-center items-center opacity-0 transition-opacity duration-300">
        <div class="absolute top-0 w-full p-4 flex justify-end z-20">
            <button onclick="closePhotoModal()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white backdrop-blur-md active:scale-90"><i class="fas fa-times text-xl"></i></button>
        </div>
        <img id="previewImg" src="" class="max-h-[80vh] max-w-full object-contain mb-4 rounded shadow-2xl">
        <div class="absolute bottom-8 flex gap-4 w-full max-w-xs justify-center px-4">
            <button onclick="deleteSinglePhoto()" class="w-14 h-14 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-trash-alt text-lg"></i></button>
        </div>
    </div>

    <div id="statusToast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-white border border-slate-200 text-slate-700 px-5 py-2.5 rounded-full shadow-xl text-xs font-bold flex items-center gap-2 transition-all opacity-0 -translate-y-10 z-[100]">
        <div id="toastIcon" class="loader w-3 h-3 border-slate-200 border-t-blue-500"></div>
        <span id="toastMsg">Processando...</span>
    </div>

    <script>
        const SUPABASE_URL = 'https://hluxaxbjdpbezvffisns.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsdXhheGJqZHBiZXp2ZmZpc25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTg3NDgsImV4cCI6MjA4MDU5NDc0OH0.lia_McknZ7SD2EGlNchRVZ9d359bFkk7hSJXJYhJzig';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const BUCKET = 'galeria';

        let currentIndustry = null;
        let currentDateFolder = null;
        let industryPhotos = [];
        let allIndustries = [];
        let categories = [];
        let isSelectionMode = false;
        let selectedPhotos = new Set();
        let selectedIndustries = new Set();
        let currentModalPhoto = null;
        let coverImageFile = null;
        let calendarCursor = new Date();
        let availableDates = new Set();
        
        let routes = { 'Domingo': [], 'Segunda': [], 'Terça': [], 'Quarta': [], 'Quinta': [], 'Sexta': [], 'Sábado': [] };
        const weekDays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
        let configSelectedDay = null;
        let viewSelectedDay = null;
        let viewHistory = [];
        
        const categoryColorsClass = ['bg-blue text-blue-700 bg-blue-100', 'bg-green text-green-700 bg-green-100', 'bg-purple text-purple-700 bg-purple-100', 'bg-orange text-orange-700 bg-orange-100', 'bg-pink text-pink-700 bg-pink-100', 'bg-teal text-teal-700 bg-teal-100'];

        // --- INICIALIZAÇÃO ---
        window.onload = async () => {
            viewHistory = [];
            if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

            try {
                // PRIMEIRO PASSO: Recuperar indústrias "zumbis"
                await syncStorageWithDB();
                
                await Promise.all([loadIndustries(), fetchRoutesFromDB(), loadCategories()]);
                updateDashboard();
                
                const hash = window.location.hash.substring(1);
                if (hash && document.getElementById(hash)) {
                    if (hash === 'view-dates' && !currentIndustry) navigateTo('view-home', false);
                    else navigateTo(hash, false);
                } else {
                    const today = weekDays[new Date().getDay()];
                    viewSelectedDay = today;
                    selectRouteViewDay(today);
                }
            } catch (e) {
                console.error("Erro Load:", e);
                showToast("Erro ao iniciar", "error");
            }
        };

        // --- FUNÇÃO CRÍTICA DE RECUPERAÇÃO ---
        async function syncStorageWithDB() {
            try {
                const { data: stData } = await sb.storage.from(BUCKET).list('', { limit: 1000 });
                if (!stData) return;

                const stFolders = stData.filter(i => i.name !== '.keep').map(i => i.name);
                
                const { data: dbData } = await sb.from('industrias').select('nome');
                const dbNames = dbData ? dbData.map(i => i.nome) : [];
                
                const missing = stFolders.filter(n => !dbNames.includes(n));
                
                if (missing.length > 0) {
                    await sb.from('industrias').insert(missing.map(n => ({ nome: n, carga_semanal: 0 })));
                }
            } catch (e) { console.error("Sync Error:", e); }
        }

        async function loadIndustries() {
            try {
                const { data } = await sb.from('industrias').select('*, categorias(nome)').order('nome');
                allIndustries = data || [];
                document.getElementById('indCount').innerText = allIndustries.length;
                renderIndustries(allIndustries);
                updateDashboard();
                cacheData();
            } catch (e) { console.error(e); }
        }

        function renderIndustries(industries) {
            const list = document.getElementById('industriesList');
            list.innerHTML = '';
            
            if (industries.length === 0) {
                list.innerHTML = '<div class="col-span-3 text-center py-20 text-slate-400 text-xs italic">Nenhum local. Clique em + para adicionar.</div>';
                return;
            }

            industries.forEach(ind => {
                const el = document.createElement('div');
                el.className = 'ind-card group cursor-pointer active:scale-95 relative';
                el.onclick = (e) => handleIndustryClick(ind, e);
                
                const catName = ind.categorias ? ind.categorias.nome : '';
                let colorClass = 'cat-badge bg-slate-100 text-slate-600';
                if (ind.categorias) colorClass = `cat-badge ${categoryColorsClass[(ind.categoria_id - 1) % categoryColorsClass.length]}`;

                const coverUrl = ind.cover_url ? `${ind.cover_url}?t=${Date.now()}` : '';
                const coverEl = coverUrl 
                    ? `<div class="cover-wrapper"><img src="${coverUrl}" loading="lazy" class="cover-img"></div>`
                    : `<div class="cover-wrapper flex items-center justify-center bg-slate-100 text-slate-300"><i class="fas fa-industry text-xl"></i></div>`;

                el.innerHTML = `
                    ${coverEl}
                    <h3 class="font-bold text-[10px] text-slate-600 dark:text-slate-300 text-center leading-tight line-clamp-2 px-1 break-words w-full flex-1 flex items-center justify-center">${ind.nome}</h3>
                    <div class="flex flex-col items-center gap-1 w-full mt-1">
                        ${catName ? `<div class="${colorClass}">${catName}</div>` : ''}
                        <span class="text-[8px] text-slate-400 font-mono">${ind.carga_semanal || 0}h/sem</span>
                    </div>
                    <button class="absolute top-1 right-1 w-6 h-6 rounded-full text-slate-400 hover:text-red-500 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 flex items-center justify-center z-10 shadow-sm" onclick="event.stopPropagation(); deleteIndustry('${ind.id}', event, '${ind.nome}')">
                        <i class="fas fa-trash-alt text-[9px]"></i>
                    </button>
                `;
                list.appendChild(el);
            });
        }

        // --- SISTEMA DE ROTAS E HORAS ---
        async function fetchRoutesFromDB() {
            try {
                const { data } = await sb.from('rotas').select('*');
                if (data) {
                    routes = { 'Domingo': [], 'Segunda': [], 'Terça': [], 'Quarta': [], 'Quinta': [], 'Sexta': [], 'Sábado': [] };
                    data.forEach(row => routes[row.dia] = row.industrias || []);
                }
            } catch (e) { console.error(e); }
        }

        function selectRouteViewDay(day) {
            viewSelectedDay = day;
            const container = document.getElementById('routeTabsContainer');
            container.innerHTML = '';
            weekDays.forEach(d => {
                const btn = document.createElement('button');
                btn.innerText = d.substring(0, 3);
                btn.className = `day-tab ${d === day ? 'active' : ''}${d === 'Domingo' ? ' text-red-400' : ''}`;
                btn.onclick = () => selectRouteViewDay(d);
                container.appendChild(btn);
            });
            renderRouteList(day);
        }

        function renderRouteList(day) {
            const container = document.getElementById('routeListContent');
            const dayItems = routes[day] || [];
            container.innerHTML = '';
            
            if (dayItems.length === 0) {
                container.innerHTML = '<div class="p-6 text-center text-slate-400 text-sm italic">Nenhuma rota definida.</div>';
                return;
            }

            dayItems.forEach(item => {
                const indName = (typeof item === 'string') ? item : item.nome;
                const indTime = (typeof item === 'object' && item.minutos) ? minutesToHM(item.minutos) : null;
                const ind = allIndustries.find(i => i.nome === indName);
                
                if (!ind) return;

                const row = document.createElement('div');
                row.className = 'route-row group';
                row.onclick = () => openIndustry(ind);

                const coverUrl = ind.cover_url ? `${ind.cover_url}?t=${Date.now()}` : '';
                const imgEl = coverUrl 
                    ? `<img src="${coverUrl}" loading="lazy" class="w-10 h-10 rounded-lg object-cover bg-slate-200 mr-3">`
                    : `<div class="w-10 h-10 rounded-lg bg-slate-200 flex items-center justify-center text-slate-400 mr-3"><i class="fas fa-industry"></i></div>`;

                const timeBadge = indTime ? `<span class="text-[10px] font-mono font-bold bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded ml-auto mr-2">${indTime}h</span>` : '';

                row.innerHTML = `
                    <div class="flex items-center flex-1 overflow-hidden">
                        ${imgEl}
                        <div class="flex flex-col truncate">
                            <span class="font-bold text-sm text-slate-700 dark:text-slate-200 truncate">${ind.nome}</span>
                            ${ind.categorias ? `<span class="text-[9px] text-blue-500 font-bold uppercase">${ind.categorias.nome}</span>` : ''}
                        </div>
                    </div>
                    ${timeBadge}
                    <i class="fas fa-chevron-right text-slate-300 text-xs"></i>
                `;
                container.appendChild(row);
            });
        }

        // --- CONFIGURAÇÃO DE ROTAS (MODAL) ---
        function openRouteConfig() {
            document.getElementById('routeConfigModal').classList.remove('hidden');
            selectRouteConfigDay(viewSelectedDay || 'Segunda');
        }

        function selectRouteConfigDay(day) {
            configSelectedDay = day;
            document.querySelectorAll('.day-cfg-btn').forEach(btn => {
                const active = btn.innerText.trim().startsWith(day.substring(0, 3));
                btn.className = active 
                    ? 'day-cfg-btn bg-blue-600 text-white px-0 py-2 rounded text-[9px] font-bold shadow w-full'
                    : 'day-cfg-btn bg-slate-100 dark:bg-slate-700 text-slate-500 font-bold border border-slate-200 dark:border-slate-600 w-full';
            });
            document.getElementById('currentConfigDay').innerText = day;
            renderChecklist();
        }

        function renderChecklist() {
            const list = document.getElementById('routeChecklist');
            list.innerHTML = '';
            const currentRoute = routes[configSelectedDay] || [];

            allIndustries.forEach(ind => {
                const existingItem = currentRoute.find(r => (typeof r === 'string' ? r === ind.nome : r.nome === ind.nome));
                const isChecked = !!existingItem;
                const allocatedMin = (existingItem && typeof existingItem === 'object') ? existingItem.minutos : 0;

                let weeklyTotal = 0;
                weekDays.forEach(d => {
                    const dayRoute = routes[d] || [];
                    const item = dayRoute.find(r => (typeof r === 'string' ? r === ind.nome : r.nome === ind.nome));
                    if(item && typeof item === 'object') weeklyTotal += item.minutos;
                });

                const targetMin = (ind.carga_semanal || 0) * 60;
                let statusClass = 'bg-slate-100 text-slate-400';
                if (targetMin > 0) {
                    if (weeklyTotal < targetMin) statusClass = 'hour-warn';
                    else if (weeklyTotal === targetMin) statusClass = 'hour-ok';
                    else statusClass = 'hour-err';
                }

                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-2 bg-white dark:bg-slate-800 rounded border border-slate-100 dark:border-slate-700';
                const safeName = ind.nome.replace(/'/g, "\\'");
                const inputDisplay = isChecked ? 'block' : 'none';
                
                item.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 cursor-pointer" onclick="toggleRouteItem('${safeName}')">
                        <div class="w-5 h-5 rounded border ${isChecked ? 'bg-blue-600 border-blue-600' : 'border-slate-300'} flex items-center justify-center">
                            ${isChecked ? '<i class="fas fa-check text-white text-xs"></i>' : ''}
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-slate-700 dark:text-slate-200">${ind.nome}</span>
                            <span class="hour-badge ${statusClass} w-fit">Meta: ${minutesToHM(weeklyTotal)}h / ${ind.carga_semanal || 0}h</span>
                        </div>
                    </div>
                    <input type="time" class="time-input" style="display:${inputDisplay}" 
                           value="${minutesToHM(allocatedMin)}" 
                           onchange="updateRouteTime('${safeName}', this.value)">
                `;
                list.appendChild(item);
            });
        }

        function toggleRouteItem(name) {
            if (!routes[configSelectedDay]) routes[configSelectedDay] = [];
            const idx = routes[configSelectedDay].findIndex(r => (typeof r === 'string' ? r === name : r.nome === name));
            
            if (idx > -1) routes[configSelectedDay].splice(idx, 1);
            else routes[configSelectedDay].push({ nome: name, minutos: 0 });
            
            renderChecklist();
        }

        function updateRouteTime(name, timeStr) {
            const mins = hmToMinutes(timeStr);
            const idx = routes[configSelectedDay].findIndex(r => (typeof r === 'string' ? r === name : r.nome === name));
            if (idx > -1) {
                routes[configSelectedDay][idx] = { nome: name, minutos: mins };
                renderChecklist();
            }
        }

        // --- CRUD COMPLETO ---
        async function saveIndustry() {
            const id = document.getElementById('editIndId').value;
            const name = document.getElementById('newIndName').value.trim();
            const hours = parseInt(document.getElementById('newIndHours').value) || 0;
            const catId = document.getElementById('catSelect').value || null;
            
            if (!name) return showToast("Nome obrigatório", "error");
            showToast("Salvando...", "loading");
            
            let coverUrl = null;
            try {
                const safeName = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_");
                if (coverImageFile) {
                    const coverFileName = `${safeName}/cover_${Date.now()}.jpg`;
                    const blob = await resizeImage(coverImageFile);
                    const { error } = await sb.storage.from(BUCKET).upload(coverFileName, blob, { upsert: true, contentType: 'image/jpeg' });
                    if(!error) {
                        const { data } = sb.storage.from(BUCKET).getPublicUrl(coverFileName);
                        coverUrl = data.publicUrl;
                    }
                }

                const payload = { nome: name, categoria_id: catId, carga_semanal: hours };
                if (coverUrl) payload.cover_url = coverUrl;

                if (id) await sb.from('industrias').update(payload).eq('id', id);
                else {
                    await sb.storage.from(BUCKET).upload(`${safeName}/.keep`, new Blob(['']), { upsert: true });
                    await sb.from('industrias').insert(payload);
                }
                
                showToast("Salvo!", "success");
                closeAddModal();
                await loadIndustries();
            } catch (e) {
                console.error(e);
                showToast("Erro ao salvar", "error");
            }
        }

        async function deleteIndustry(id, e, indName) {
            if (e) e.stopPropagation();
            if (!indName) {
                const ind = allIndustries.find(i => i.id == id);
                if (ind) indName = ind.nome;
            }

            showToast("Excluindo...", "loading");
            try {
                if (indName) {
                    const safeName = indName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_");
                    const { data: files } = await sb.storage.from(BUCKET).list(safeName);
                    if (files && files.length > 0) {
                        const paths = files.map(f => `${safeName}/${f.name}`);
                        await sb.storage.from(BUCKET).remove(paths);
                    }
                    await sb.storage.from(BUCKET).remove([`${safeName}/.keep`]);
                }

                await sb.from('industrias').delete().eq('id', id);
                
                allIndustries = allIndustries.filter(i => i.id != id);
                renderIndustries(allIndustries);
                updateDashboard();
                showToast("Excluído!", "success");
                
                if (currentIndustry && currentIndustry.id == id) navigateTo('view-home');

            } catch (e) {
                console.error(e);
                showToast("Erro ao excluir", "error");
            }
        }

        async function deleteCurrentIndustry() {
            const id = document.getElementById('editIndId').value;
            const name = document.getElementById('newIndName').value;
            if(!id) return;
            if(!confirm("Tem certeza absoluta? Isso apagará todas as fotos e registros.")) return;
            closeAddModal();
            await deleteIndustry(id, null, name);
        }

        // --- NAVEGAÇÃO E UX ---
        function navigateTo(id, hist = true) {
            if (hist) viewHistory.push(document.querySelector('.view-section.active').id);
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            const nav = document.getElementById('mainNavBar');
            const back = document.getElementById('backBtn');
            const select = document.getElementById('selectBtn');
            
            isSelectionMode = false;
            selectedPhotos.clear();
            selectedIndustries.clear();
            updateSelectionUI();
            document.getElementById('selectionControls').classList.add('hidden-bar');
            document.getElementById('selectionControlsAll').classList.add('hidden-bar');

            if (id === 'view-home') {
                nav.classList.remove('hidden-nav');
                back.classList.add('hidden');
                document.getElementById('configRouteBtn').classList.remove('hidden');
                select.classList.add('hidden');
                document.getElementById('nav-general').classList.add('active');
                document.getElementById('nav-routes').classList.remove('active');
            } else if (id === 'view-routes') {
                nav.classList.remove('hidden-nav');
                back.classList.add('hidden');
                document.getElementById('configRouteBtn').classList.add('hidden');
                select.classList.remove('hidden');
                document.getElementById('nav-general').classList.remove('active');
                document.getElementById('nav-routes').classList.add('active');
            } else {
                nav.classList.add('hidden-nav');
                back.classList.remove('hidden');
                document.getElementById('configRouteBtn').classList.add('hidden');
                select.classList.add('hidden');
            }

            if (id === 'view-gallery' || id === 'view-all') select.classList.remove('hidden');
            if (id === 'view-dates') document.getElementById('editIndBtn').classList.remove('hidden');
            else document.getElementById('editIndBtn').classList.add('hidden');
        }

        function goBack() {
            if (viewHistory.length === 0) navigateTo('view-home', false);
            else navigateTo(viewHistory.pop(), false);
        }

        function switchMainTab(tab) {
            viewHistory = [];
            if (tab === 'general') navigateTo('view-home', false);
            else navigateTo('view-routes', false);
        }

        function openAddModal() { 
            document.getElementById('modalTitle').innerText = "Nova Indústria";
            document.getElementById('newIndName').value = '';
            document.getElementById('newIndHours').value = '';
            document.getElementById('editIndId').value = '';
            document.getElementById('catSelect').value = '';
            document.getElementById('coverPreview').classList.add('hidden');
            document.getElementById('coverPlaceholder').classList.remove('hidden');
            document.getElementById('btnDeleteInd').classList.add('hidden');
            coverImageFile = null;
            document.getElementById('addModal').classList.remove('hidden');
        }

        function openEditIndustryModal() {
            if (!currentIndustry) return;
            document.getElementById('modalTitle').innerText = "Editar Indústria";
            document.getElementById('newIndName').value = currentIndustry.nome;
            document.getElementById('newIndHours').value = currentIndustry.carga_semanal || '';
            document.getElementById('editIndId').value = currentIndustry.id;
            document.getElementById('catSelect').value = currentIndustry.categoria_id || '';
            
            const img = document.getElementById('coverPreview');
            const ph = document.getElementById('coverPlaceholder');
            if (currentIndustry.cover_url) {
                img.src = currentIndustry.cover_url; img.classList.remove('hidden'); ph.classList.add('hidden');
            } else {
                img.classList.add('hidden'); ph.classList.remove('hidden');
            }
            document.getElementById('btnDeleteInd').classList.remove('hidden');
            coverImageFile = null;
            document.getElementById('addModal').classList.remove('hidden');
        }

        function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }
        function handleCoverChange(e) { const f = e.target.files[0]; if(!f) return; coverImageFile = f; document.getElementById('coverPreview').src = URL.createObjectURL(f); document.getElementById('coverPreview').classList.remove('hidden'); document.getElementById('coverPlaceholder').classList.add('hidden'); }

        // --- Helpers ---
        function minutesToHM(m) { const h = Math.floor(m / 60); const min = m % 60; return `${String(h).padStart(2,'0')}:${String(min).padStart(2,'0')}`; }
        function hmToMinutes(hm) { const [h, m] = hm.split(':').map(Number); return (h * 60) + m; }
        function resizeImage(file) { return new Promise((resolve) => { const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const max = 1200; const scale = max / Math.max(img.width, img.height); canvas.width = img.width * scale; canvas.height = img.height * scale; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.85); }; img.src = e.target.result; }; reader.readAsDataURL(file); }); }
        
        function showToast(msg, type = 'loading') {
            const toast = document.getElementById('statusToast');
            document.getElementById('toastMsg').innerText = msg;
            toast.classList.remove('opacity-0', '-translate-y-10');
            if (type === 'success') document.getElementById('toastIcon').className = 'fas fa-check-circle text-green-500';
            else if (type === 'error') document.getElementById('toastIcon').className = 'fas fa-times-circle text-red-500';
            else document.getElementById('toastIcon').className = 'loader border-t-blue-500';
            
            setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 2000);
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark');
            }
        }

        // Funções de Cache, Dashboard e Categorias
        function cacheData() { localStorage.setItem('cached_industries', JSON.stringify(allIndustries)); localStorage.setItem('cached_routes', JSON.stringify(routes)); localStorage.setItem('cached_categories', JSON.stringify(categories)); }
        function loadFromCache() { const ind = localStorage.getItem('cached_industries'); const rts = localStorage.getItem('cached_routes'); const cats = localStorage.getItem('cached_categories'); if (ind) allIndustries = JSON.parse(ind); if (rts) routes = JSON.parse(rts); if (cats) categories = JSON.parse(cats); document.getElementById('indCount').innerText = allIndustries.length; updateDashboard(); const today = weekDays[new Date().getDay()]; if(!viewSelectedDay) viewSelectedDay = today; selectRouteViewDay(viewSelectedDay); }
        async function updateDashboard() { document.getElementById('dashTotalInd').innerText = allIndustries.length; const today = weekDays[new Date().getDay()]; const todaysRoute = routes[today] || []; let totalMin = 0; todaysRoute.forEach(item => { if(typeof item === 'object' && item.minutos) totalMin += item.minutos; }); document.getElementById('dashWorkLoad').innerText = minutesToHM(totalMin) + 'h'; }
        async function loadCategories() { try { const { data } = await sb.from('categorias').select('*').order('nome'); categories = data || []; const selects = [document.getElementById('catSelect'), document.getElementById('bulkCatSelect')]; selects.forEach(sel => { sel.innerHTML = '<option value="">Sem Categoria</option>'; categories.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.innerText = c.nome; sel.appendChild(opt); }); }); } catch (e) { console.error(e); } }
        async function addNewCategory() { const name = document.getElementById('newCatName').value.trim(); if (!name) return; await sb.from('categorias').insert({ nome: name }); await loadCategories(); document.getElementById('newCatContainer').classList.add('hidden'); }
        
        // Outros modais
        function openBulkCategoryModal() { if (selectedIndustries.size === 0) return; document.getElementById('bulkCountDisplay').innerText = selectedIndustries.size; document.getElementById('bulkCatModal').classList.remove('hidden'); }
        async function saveBulkCategory() { const catId = document.getElementById('bulkCatSelect').value || null; const ids = Array.from(selectedIndustries); showToast("Atualizando...", "loading"); try { await sb.from('industrias').update({ categoria_id: catId }).in('id', ids); showToast("Atualizado!", "success"); document.getElementById('bulkCatModal').classList.add('hidden'); selectedIndustries.clear(); await loadIndustries(); } catch (e) { console.error(e); showToast("Erro", "error"); } }
        async function deleteSelectedIndustries() { if (selectedIndustries.size === 0) return; if (!confirm("Apagar selecionados?")) return; showToast("Apagando...", "loading"); try { await sb.from('industrias').delete().in('id', Array.from(selectedIndustries)); selectedIndustries.clear(); await loadIndustries(); showToast("Apagado!", "success"); } catch (e) { console.error(e); showToast("Erro", "error"); } }
        
        function handleIndustryClick(ind, e) { if (isSelectionMode) { if (selectedIndustries.has(ind.id)) selectedIndustries.delete(ind.id); else selectedIndustries.add(ind.id); } else { openIndustry(ind); } }
        function openIndustry(ind) { currentIndustry = ind; calendarCursor = new Date(); navigateTo('view-dates'); loadDates(ind.nome); }
        async function loadDates(indName) { const safe = indName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_"); const { data } = await sb.from('fotos').select('*').like('nome_arquivo', `${safe}/%`).order('created_at', { ascending: false }); industryPhotos = data || []; availableDates.clear(); if (data) data.forEach(i => availableDates.add(new Date(i.created_at).toLocaleDateString('pt-BR'))); renderCalendar(); }
        function renderCalendar() { const grid = document.getElementById('calendarGrid'); grid.innerHTML = ''; const y = calendarCursor.getFullYear(); const m = calendarCursor.getMonth(); document.getElementById('calendarTitle').innerText = `${["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][m]} ${y}`; const f = new Date(y, m, 1).getDay(); const dim = new Date(y, m + 1, 0).getDate(); for(let i=0;i<f;i++) grid.appendChild(document.createElement('div')); for(let d=1;d<=dim;d++) { const b = document.createElement('div'); b.className = 'cal-day-btn'; const s = `${String(d).padStart(2,'0')}/${String(m+1).padStart(2,'0')}/${y}`; b.innerText = d; if(availableDates.has(s)) { b.classList.add('active-day'); b.innerHTML = `${d}<div class="dot"></div>`; b.onclick = () => { currentDateFolder = s; navigateTo('view-gallery'); loadGalleryPhotos(); }; } grid.appendChild(b); } }
        function changeCalendarMonth(o) { calendarCursor.setMonth(calendarCursor.getMonth() + o); renderCalendar(); }
        
        function filterIndustries() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const term = document.getElementById('searchInput').value.toLowerCase();
                const filtered = allIndustries.filter(ind => ind.nome.toLowerCase().includes(term));
                renderIndustries(filtered);
            }, 300);
        }
        let searchTimeout;

        function loadGalleryPhotos() { const c = document.getElementById('photosContainer'); c.innerHTML = ''; const p = industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-BR') === currentDateFolder); if(p.length===0) c.innerHTML='<div class="col-span-3 text-center text-xs text-slate-400 py-10">Vazio</div>'; p.forEach(f => { const d = document.createElement('div'); d.className = `photo-item ${selectedPhotos.has(f.id)?'selected':''}`; d.onclick = () => handlePhotoClick(f); d.innerHTML = `<img src="${f.url_publica}" class="w-full h-full object-cover">`; c.appendChild(d); }); }
        function handlePhotoClick(f) { if(isSelectionMode) { selectedPhotos.has(f.id) ? selectedPhotos.delete(f.id) : selectedPhotos.add(f.id); updateSelectionUI(); loadGalleryPhotos(); } else { currentModalPhoto = f.id; document.getElementById('previewImg').src = f.url_publica; document.getElementById('photoModal').classList.remove('hidden'); setTimeout(()=>document.getElementById('photoModal').classList.remove('opacity-0'),10); } }
        function closePhotoModal() { document.getElementById('photoModal').classList.add('opacity-0'); setTimeout(()=>document.getElementById('photoModal').classList.add('hidden'),300); }
        async function deleteSinglePhoto() { if(!currentModalPhoto) return; await sb.from('fotos').delete().eq('id', currentModalPhoto); closePhotoModal(); loadGalleryPhotos(); }
        async function uploadPhoto(i) { const f = i.files[0]; if(!f) return; showToast("Enviando..."); const safe = currentIndustry.nome.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_"); const name = `${safe}/${currentDateFolder}/FOTO_${Date.now()}.jpg`; const blob = await resizeImage(f); await sb.storage.from(BUCKET).upload(name, blob, { contentType: 'image/jpeg' }); const {data:{publicUrl}} = sb.storage.from(BUCKET).getPublicUrl(name); await sb.from('fotos').insert({ created_at: new Date().toISOString(), nome_arquivo: name, url_publica: publicUrl, industria_id: currentIndustry.id }); loadDates(currentIndustry.nome); showToast("Enviado", "success"); }
        
        function toggleSelectionMode() { isSelectionMode = !isSelectionMode; const b = document.getElementById('selectBtn'); if(isSelectionMode) { b.innerText="Cancelar"; b.classList.add('text-red-500'); document.getElementById('selectionControls').classList.remove('hidden-bar'); } else { b.innerText="Selecionar"; b.classList.remove('text-red-500'); document.getElementById('selectionControls').classList.add('hidden-bar'); selectedPhotos.clear(); } loadGalleryPhotos(); }
        function updateSelectionUI() { document.getElementById('selCount').innerText = selectedPhotos.size; }
        function selectAllPhotos() { industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-BR') === currentDateFolder).forEach(f => selectedPhotos.add(f.id)); updateSelectionUI(); loadGalleryPhotos(); }
        async function deleteSelected() { if(!confirm("Apagar selecionados?")) return; showToast("Apagando..."); const ids = Array.from(selectedPhotos); await sb.from('fotos').delete().in('id', ids); selectedPhotos.clear(); toggleSelectionMode(); showToast("Feito", "success"); }
        async function generatePDF() { if(!industryPhotos.length) return; showToast("Gerando..."); const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text(currentIndustry.nome + " - " + currentDateFolder, 10, 10); doc.save("Relatorio.pdf"); showToast("Baixado", "success"); }
        async function openAllPhotos() { navigateTo('view-all'); const c = document.getElementById('allPhotosContainer'); c.innerHTML = '<div class="col-span-3 text-center"><div class="loader mx-auto"></div></div>'; const { data } = await sb.from('fotos').select('*').order('created_at', { ascending: false }).limit(200); c.innerHTML = ''; if(!data || data.length === 0) { c.innerHTML = '<div class="col-span-3 text-center text-slate-400 text-xs">Vazio</div>'; return; } data.forEach(f => { const d = document.createElement('div'); d.className = `photo-item ${selectedPhotos.has(f.id) ? 'selected' : ''}`; d.innerHTML = `<img src="${f.url_publica}" class="w-full h-full object-cover">`; d.onclick = () => handlePhotoClick(f); c.appendChild(d); }); }
        function shareSelected() { if(selectedPhotos.size === 0) return; showToast("Funcionalidade em desenvolvimento", "error"); }

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); document.getElementById('installBtn').classList.remove('hidden'); });
    </script>
</body>
</html>
