<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <title>Industrial Manager</title>
    
    <!-- Dependências Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Ajustes Globais */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #334155; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
            padding-bottom: calc(100px + env(safe-area-inset-bottom)); 
        }
        
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid #e2e8f0; }
        .glass-bar { background: rgba(255, 255, 255, 0.98); border-top: 1px solid #e2e8f0; }
        
        /* ABAS */
        .day-tab {
            font-weight: 800; font-size: 11px; color: #94a3b8; background: #e2e8f0;
            padding: 8px 0; width: 100%; border-radius: 6px 6px 0 0; 
            text-transform: uppercase; transition: all 0.2s; border-bottom: 2px solid transparent; 
            white-space: nowrap; display: flex; justify-content: center; align-items: center;
        }
        .day-tab.active { background: #ffffff; color: #3b82f6; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); position: relative; z-index: 10; }
        .day-tab.active::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #3b82f6; border-radius: 3px 3px 0 0; }
        .day-tab.sunday { color: #ef4444; } 
        .day-tab.sunday.active { color: #dc2626; } 
        .day-tab.sunday.active::after { background: #dc2626; }

        /* CARDS */
        .route-list-card { background: #ffffff; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; min-height: 300px; position: relative; z-index: 5; border: 1px solid #e2e8f0; border-top: none; }
        .route-row { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.1s; }
        .route-row:active { background: #f8fafc; }

        .ind-card { 
            background: #ffffff; border-radius: 16px; border: 1px solid #e2e8f0; 
            transition: transform 0.1s; display: flex; flex-direction: column; 
            align-items: center; justify-content: space-between; padding: 10px 6px; height: 90px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative;
        }
        .ind-card:active { transform: scale(0.96); border-color: #2563eb; }
        
        .cat-badge { font-size: 8px; font-weight: 700; text-transform: uppercase; background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; margin-top: 2px; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .folder-card { background: #ffffff; border-radius: 12px; border: 1px solid #e2e8f0; transition: all 0.2s; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .folder-card:active { background: #f8fafc; transform: scale(0.98); }

        .photo-item { position: relative; overflow: hidden; border-radius: 12px; background: #cbd5e1; aspect-ratio: 1/1; transition: transform 0.1s; }
        .photo-item:active { transform: scale(0.98); }
        .photo-item.selected { border: 4px solid #2563eb; }
        .photo-item.selected img { opacity: 0.7; }
        .photo-item.selected::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px; z-index: 10; background: #2563eb; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        /* BARRAS */
        .fixed-bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background: rgba(255, 255, 255, 0.98); border-top: 1px solid #e2e8f0; z-index: 60; padding-bottom: calc(20px + env(safe-area-inset-bottom)); padding-top: 20px; padding-left: 16px; padding-right: 16px; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); transition: transform 0.3s ease; }
        .fixed-bottom-bar.hidden-bar { transform: translateY(110%); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: calc(65px + env(safe-area-inset-bottom)); padding-bottom: env(safe-area-inset-bottom); background: #ffffff; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; align-items: flex-start; padding-top: 12px; z-index: 50; transition: transform 0.3s ease; }
        .bottom-nav.hidden-nav { transform: translateY(100%); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #94a3b8; font-size: 10px; font-weight: 600; width: 100%; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; }
        .nav-item.active { color: #2563eb; }

        .search-container { position: sticky; top: 0; z-index: 30; background: #f8fafc; padding-bottom: 10px; }
        .search-input { width: 100%; background: #ffffff; border: 1px solid #cbd5e1; border-radius: 12px; padding: 12px 12px 12px 40px; font-size: 14px; color: #334155; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        
        .btn-all-photos { background: #ffffff; border: 1px solid #e2e8f0; width: 100%; padding: 16px; border-radius: 16px; font-weight: 700; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px; margin-top: 15px; transition: transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-all-photos:active { transform: scale(0.98); background: #f1f5f9; }

        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="fixed top-0 w-full z-50 glass-header h-16 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center gap-3 w-2/3">
            <button id="backBtn" onclick="goBack()" class="hidden w-9 h-9 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center justify-center active:scale-90 transition"><i class="fas fa-arrow-left"></i></button>
            <div class="overflow-hidden">
                <h1 id="pageTitle" class="font-bold text-base text-slate-800 truncate tracking-tight">Cronograma</h1>
                <p id="pageSubtitle" class="text-[11px] text-slate-500 flex items-center gap-1.5 truncate">Visão Semanal</p>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <button id="installBtn" onclick="triggerInstall()" class="hidden bg-blue-600 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-md shadow-blue-200 flex items-center gap-1 animate-pulse"><i class="fas fa-download"></i> App</button>
            <button id="selectBtn" onclick="toggleSelectionMode()" class="hidden text-xs font-bold bg-slate-100 text-blue-600 px-4 py-2 rounded-full border border-slate-200 active:scale-95 transition">Selecionar</button>
            <button id="editIndBtn" onclick="openEditIndustryModal()" class="hidden w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:text-blue-600 flex items-center justify-center active:scale-95 border border-slate-200 transition"><i class="fas fa-pencil-alt text-sm"></i></button>
            <button id="configRouteBtn" onclick="openRouteConfig()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:text-blue-600 flex items-center justify-center active:scale-95 border border-slate-200 transition"><i class="fas fa-cog text-sm"></i></button>
            <button onclick="refreshCurrentView()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-500 hover:text-blue-600 flex items-center justify-center active:scale-95 border border-slate-200 transition"><i class="fas fa-sync-alt text-sm"></i></button>
        </div>
    </header>

    <div class="h-20"></div>

    <main class="max-w-md mx-auto px-4 pb-32">

        <!-- VIEW 1: HOME (CRONOGRAMA) -->
        <div id="view-home" class="view-section active">
            <div class="mb-4 px-1 text-xs font-bold text-slate-400 uppercase tracking-widest text-center">Agenda Semanal</div>
            <div class="grid grid-cols-7 gap-1 mb-0 px-1 pb-1" id="routeTabsContainer"></div>
            <div class="route-list-card"><div id="routeListContent" class="flex flex-col"><div class="p-6 text-center text-slate-400 text-sm">Carregando...</div></div></div>
            <button onclick="openAllPhotos()" class="btn-all-photos text-slate-500 hover:text-blue-600"><i class="fas fa-images mr-2"></i> Feed de Fotos</button>
        </div>

        <!-- VIEW 1.5: LOCAIS (LISTA GERAL) -->
        <div id="view-routes" class="view-section">
            <div class="search-container mb-4">
                <div class="relative"><i class="fas fa-search search-icon"></i><input type="text" id="searchInput" onkeyup="filterIndustries()" placeholder="Buscar local..." class="search-input"></div>
            </div>
            <div class="mb-2 flex justify-between items-end px-1">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-th-large"></i> Todos os Locais</span>
                <span id="indCount" class="text-[10px] bg-slate-200 px-2 py-1 rounded text-slate-600 font-mono font-bold">...</span>
            </div>
            <div id="industriesList" class="grid grid-cols-3 gap-3">
                <div class="col-span-3 flex flex-col items-center justify-center py-20 opacity-50"><div class="loader mb-2"></div><span class="text-xs text-slate-400">Lendo pastas...</span></div>
            </div>
            <button onclick="openAddModal()" class="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 rounded-full text-white shadow-xl shadow-blue-200 flex items-center justify-center text-2xl active:scale-90 transition z-40 transform hover:-translate-y-1"><i class="fas fa-plus"></i></button>
            
            <div id="industryActions" class="fixed-bottom-bar flex gap-3 hidden-bar">
                <button onclick="deleteSelectedIndustries()" class="w-14 h-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center border border-red-100 active:scale-90"><i class="fas fa-trash-alt text-lg"></i></button>
                <button onclick="openBulkCategoryModal()" class="flex-1 bg-blue-600 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95">Mudar Categoria (<span id="selIndCount">0</span>)</button>
            </div>
        </div>

        <!-- VIEW 2: DATAS -->
        <div id="view-dates" class="view-section">
            <div class="mb-4 flex justify-between items-center px-1">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Pastas por Data</span>
                <span class="text-[9px] text-slate-500 border border-slate-200 bg-white px-2 py-1 rounded">Auto-Clean: 45 dias</span>
            </div>
            <div id="datesList" class="space-y-3 pb-40"></div>
            <div id="cameraControlsDates" class="fixed-bottom-bar flex justify-center">
                <label class="w-full max-w-sm bg-gradient-to-r from-blue-600 to-blue-500 text-white py-4 rounded-xl flex items-center justify-center gap-2 active:scale-95 transition cursor-pointer shadow-lg shadow-blue-200 border border-white/20">
                    <i class="fas fa-camera text-xl"></i><span class="font-bold text-sm tracking-wide">FOTO DE HOJE</span>
                    <input type="file" accept="image/*" capture="environment" class="hidden" onchange="uploadPhoto(this)">
                </label>
            </div>
        </div>

        <!-- VIEW 3: GALERIA -->
        <div id="view-gallery" class="view-section">
            <div id="photosContainer" class="grid grid-cols-3 gap-1 pb-48 select-none"></div>
            <div id="cameraControls" class="fixed-bottom-bar flex justify-center">
                <label class="w-full max-w-sm bg-gradient-to-r from-blue-600 to-blue-500 text-white py-4 rounded-xl flex items-center justify-center gap-2 active:scale-95 transition cursor-pointer shadow-lg shadow-blue-200 border border-white/20">
                    <i class="fas fa-camera text-xl"></i><span class="font-bold text-sm tracking-wide">ADICIONAR FOTO</span>
                    <input type="file" accept="image/*" capture="environment" class="hidden" onchange="uploadPhoto(this)">
                </label>
            </div>
            <div id="selectionControls" class="fixed-bottom-bar flex gap-3 hidden-bar">
                <button onclick="deleteSelected()" class="w-14 h-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center border border-red-100 active:scale-90"><i class="fas fa-trash-alt text-lg"></i></button>
                <button onclick="shareSelected()" class="flex-1 bg-green-600 text-white font-bold rounded-xl shadow-lg shadow-green-200 flex items-center justify-center gap-2 active:scale-95">Compartilhar (<span id="selCount">0</span>)</button>
            </div>
        </div>

        <!-- VIEW 4: TODAS AS FOTOS -->
        <div id="view-all" class="view-section">
            <div class="mb-4 px-1 text-xs font-bold text-slate-400 uppercase tracking-widest">Feed Global (Recentes)</div>
            <div id="allPhotosContainer" class="grid grid-cols-3 gap-1 pb-48 select-none"></div>
            <div id="selectionControlsAll" class="fixed-bottom-bar flex gap-3 hidden-bar">
                <button onclick="deleteSelected()" class="w-14 h-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center border border-red-100 active:scale-90"><i class="fas fa-trash-alt text-lg"></i></button>
                <button onclick="shareSelected()" class="flex-1 bg-green-600 text-white font-bold rounded-xl shadow-lg shadow-green-200 flex items-center justify-center gap-2 active:scale-95">Compartilhar (<span id="selCountAll">0</span>)</button>
            </div>
        </div>

    </main>

    <!-- NAV INFERIOR -->
    <nav id="mainNavBar" class="bottom-nav">
        <div id="nav-general" class="nav-item active" onclick="switchMainTab('general')"><i class="fas fa-calendar-alt"></i><span>Geral</span></div>
        <div id="nav-routes" class="nav-item" onclick="switchMainTab('routes')"><i class="fas fa-th-large"></i><span>Locais</span></div>
    </nav>

    <!-- Modais -->
    <div id="routeConfigModal" class="fixed inset-0 bg-black/50 z-[80] hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-slate-100 h-[80vh] flex flex-col"><h3 class="text-sm font-bold text-slate-700 mb-2 uppercase">Configurar Rotas</h3><div class="grid grid-cols-7 gap-1 mb-4 pb-2"><button onclick="selectRouteConfigDay('Domingo')" class="day-cfg-btn bg-red-50 px-0 py-1 rounded text-[10px] text-red-500 font-bold border border-red-200 flex justify-center">DOM</button><button onclick="selectRouteConfigDay('Segunda')" class="day-cfg-btn bg-slate-100 px-0 py-1 rounded text-[10px] text-slate-500 font-bold border border-slate-200 flex justify-center">SEG</button><button onclick="selectRouteConfigDay('Terça')" class="day-cfg-btn bg-slate-100 px-0 py-1 rounded text-[10px] text-slate-500 font-bold border border-slate-200 flex justify-center">TER</button><button onclick="selectRouteConfigDay('Quarta')" class="day-cfg-btn bg-slate-100 px-0 py-1 rounded text-[10px] text-slate-500 font-bold border border-slate-200 flex justify-center">QUA</button><button onclick="selectRouteConfigDay('Quinta')" class="day-cfg-btn bg-slate-100 px-0 py-1 rounded text-[10px] text-slate-500 font-bold border border-slate-200 flex justify-center">QUI</button><button onclick="selectRouteConfigDay('Sexta')" class="day-cfg-btn bg-slate-100 px-0 py-1 rounded text-[10px] text-slate-500 font-bold border border-slate-200 flex justify-center">SEX</button><button onclick="selectRouteConfigDay('Sábado')" class="day-cfg-btn bg-slate-100 px-0 py-1 rounded text-[10px] text-slate-500 font-bold border border-slate-200 flex justify-center">SÁB</button></div><div class="text-xs text-slate-400 mb-2">Indústrias para <span id="currentConfigDay" class="text-blue-600 font-bold">...</span>:</div><div id="routeChecklist" class="flex-1 overflow-y-auto space-y-1 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100"></div><div class="flex gap-3 mt-auto"><button onclick="document.getElementById('routeConfigModal').classList.add('hidden')" class="flex-1 py-3 text-slate-400 text-xs font-medium hover:text-slate-600">Fechar</button><button onclick="saveRouteConfig()" class="flex-1 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg">SALVAR</button></div></div></div>

    <div id="addModal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs p-6 rounded-2xl shadow-2xl">
            <h3 id="modalTitle" class="text-sm font-bold text-slate-700 mb-4 uppercase">Nova Indústria</h3>
            <input type="hidden" id="editIndId">
            <input type="text" id="newIndName" placeholder="Nome (ex: Fabrica X)" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 mb-3 text-slate-700 text-sm focus:outline-none focus:border-blue-500">
            <div class="flex gap-2 mb-4">
                <div class="relative w-full">
                    <select id="catSelect" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-600 text-xs focus:outline-none appearance-none"><option value="">Sem Categoria</option></select>
                    <i class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 text-xs"></i>
                </div>
                <button onclick="document.getElementById('newCatContainer').classList.toggle('hidden')" class="w-10 bg-blue-50 text-blue-600 rounded-xl border border-blue-200 flex items-center justify-center"><i class="fas fa-plus"></i></button>
            </div>
            <div id="newCatContainer" class="hidden mb-4 flex gap-2"><input type="text" id="newCatName" placeholder="Nova Categoria..." class="w-full bg-white border border-slate-300 rounded-lg p-2 text-xs"><button onclick="addNewCategory()" class="bg-green-500 text-white px-3 rounded-lg text-xs font-bold">OK</button></div>
            <div class="flex gap-3"><button onclick="closeAddModal()" class="flex-1 py-3 text-slate-400 text-xs font-medium hover:text-slate-600">Cancelar</button><button id="btnSaveInd" onclick="saveIndustry()" class="flex-1 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg">SALVAR</button></div>
        </div>
    </div>
    
    <div id="bulkCatModal" class="fixed inset-0 bg-black/50 z-[90] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs p-6 rounded-2xl shadow-2xl">
            <h3 class="text-sm font-bold text-slate-700 mb-4 uppercase">Mudar Categoria</h3>
            <p class="text-xs text-slate-500 mb-2">Aplicar para <span id="bulkCountDisplay" class="font-bold">0</span> indústrias:</p>
            <div class="relative w-full mb-4">
                <select id="bulkCatSelect" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-slate-600 text-xs focus:outline-none appearance-none"><option value="">Sem Categoria</option></select>
                <i class="fas fa-chevron-down absolute right-3 top-3.5 text-slate-400 text-xs"></i>
            </div>
            <div class="flex gap-3"><button onclick="document.getElementById('bulkCatModal').classList.add('hidden')" class="flex-1 py-3 text-slate-400 text-xs font-medium hover:text-slate-600">Cancelar</button><button onclick="saveBulkCategory()" class="flex-1 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg">APLICAR</button></div>
        </div>
    </div>

    <div id="installModal" class="fixed inset-0 bg-black/60 z-[100] hidden flex flex-col items-center justify-center p-6 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl"><h3 class="text-lg font-bold text-slate-800 mb-2">Instalar App</h3><div id="iosInstructions" class="hidden space-y-4 text-sm text-slate-600"><p>1. Toque em <b>Compartilhar</b> <i class="fas fa-share-square text-blue-500"></i></p><p>2. Selecione <b>"Adicionar à Tela de Início"</b></p></div><div id="androidInstructions" class="hidden"><button id="nativeInstallBtn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md">Instalar Agora</button></div><button onclick="document.getElementById('installModal').classList.add('hidden')" class="mt-4 text-slate-400 text-sm w-full py-2">Fechar</button></div></div>
    <div id="photoModal" class="fixed inset-0 bg-black z-[70] hidden flex flex-col justify-center items-center opacity-0 transition-opacity duration-300"><div class="absolute top-0 w-full p-4 flex justify-end z-20"><button onclick="closePhotoModal()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white backdrop-blur-md active:scale-90"><i class="fas fa-times text-xl"></i></button></div><img id="previewImg" src="" class="max-h-[80vh] max-w-full object-contain mb-4 rounded shadow-2xl"><div class="absolute bottom-8 flex gap-4 w-full max-w-xs justify-center px-4"><button onclick="deleteSinglePhoto()" class="w-14 h-14 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90"><i class="fas fa-trash-alt text-lg"></i></button></div></div>
    <div id="statusToast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-white border border-slate-200 text-slate-700 px-5 py-2.5 rounded-full shadow-xl text-xs font-bold flex items-center gap-2 transition-all opacity-0 -translate-y-10 z-[100]"><div id="toastIcon" class="loader w-3 h-3 border-slate-200 border-t-blue-500"></div><span id="toastMsg">Processando...</span></div>

    <script>
        const SUPABASE_URL = 'https://hluxaxbjdpbezvffisns.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsdXhheGJqZHBiZXp2ZmZpc25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTg3NDgsImV4cCI6MjA4MDU5NDc0OH0.lia_McknZ7SD2EGlNchRVZ9d359bFkk7hSJXJYhJzig';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const BUCKET = 'galeria';
        const DELETE_AFTER_DAYS = 45;

        let currentIndustry = null;
        let currentDateFolder = null;
        let industryPhotos = []; 
        let allIndustries = []; 
        let categories = [];
        let isSelectionMode = false;
        let selectedPhotos = new Set();
        let selectedIndustries = new Set(); 
        let currentModalPhoto = null;
        
        let routes = { 'Domingo': [], 'Segunda': [], 'Terça': [], 'Quarta': [], 'Quinta': [], 'Sexta': [], 'Sábado': [] };
        const weekDays = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
        let configSelectedDay = null;
        let viewSelectedDay = null;
        let deferredPrompt;
        const installModal = document.getElementById('installModal'), installBtn = document.getElementById('installBtn'), isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        const categoryColors = [
            'bg-blue-100 text-blue-700', 'bg-green-100 text-green-700', 'bg-purple-100 text-purple-700',
            'bg-orange-100 text-orange-700', 'bg-pink-100 text-pink-700', 'bg-teal-100 text-teal-700'
        ];

        // NOVA FUNÇÃO: Atualiza os dados sem recarregar a página inteira (mantém a view atual)
        async function refreshCurrentView() {
            showToast("Atualizando dados...", "loading");
            
            try {
                await Promise.all([loadIndustries(), fetchRoutesFromDB(), loadCategories()]);
                
                const activeView = document.querySelector('.view-section.active').id;
                
                // Reaplica filtro de busca se existir
                filterIndustries();
                
                if (activeView === 'view-home') {
                    if (!viewSelectedDay) {
                        const todayIndex = new Date().getDay();
                        viewSelectedDay = weekDays[todayIndex];
                    }
                    selectRouteViewDay(viewSelectedDay);
                } else if (activeView === 'view-routes') {
                    // Já foi atualizado por loadIndustries + filterIndustries
                } else if (activeView === 'view-dates') {
                    if (currentIndustry) {
                        loadDates(currentIndustry.nome);
                    }
                } else if (activeView === 'view-gallery') {
                    loadGalleryPhotos();
                } else if (activeView === 'view-all') {
                    openAllPhotos();
                }
                
                showToast("Atualizado!", "success");
            } catch (e) {
                showToast("Erro ao atualizar", "error");
            }
        }

        // --- INIT: Handle URL hash for persistent view after reload ---
        window.onload = async () => { 
            await Promise.all([loadIndustries(), fetchRoutesFromDB(), loadCategories()]);
            
            // Handle view from URL hash (ex: #view-routes)
            const hash = window.location.hash.replace('#', '');
            if (hash && document.getElementById(hash)) {
                navigateTo(hash, false);
                // If it's the home or routes view, update bottom nav highlight accordingly
                if(hash === 'view-home') {
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.getElementById('nav-general').classList.add('active');
                    document.getElementById('configRouteBtn').classList.remove('hidden');
                } else if(hash === 'view-routes') {
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    document.getElementById('nav-routes').classList.add('active');
                    document.getElementById('configRouteBtn').classList.add('hidden');
                }
            } else {
                // Default behavior: Home view + highlight geral nav + select today
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById('nav-general').classList.add('active');
                document.getElementById('configRouteBtn').classList.remove('hidden');

                // Auto-Select Today
                const todayIndex = new Date().getDay();
                const todayName = weekDays[todayIndex];
                selectRouteViewDay(todayName);
            }
        };

        window.addEventListener('popstate', (event) => {
            if(!document.getElementById('addModal').classList.contains('hidden')) { closeAddModal(); history.pushState(null, null, location.href); return; }
            if(!document.getElementById('photoModal').classList.contains('hidden')) { closePhotoModal(); history.pushState(null, null, location.href); return; }
            
            const activeView = document.querySelector('.view-section.active').id;
            if(activeView === 'view-gallery') navigateTo('view-dates', false);
            else if(activeView === 'view-dates') navigateTo('view-home', false);
            else if(activeView === 'view-all') navigateTo('view-home', false);
            else if(activeView === 'view-routes') switchMainTab('general');
        });

        // --- SISTEMA ---
        async function fetchRoutesFromDB() {
            try {
                const { data } = await sb.from('rotas').select('*');
                if (data && data.length > 0) {
                    data.forEach(row => { if(routes[row.dia]) routes[row.dia] = row.industrias; });
                }
            } catch (e) { console.error("Erro rotas:", e); }
        }

        async function saveRouteConfig() {
            showToast("Salvando...", "loading");
            try {
                await sb.from('rotas').upsert({ dia: configSelectedDay, industrias: routes[configSelectedDay] }, { onConflict: 'dia' });
                showToast("Salvo!", "success");
                if (configSelectedDay === viewSelectedDay) renderRouteList(configSelectedDay);
            } catch (e) { showToast("Erro", "error"); }
        }

        // --- NAVEGAÇÃO ---
        function switchMainTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(tab === 'general') {
                document.getElementById('nav-general').classList.add('active');
                navigateTo('view-home');
                document.getElementById('configRouteBtn').classList.remove('hidden');
            } 
            else {
                document.getElementById('nav-routes').classList.add('active');
                navigateTo('view-routes');
                document.getElementById('configRouteBtn').classList.add('hidden');
            }
        }

        // Alterado para usar hash na URL para preservar estado após reload
        function navigateTo(viewId, push = true) {
            if(push) {
                window.location.hash = viewId;
            }
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            const backBtn=document.getElementById('backBtn'), selectBtn=document.getElementById('selectBtn'), title=document.getElementById('pageTitle'), subtitle=document.getElementById('pageSubtitle'), navBar=document.getElementById('mainNavBar');
            const editIndBtn = document.getElementById('editIndBtn');
            
            isSelectionMode = false; selectedPhotos.clear(); selectedIndustries.clear(); updateSelectionUI();
            backBtn.classList.add('hidden'); selectBtn.classList.add('hidden'); editIndBtn.classList.add('hidden');

            if (viewId === 'view-home') { 
                title.innerText = "Cronograma"; 
                subtitle.innerHTML = 'Visão Semanal'; 
                navBar.classList.remove('hidden-nav'); 
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById('nav-general').classList.add('active');
                document.getElementById('configRouteBtn').classList.remove('hidden');
            } 
            else if (viewId === 'view-routes') { 
                title.innerText = "Locais"; 
                subtitle.innerHTML = 'Lista Completa'; 
                navBar.classList.remove('hidden-nav'); 
                selectBtn.classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById('nav-routes').classList.add('active');
                document.getElementById('configRouteBtn').classList.add('hidden');
            }
            else {
                navBar.classList.add('hidden-nav'); 
                backBtn.classList.remove('hidden'); 
                if (viewId === 'view-dates') { 
                    title.innerText = currentIndustry.nome; 
                    subtitle.innerText = "Pastas"; 
                    editIndBtn.classList.remove('hidden'); 
                }
                else if (viewId === 'view-gallery') { 
                    selectBtn.classList.remove('hidden'); 
                    selectBtn.innerText = "Selecionar"; 
                    title.innerText = currentDateFolder; 
                    subtitle.innerText = "Galeria de Fotos"; 
                }
                else if (viewId === 'view-all') { 
                    selectBtn.classList.remove('hidden'); 
                    selectBtn.innerText = "Selecionar"; 
                    title.innerText = "Todas as Fotos"; 
                    subtitle.innerText = "Feed Geral"; 
                }
            }
        }

        function goBack() { window.history.back(); }

        function filterIndustries() { 
            const term = document.getElementById('searchInput').value.toLowerCase(); 
            const filtered = allIndustries.filter(ind => ind.nome.toLowerCase().includes(term)); 
            renderIndustries(filtered); 
        }

        async function loadIndustries() {
            try {
                const { data: dbData } = await sb.from('industrias').select('*, categorias(nome)').order('nome');
                const { data: stData } = await sb.storage.from(BUCKET).list('');
                
                if (stData) { 
                    const stFolders = stData.filter(i => i.name !== '.keep').map(i => i.name);
                    const dbNames = dbData ? dbData.map(i => i.nome) : [];
                    const missing = stFolders.filter(n => !dbNames.includes(n));
                    if (missing.length > 0) { await sb.from('industrias').insert(missing.map(n => ({ nome: n }))); return loadIndustries(); }
                }
                
                allIndustries = dbData; 
                document.getElementById('indCount').innerText = dbData.length; 
                renderIndustries(dbData);
            } catch(e) {}
        }

        function renderIndustries(industries) {
            const list = document.getElementById('industriesList'); list.innerHTML = '';
            if(industries.length === 0) { list.innerHTML = '<div class="col-span-3 text-center py-20 text-slate-600 text-xs">Vazio.</div>'; return; }
            industries.forEach(ind => {
                const el = document.createElement('div');
                el.className = 'ind-card group cursor-pointer active:scale-95 relative';
                el.onclick = (e) => handleIndustryClick(ind, e);
                
                const catName = ind.categorias ? ind.categorias.nome : '';
                const colorClass = ind.categorias ? categoryColors[ind.categorias.id % categoryColors.length] : 'bg-slate-100 text-slate-600';
                const catBadge = catName ? `<div class="cat-badge ${colorClass}">${catName}</div>` : '';

                el.innerHTML = `
                    <div class="w-10 h-10 rounded-lg bg-slate-800 flex items-center justify-center text-blue-500 border border-slate-700 shadow-inner mb-2"><i class="fas fa-industry text-lg"></i></div>
                    <h3 class="font-bold text-[10px] text-slate-600 text-center leading-tight line-clamp-2 px-1 break-words w-full">${ind.nome}</h3>
                    ${catBadge}
                    <button class="absolute top-1 right-1 w-6 h-6 rounded-full text-slate-400 hover:text-red-500 bg-white border border-slate-200 flex items-center justify-center z-10" onclick="deleteIndustry('${ind.id}', event, '${ind.nome}')"><i class="fas fa-trash-alt text-[9px]"></i></button>
                `;
                list.appendChild(el);
            });
        }

        // --- ROTAS / AGENDA ---
        function selectRouteViewDay(day) {
            viewSelectedDay = day;
            const container = document.getElementById('routeTabsContainer'); container.innerHTML = '';
            weekDays.forEach(d => {
                const btn = document.createElement('button');
                btn.innerText = d.substring(0, 3); 
                let className = `day-tab ${d === day ? 'active' : ''}`; 
                if (d === 'Domingo') className += ' sunday';
                btn.className = className;
                btn.onclick = () => selectRouteViewDay(d); 
                container.appendChild(btn);
            });
            renderRouteList(day);
        }

        function renderRouteList(day) {
            const container = document.getElementById('routeListContent');
            const industriesNames = routes[day] || []; container.innerHTML = '';
            if (industriesNames.length === 0) { container.innerHTML = '<div class="p-6 text-center text-slate-400 text-sm italic">Nenhuma rota definida.</div>'; return; }
            const fullIndustries = industriesNames.map(name => allIndustries.find(i => i.nome === name)).filter(Boolean);
            fullIndustries.forEach(ind => { 
                const row = document.createElement('div'); row.className = 'route-row group'; row.onclick = () => openIndustry(ind); 
                const catName = ind.categorias ? `<span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded ml-2">${ind.categorias.nome}</span>` : '';
                row.innerHTML = `<div class="flex items-center gap-2"><i class="fas fa-folder text-blue-400 text-lg"></i><div class="flex flex-col"><span class="font-bold text-sm text-slate-600">${ind.nome}</span></div>${catName}</div><i class="fas fa-chevron-right text-slate-300 text-xs group-active:translate-x-1 transition"></i>`; container.appendChild(row); 
            });
        }

        // --- RESTANTE (MANTIDO) ---
        async function loadCategories() { try { const { data } = await sb.from('categorias').select('*').order('nome'); if(data) { categories = data; renderCategoryOptions(); } } catch(e) {} }
        function renderCategoryOptions() { const s = document.getElementById('catSelect'), b = document.getElementById('bulkCatSelect'); [s, b].forEach(el => { el.innerHTML = '<option value="">Sem Categoria</option>'; categories.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.innerText = c.nome; el.appendChild(o); }); }); }
        async function addNewCategory() { const n = document.getElementById('newCatName').value.trim(); if(!n) return; try { const { data } = await sb.from('categorias').insert({ nome: n }).select(); await loadCategories(); document.getElementById('catSelect').value = data[0].id; document.getElementById('newCatContainer').classList.add('hidden'); } catch(e) {} }

        async function saveIndustry() {
            const id = document.getElementById('editIndId').value; const name = document.getElementById('newIndName').value.trim(); const catId = document.getElementById('catSelect').value || null; if(!name) return;
            showToast("Salvando...", "loading");
            try {
                if(id) { 
                     const oldInd = allIndustries.find(i => i.id == id);
                     if(oldInd && oldInd.nome !== name) {
                         const oldSafe = oldInd.nome.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_"); const newSafe = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_");
                         const { data: files } = await sb.from('fotos').select('*').like('nome_arquivo', `${oldSafe}/%`);
                         if(files) { for(const f of files) { const newPath = f.nome_arquivo.replace(`${oldSafe}/`, `${newSafe}/`); await sb.storage.from(BUCKET).move(f.nome_arquivo, newPath); await sb.from('fotos').update({nome_arquivo: newPath}).eq('id', f.id); } }
                         await sb.storage.from(BUCKET).move(`${oldSafe}/.keep`, `${newSafe}/.keep`);
                     }
                     await sb.from('industrias').update({ nome: name, categoria_id: catId }).eq('id', id);
                } else { 
                     const safeName = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_"); await sb.storage.from(BUCKET).upload(`${safeName}/.keep`, new Blob(['']), {upsert: true});
                     await sb.from('industrias').insert({ nome: name, categoria_id: catId });
                }
                showToast("Salvo!", "success"); closeAddModal(); loadIndustries();
            } catch(e) { showToast("Erro", "error"); alert(e.message); }
        }

        async function deleteIndustry(id, e, indName) {
             if(e) e.stopPropagation(); if(!confirm(`ATENÇÃO: Apagar indústria "${indName}"?`)) return;
             showToast("Apagando...", "loading");
             try { 
                 const ind = allIndustries.find(i => i.id == id);
                 if(ind) {
                     await sb.from('industrias').delete().eq('id', id); 
                     const safeName = ind.nome.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_");
                     await sb.storage.from(BUCKET).remove([`${safeName}/.keep`]);
                 }
                 showToast("Removido", "success"); loadIndustries(); 
             } catch(e) { showToast("Erro", "error"); }
        }

        function openIndustry(ind) { currentIndustry = ind; loadDates(ind.nome); }

        async function loadDates(indName) {
            navigateTo('view-dates');
            const list = document.getElementById('datesList');
            list.innerHTML = '<div class="flex justify-center py-10"><div class="loader"></div></div>';
            try {
                const safe = indName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_");
                const { data } = await sb.from('fotos').select('*').like('nome_arquivo', `${safe}/%`).order('created_at', { ascending: false });
                industryPhotos = data;
                list.innerHTML = '';
                if(data.length === 0) { list.innerHTML = '<div class="text-center py-20 text-slate-400 text-xs">Vazio.</div>'; return; }
                const datesMap = {}; data.forEach(f => { const date = new Date(f.created_at); const dateKey = date.toLocaleDateString('pt-BR'); if(!datesMap[dateKey]) datesMap[dateKey] = 0; datesMap[dateKey]++; });
                Object.keys(datesMap).forEach(dateLabel => {
                    const count = datesMap[dateLabel];
                    const el = document.createElement('div');
                    el.className = 'folder-card p-4 flex items-center justify-between cursor-pointer active:scale-[0.98] group';
                    el.onclick = () => openGallery(dateLabel);
                    el.innerHTML = `<div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center border border-blue-100"><i class="fas fa-folder text-xl"></i></div><div><h3 class="font-bold text-sm text-slate-700">${dateLabel}</h3><p class="text-[10px] text-slate-400">${count} fotos</p></div></div>`;
                    list.appendChild(el);
                });
            } catch(e) {}
        }
        function openGallery(dateLabel) { currentDateFolder = dateLabel; navigateTo('view-gallery'); loadGalleryPhotos(); }
        function loadGalleryPhotos() { const container = document.getElementById('photosContainer'); container.innerHTML = ''; const photos = industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-BR') === currentDateFolder); if(photos.length === 0) { container.innerHTML = '<div class="col-span-3 text-center py-20 text-slate-400 text-xs">Vazio.</div>'; return; } photos.forEach(file => { const isSelected = selectedPhotos.has(file.id); const div = document.createElement('div'); div.className = `photo-item cursor-pointer ${isSelected ? 'selected' : ''}`; div.onclick = () => handlePhotoClick(file); let pressTimer; div.addEventListener('touchstart', () => { pressTimer = setTimeout(() => { toggleSelectionMode(); handlePhotoClick(file); }, 500); }); div.addEventListener('touchend', () => clearTimeout(pressTimer)); div.innerHTML = `<img src="${file.url_publica}" class="w-full h-full object-cover pointer-events-none">`; container.appendChild(div); }); }
        async function openAllPhotos() { navigateTo('view-all'); const container = document.getElementById('allPhotosContainer'); container.innerHTML = '<div class="col-span-3 flex justify-center py-10"><div class="loader"></div></div>'; try { const { data } = await sb.from('fotos').select('*').order('created_at', { ascending: false }).limit(200); industryPhotos = data; container.innerHTML = ''; data.forEach(file => { const isSelected = selectedPhotos.has(file.id); const div = document.createElement('div'); div.className = `photo-item cursor-pointer ${isSelected ? 'selected' : ''}`; div.onclick = () => handlePhotoClick(file); let pressTimer; div.addEventListener('touchstart', () => { pressTimer = setTimeout(() => { toggleSelectionMode(); handlePhotoClick(file); }, 500); }); div.addEventListener('touchend', () => clearTimeout(pressTimer)); div.innerHTML = `<img src="${file.url_publica}" class="w-full h-full object-cover pointer-events-none">`; container.appendChild(div); }); } catch(e) {} }
        
        // --- FUNÇÃO DE UPLOAD ---
        async function uploadPhoto(input) { 
            const file = input.files[0]; 
            if(!file || !currentIndustry) return; 
            showToast("Enviando...", "loading"); 
            try { 
                const safeName = currentIndustry.nome.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_"); 
                const blob = await resizeImage(file); 
                const now = new Date(); 
                let targetDateFolder = currentDateFolder; 
                if(!targetDateFolder) targetDateFolder = now.toLocaleDateString('pt-BR'); 
                const fileName = `${safeName}/${targetDateFolder}/FOTO_${now.getTime()}.jpg`; 
                
                // Definir explicitamente o Content-Type como image/jpeg
                const { data, error } = await sb.storage.from(BUCKET).upload(fileName, blob, { 
                    upsert: true,
                    contentType: 'image/jpeg' 
                });
                
                if (error) throw error;

                const { data: { publicUrl } } = sb.storage.from(BUCKET).getPublicUrl(fileName); 
                await sb.from('fotos').insert({ created_at: new Date(), nome_arquivo: fileName, url_publica: publicUrl }); 
                showToast("Salvo!", "success"); 
                if (document.getElementById('view-gallery').classList.contains('active')) loadGalleryPhotos(); 
                else { currentDateFolder = new Date().toLocaleDateString('pt-BR'); openGallery(currentDateFolder); } 
            } catch(e) { 
                console.error(e);
                showToast("Erro no envio", "error"); 
            } 
            input.value = ''; 
        }

        function toggleSelectionMode() { 
            isSelectionMode = !isSelectionMode; 
            const btn=document.getElementById('selectBtn'), cam=document.getElementById('cameraControls'), selBar=document.getElementById('selectionControls'), selBarAll=document.getElementById('selectionControlsAll'); 
            const isAll = document.getElementById('view-all').classList.contains('active'); 
            if(isSelectionMode) { 
                btn.innerText = "Cancelar"; 
                btn.classList.add('text-red-500','border-red-200','bg-red-50'); 
                if(cam) cam.classList.add('hidden-bar'); 
                if(isAll) selBarAll.classList.remove('hidden-bar'); 
                else selBar.classList.remove('hidden-bar'); 
            } else { 
                btn.innerText = "Selecionar"; 
                btn.classList.remove('text-red-500','border-red-200','bg-red-50'); 
                selectedPhotos.clear(); 
                if(cam) cam.classList.remove('hidden-bar'); 
                selBar.classList.add('hidden-bar'); 
                selBarAll.classList.add('hidden-bar'); 
                if(isAll) openAllPhotos(); 
                else loadGalleryPhotos(); 
            } 
        }
        function handlePhotoClick(file) { 
            if(isSelectionMode) { 
                selectedPhotos.has(file.id) ? selectedPhotos.delete(file.id) : selectedPhotos.add(file.id); 
                updateSelectionUI(); 
                const isAll = document.getElementById('view-all').classList.contains('active'); 
                if(isAll) openAllPhotos(); else loadGalleryPhotos(); 
            } else openPhotoModal(file.url_publica, file.id); 
        }
        function updateSelectionUI() { 
            const count = selectedPhotos.size; 
            if(document.getElementById('selCount')) document.getElementById('selCount').innerText = count; 
            if(document.getElementById('selCountAll')) document.getElementById('selCountAll').innerText = count; 
        }
        async function deleteSelected() { 
            if(selectedPhotos.size === 0) return; 
            if(!confirm(`Apagar ${selectedPhotos.size} fotos?`)) return; 
            showToast("Apagando...", "loading"); 
            try { 
                const ids = Array.from(selectedPhotos); 
                await sb.from('fotos').delete().in('id', ids); 
                selectedPhotos.clear(); 
                toggleSelectionMode(); 
                showToast("Apagado!", "success"); 
            } catch(e) { showToast("Erro", "error"); } 
        }
        async function deleteSinglePhoto() { 
            if(!currentModalPhoto || !confirm("Apagar?")) return; 
            try { 
                await sb.from('fotos').delete().eq('id', currentModalPhoto); 
                closePhotoModal(); 
                showToast("Apagado!", "success"); 
                if (document.getElementById('view-gallery').classList.contains('active')) loadGalleryPhotos(); 
                else openAllPhotos(); 
            } catch(e) { showToast("Erro", "error"); } 
        }
        
        // --- SHARE ---
        async function shareSelected() { 
            if(selectedPhotos.size === 0) return; 
            showToast(`Baixando...`, 'loading'); 
            try { 
                const filesArray = []; 
                const selectedData = industryPhotos.filter(p => selectedPhotos.has(p.id)); 
                for(let i=0; i<selectedData.length; i++) { 
                    const p = selectedData[i]; 
                    const resp = await fetch(p.url_publica);
                    const blob = await resp.blob(); 
                    const file = new File([blob], `Foto_${i+1}.jpg`, { type: blob.type }); 
                    filesArray.push(file); 
                } 
                if(navigator.share) { 
                    await navigator.share({ files: filesArray }); 
                    toggleSelectionMode(); 
                    showToast('Enviado!', 'success'); 
                } else { 
                    alert("Seu navegador não suporta compartilhamento direto de arquivos."); 
                } 
            } catch(e) { 
                console.error(e);
                showToast("Erro share", 'error'); 
            } 
        }

        function openRouteConfig() { document.getElementById('routeConfigModal').classList.remove('hidden'); selectRouteConfigDay('Segunda'); }
        function selectRouteConfigDay(day) { 
            configSelectedDay = day; 
            document.querySelectorAll('.day-cfg-btn').forEach(btn => { 
                if(btn.innerText.startsWith(day.substring(0,3))) { 
                    btn.className = 'day-cfg-btn bg-blue-600 text-white px-0 py-1 rounded text-[10px] font-bold shadow w-full'; 
                } else { 
                    btn.className = 'day-cfg-btn bg-slate-100 text-slate-500 px-0 py-1 rounded text-[10px] font-bold border border-slate-200 w-full'; 
                } 
            }); 
            document.getElementById('currentConfigDay').innerText = day; renderChecklist(); 
        }
        function renderChecklist() { 
            const list = document.getElementById('routeChecklist'); list.innerHTML = ''; 
            if(allIndustries.length === 0) { list.innerHTML = '<div class="p-2 text-xs text-red-400">Crie indústrias na aba Locais.</div>'; return; } 
            const currentRoute = routes[configSelectedDay] || []; 
            allIndustries.forEach(ind => { 
                const isChecked = currentRoute.includes(ind.nome); 
                const item = document.createElement('label'); 
                item.className = 'flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer'; 
                item.innerHTML = `<input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded border-slate-300" value="${ind.nome}" ${isChecked ? 'checked' : ''} onchange="toggleRouteItem('${ind.nome}')"><span class="text-sm text-slate-600">${ind.nome}</span>`; 
                list.appendChild(item); 
            }); 
        }
        function toggleRouteItem(indName) { 
            if(!routes[configSelectedDay]) routes[configSelectedDay] = []; 
            const idx = routes[configSelectedDay].indexOf(indName); 
            if(idx > -1) routes[configSelectedDay].splice(idx, 1); 
            else routes[configSelectedDay].push(indName); 
        }
        function handleIndustryClick(ind, e) { 
            if(isSelectionMode) { 
                const el = e.currentTarget; 
                if(selectedIndustries.has(ind.id)) { 
                    selectedIndustries.delete(ind.id); 
                    el.classList.remove('selected'); 
                } else { 
                    selectedIndustries.add(ind.id); 
                    el.classList.add('selected'); 
                } 
                document.getElementById('selIndCount').innerText = selectedIndustries.size; 
            } else { 
                openIndustry(ind); 
            } 
        }
        function openBulkCategoryModal() { 
            if(selectedIndustries.size === 0) return; 
            document.getElementById('bulkCountDisplay').innerText = selectedIndustries.size; 
            const select = document.getElementById('bulkCatSelect'); 
            select.innerHTML = '<option value="">Sem Categoria</option>'; 
            categories.forEach(cat => { 
                const opt = document.createElement('option'); 
                opt.value = cat.id; 
                opt.innerText = cat.nome; 
                select.appendChild(opt); 
            }); 
            document.getElementById('bulkCatModal').classList.remove('hidden'); 
        }
        async function saveBulkCategory() { 
            const catId = document.getElementById('bulkCatSelect').value || null; 
            const ids = Array.from(selectedIndustries); 
            showToast("Atualizando...", "loading"); 
            try { 
                const { error } = await sb.from('industrias').update({ categoria_id: catId }).in('id', ids); 
                if(error) throw error; 
                showToast("Atualizado!", "success"); 
                document.getElementById('bulkCatModal').classList.add('hidden'); 
                toggleSelectionMode(); 
                loadIndustries(); 
            } catch(e) { showToast("Erro", "error"); } 
        }
        async function deleteSelectedIndustries() { 
            if(selectedIndustries.size===0)return; 
            if(!confirm(`Apagar ${selectedIndustries.size} indústrias?`)) return; 
            showToast("Apagando...", "loading"); 
            try { 
                const ids = Array.from(selectedIndustries); 
                await sb.from('industrias').delete().in('id', ids); 
                selectedIndustries.clear(); 
                toggleSelectionMode(); 
                loadIndustries(); 
                showToast("Apagado!", "success"); 
            } catch(e) { showToast("Erro", "error"); } 
        }
        function openAddModal() { 
            document.getElementById('newIndName').value = ''; 
            document.getElementById('editIndId').value = ''; 
            document.getElementById('catSelect').value = ''; 
            document.getElementById('modalTitle').innerText = "Nova Indústria"; 
            document.getElementById('addModal').classList.remove('hidden'); 
        }
        function openEditIndustryModal() { 
            if(!currentIndustry) return; 
            document.getElementById('modalTitle').innerText = "Editar Indústria"; 
            document.getElementById('newIndName').value = currentIndustry.nome; 
            document.getElementById('editIndId').value = currentIndustry.id; 
            document.getElementById('catSelect').value = currentIndustry.categoria_id || ''; 
            document.getElementById('addModal').classList.remove('hidden'); 
        }
        function closeAddModal() { document.getElementById('addModal').classList.add('hidden'); }
        function openPhotoModal(url, id) { 
            currentModalPhoto = id; 
            document.getElementById('previewImg').src = url; 
            const m = document.getElementById('photoModal'); 
            m.classList.remove('hidden'); 
            setTimeout(()=>m.classList.remove('opacity-0'),10); 
        }
        function closePhotoModal() { 
            const m = document.getElementById('photoModal'); 
            m.classList.add('opacity-0'); 
            setTimeout(()=>m.classList.add('hidden'),300); 
        }
        function showToast(msg, type) { 
            const t=document.getElementById('statusToast'), i=document.getElementById('toastIcon'); 
            document.getElementById('toastMsg').innerText=msg; 
            t.classList.remove('opacity-0', '-translate-y-10'); 
            if(type==='success') { 
                i.className='fas fa-check text-green-400'; 
                setTimeout(()=>t.classList.add('opacity-0'), 2000); 
            } else if(type==='error') { 
                i.className='fas fa-times text-red-400'; 
                setTimeout(()=>t.classList.add('opacity-0'), 3000); 
            } else 
                i.className='loader w-3 h-3 border-slate-200 border-t-blue-500'; 
        }
        function resizeImage(file) { 
            return new Promise(resolve => { 
                const r = new FileReader(); 
                r.readAsDataURL(file); 
                r.onload = e => { 
                    const i = new Image(); 
                    i.src = e.target.result; 
                    i.onload = () => { 
                        const c = document.createElement('canvas'), max = 1200, s = max/i.width, w = (i.width>max)?max:i.width, h = (i.width>max)?i.height*s:i.height; 
                        c.width=w; 
                        c.height=h; 
                        c.getContext('2d').drawImage(i,0,0,w,h); 
                        c.toBlob(b=>resolve(b), 'image/jpeg', 0.8); 
                    }; 
                }; 
            }); 
        }
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden'); }); 
        if(isIOS) installBtn.classList.remove('hidden');
    </script>
</body>
</html>
