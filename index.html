<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>Industrial Manager Pro</title>
    
    <!-- PWA Meta Tags -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4300/4300058.png">
    <link rel="manifest" href="data:application/manifest+json,{'name':'Industrial Manager Pro','short_name':'IndManager','start_url':'.','display':'standalone','background_color':'#ffffff','theme_color':'#2563eb'}">

    <!-- Dependências -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9', border: '#334155', muted: '#94a3b8' },
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.2s ease-out', 'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)' }
                } 
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* === VARIÁVEIS DE CORES === */
        :root {
            --bg-body: #f8fafc; --bg-card: #ffffff; --bg-glass: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
            --primary: #3b82f6; --safe-bottom: env(safe-area-inset-bottom);
        }
        html.dark :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-glass: rgba(15, 23, 42, 0.95);
            --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155;
        }
        
        body { 
            font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main);
            padding-bottom: calc(100px + var(--safe-bottom)); 
            -webkit-tap-highlight-color: transparent; user-select: none;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        /* === COMPONENTES === */
        .glass { background: var(--bg-glass); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); }
        .card-modern { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        /* Indústria Card Refinado 1:1 */
        .ind-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
            padding: 6px; aspect-ratio: 1/1; display: flex; flex-direction: column; 
            justify-content: space-between; position: relative; overflow: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .ind-card:active { transform: scale(0.96); }
        .ind-card.selected-item { border: 2.5px solid var(--primary); background-color: rgba(59, 130, 246, 0.05); } 

        .ind-card .cover-wrapper { 
            width: 100%; flex: 1; border-radius: 10px; overflow: hidden; 
            background: #f1f5f9; position: relative; margin-bottom: 6px;
            display: flex; align-items: center; justify-content: center;
        }
        html.dark .ind-card .cover-wrapper { background: #0f172a; }
        .ind-card .cover-wrapper img { width: 100%; height: 100%; object-fit: cover; }

        .input-modern { width: 100%; background: var(--bg-body); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; font-size: 14px; color: var(--text-main); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 12px; font-weight: 700; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); transition: transform 0.1s; border: none; }
        .btn-primary:active { transform: scale(0.97); }

        .day-tab { font-weight: 700; font-size: 10px; color: var(--text-muted); padding: 10px 0; border-radius: 10px; transition: all 0.2s; cursor: pointer; text-transform: uppercase; }
        .day-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        
        .route-item { display: flex; align-items: center; padding: 14px; border-bottom: 1px solid var(--border); transition: background 0.15s; cursor: pointer; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .cal-day { aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; color: var(--text-muted); border: 1px solid transparent; cursor: pointer; }
        .cal-day.active { background: rgba(59, 130, 246, 0.15); color: var(--primary); border-color: var(--primary); }
        .cal-day.today { border-color: var(--primary); color: var(--primary); font-weight: 800; }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fade-in 0.2s forwards; }
        
        /* === ESTADO DE SELEÇÃO === */
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .photo-thumb { 
            aspect-ratio: 1; overflow: hidden; border-radius: 12px; 
            background: var(--border); position: relative; cursor: pointer; 
            border: 3px solid transparent; transition: all 0.2s;
        }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .photo-thumb.selected { border-color: #3b82f6 !important; transform: scale(0.94); }
        .photo-thumb.selected::before { content: ""; position: absolute; inset: 0; background: rgba(37, 99, 235, 0.35); z-index: 5; }
        .photo-thumb.selected::after {
            content: "\f058"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 32px; z-index: 10;
        }

        .fixed-bar-anim { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden-bar { transform: translateY(150%); }

        /* === DOCK E HEADER ALINHAMENTOS === */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: calc(70px + var(--safe-bottom));
            background: var(--bg-glass); backdrop-filter: blur(20px); border-top: 1px solid var(--border);
            z-index: 50; display: flex; align-items: stretch;
            padding-bottom: var(--safe-bottom);
        }

        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); font-size: 10px; font-weight: 700; transition: all 0.2s; cursor: pointer; }
        .nav-btn i { font-size: 20px; margin-bottom: 4px; }
        .nav-btn.active { color: var(--primary); }
        
        .loader { border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid #3b82f6; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .time-input { background: var(--bg-body); border: 1px solid var(--border); border-radius: 8px; padding: 4px; font-size: 12px; width: 75px; text-align: center; font-weight: bold; }
    </style>
</head>
<body class="antialiased">

    <!-- Header Corrigido -->
    <header class="fixed top-0 w-full h-16 glass z-50 flex items-center justify-between px-4 shadow-sm transition-colors duration-300">
        <div class="flex items-center gap-3 overflow-hidden">
            <button id="backBtn" onclick="AppCore.goBack()" class="hidden w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex-shrink-0 flex items-center justify-center active:scale-90 shadow-sm transition-colors"><i class="fas fa-chevron-left text-sm"></i></button>
            <div class="overflow-hidden">
                <h1 id="pageTitle" class="font-bold text-base truncate leading-tight">Industrial Manager</h1>
                <p id="pageSubtitle" class="text-[10px] font-medium text-slate-500 uppercase truncate">Principal</p>
            </div>
        </div>
        <div class="flex items-center gap-2 flex-shrink-0 ml-2">
            <button onclick="AppUtils.toggleDarkMode()" class="w-9 h-9 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-yellow-400 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 transition shadow-sm"><i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i></button>
            <button id="configRouteBtn" onclick="AppUI.modals.openRouteConfig()" class="w-9 h-9 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-500 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 shadow-sm"><i class="fas fa-sliders-h"></i></button>
            <button id="selectBtn" onclick="AppCore.toggleSelectionMode()" class="hidden px-3 h-9 rounded-lg bg-slate-100 dark:bg-slate-800 text-blue-600 dark:text-blue-400 text-[10px] font-bold uppercase border border-slate-200 dark:border-slate-700 transition">Select</button>
            <button id="editIndBtn" onclick="AppUI.modals.openEditIndustry()" class="hidden w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-blue-600 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 shadow-sm"><i class="fas fa-pen text-xs"></i></button>
        </div>
    </header>

    <div class="h-16"></div>

    <main class="max-w-md mx-auto px-4 pb-24 pt-4">

        <!-- VIEW 1: HOJE -->
        <div id="view-home" class="view-section active">
            <div class="grid grid-cols-2 gap-3 mb-6 text-center">
                <div class="card-modern p-4 bg-gradient-to-br from-blue-500/5 to-transparent border-blue-100 dark:border-blue-900/30">
                    <div class="text-2xl font-black text-blue-600" id="dashTotalInd">0</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="dashCountLabel">Locais</div>
                </div>
                <div class="card-modern p-4">
                    <div class="text-2xl font-black text-slate-800 dark:text-white" id="dashWorkLoad">00:00h</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="dashWorkLabel">Carga Diária</div>
                </div>
            </div>

            <div id="visitAlerts" onclick="AppUI.modals.openLateAlerts()" class="hidden mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 rounded-2xl flex items-center gap-3 active:scale-95 cursor-pointer shadow-sm">
                <div class="w-10 h-10 bg-red-100 dark:bg-red-800/40 text-red-600 dark:text-red-400 rounded-full flex items-center justify-center flex-shrink-0"><i class="fas fa-bell"></i></div>
                <div class="flex-1 text-left overflow-hidden">
                    <p class="text-[11px] font-bold text-red-800 dark:text-red-400 uppercase">Atraso detetado</p>
                    <p class="text-[10px] text-red-600 dark:text-red-500/80 truncate" id="visitAlertMsg">Verifique locais pendentes.</p>
                </div>
                <i class="fas fa-chevron-right text-red-300 text-xs"></i>
            </div>

            <div class="grid grid-cols-7 gap-1 mb-3" id="routeTabsContainer"></div>
            <div class="card-modern min-h-[300px] flex flex-col justify-start overflow-hidden" id="routeListContent">
                <div class="p-10 text-center text-slate-400"><div class="loader mx-auto mb-4"></div><p class="text-xs">A carregar...</p></div>
            </div>

            <button onclick="AppCore.openAllPhotos()" class="mt-6 w-full py-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 font-bold text-xs uppercase shadow-sm active:scale-95 transition flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700">
                <i class="fas fa-layer-group text-lg"></i> Feed Global
            </button>
        </div>

        <!-- VIEW 2: PARTILHA -->
        <div id="view-reports" class="view-section">
            <div class="text-center py-6 mb-4">
                <div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fas fa-paper-plane"></i></div>
                <h2 class="text-lg font-bold">Relatório Diário</h2>
                <p class="text-xs text-slate-500 mt-1">Envie os registos de hoje via WhatsApp.</p>
            </div>
            <div class="card-modern p-4 mb-6 space-y-4">
                <div>
                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Período de Seleção</label>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" id="reportStartDate" class="input-modern !py-2 !text-xs dark:bg-slate-800">
                        <input type="date" id="reportEndDate" class="input-modern !py-2 !text-xs dark:bg-slate-800">
                    </div>
                </div>
                <div><label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Nota da Mensagem</label><textarea id="shareCustomTextReports" rows="3" class="input-modern !py-2 !text-xs w-full resize-none dark:bg-slate-800" placeholder="Olá! Seguem os registos industriais..."></textarea></div>
            </div>
            <button onclick="AppCore.shareJpgFiles(true)" class="btn-primary w-full py-5 flex items-center justify-center gap-3 text-sm tracking-wide shadow-lg"><i class="fab fa-whatsapp text-xl"></i> ENVIAR JPG VIA WHATSAPP</button>
        </div>

        <!-- VIEW 3: LOCAIS (CATÁLOGO) -->
        <div id="view-routes" class="view-section">
            <div class="sticky top-16 z-30 bg-body/95 dark:bg-dark-bg/95 backdrop-blur-md py-2 transition-colors">
                <input type="text" id="searchInput" onkeyup="AppCore.filterIndustries()" placeholder="Pesquisar local..." class="input-modern pl-10 dark:bg-slate-800 dark:border-slate-700">
            </div>
            <div id="industriesList" class="grid grid-cols-3 gap-2 pb-20 mt-4"></div>
            <button onclick="AppUI.modals.openAddIndustry()" class="fixed bottom-28 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl active:scale-90 z-40 transition shadow-blue-500/30"><i class="fas fa-plus"></i></button>
        </div>

        <!-- VIEW 4: DATAS DO LOCAL -->
        <div id="view-dates" class="view-section">
            <div class="flex items-center justify-between mb-6 px-1">
                <button onclick="AppCore.changeCalendarMonth(-1)" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center dark:text-white"><i class="fas fa-chevron-left"></i></button>
                <span id="calendarTitle" class="text-base font-bold capitalize text-center flex-1">Mês</span>
                <button onclick="AppCore.changeCalendarMonth(1)" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center dark:text-white"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="card-modern p-4 mb-6 shadow-sm" id="calendarGrid"></div>
            <div class="grid grid-cols-2 gap-4">
                <label class="btn-primary py-5 flex flex-col items-center justify-center gap-2 cursor-pointer shadow-blue-500/20"><i class="fas fa-camera text-2xl"></i><span class="text-[10px] font-bold">CÂMARA</span><input type="file" accept="image/*" capture="environment" class="hidden" onchange="AppCore.uploadPhoto(this)"></label>
                <label class="btn-primary py-5 flex flex-col items-center justify-center gap-2 cursor-pointer bg-slate-800 dark:bg-slate-700 shadow-slate-500/20"><i class="fas fa-images text-2xl"></i><span class="text-[10px] font-bold">GALERIA</span><input type="file" accept="image/*" class="hidden" onchange="AppCore.uploadPhoto(this)"></label>
            </div>
        </div>

        <!-- VIEW 5: GALERIA DATA -->
        <div id="view-gallery" class="view-section">
            <div id="photosContainer" class="photo-grid mb-6"></div>
            <div class="card-modern p-4 mb-4 shadow-sm"><label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Mensagem de Apoio</label><textarea id="galleryShareText" rows="2" class="input-modern !py-2 !text-xs w-full resize-none dark:bg-slate-800" placeholder="Escreva a mensagem para acompanhar as fotos..."></textarea></div>
            <button onclick="AppCore.shareJpgFiles(false)" class="btn-primary w-full py-4 flex items-center justify-center gap-3 text-xs tracking-wider shadow-blue-500/30 mb-20 active:scale-95 transition"><i class="fab fa-whatsapp text-lg"></i> ENVIAR SELECCIONADAS</button>
        </div>

        <!-- VIEW 6: FEED GLOBAL -->
        <div id="view-all" class="view-section"><div id="allPhotosContainer" class="pb-24 space-y-6"></div></div>

    </main>

    <!-- Barra Inferior Fixa Distribuída -->
    <nav id="mainNavBar" class="bottom-nav">
        <div id="nav-general" class="nav-btn active" onclick="AppCore.switchMainTab('general')"><i class="fas fa-home"></i><span>Início</span></div>
        <div id="nav-reports" class="nav-btn" onclick="AppCore.switchMainTab('reports')"><i class="fas fa-share-alt"></i><span>Enviar</span></div>
        <div id="nav-routes" class="nav-btn" onclick="AppCore.switchMainTab('routes')"><i class="fas fa-th-large"></i><span>Locais</span></div>
    </nav>

    <!-- Barra de Multi-Seleção -->
    <div id="selectionControls" class="fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t p-4 z-[60] fixed-bar-anim hidden-bar flex gap-2 shadow-lg">
        <button onclick="AppCore.selectAllPhotos()" class="px-4 h-12 rounded-xl bg-slate-100 dark:bg-slate-800 font-bold text-[10px] uppercase transition active:scale-95">Todas</button>
        <button onclick="AppCore.downloadSelectedPhotos()" class="w-12 h-12 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl flex items-center justify-center text-lg active:scale-95 transition"><i class="fas fa-download"></i></button>
        <button onclick="AppCore.deleteSelected()" class="w-12 h-12 bg-red-50 text-red-500 rounded-xl flex items-center justify-center text-xl active:scale-95 transition"><i class="fas fa-trash-alt"></i></button>
        <button onclick="AppCore.shareJpgFiles(false)" class="flex-1 h-12 bg-blue-600 text-white rounded-xl font-bold text-[10px] uppercase active:scale-95 transition">WhatsApp (<span id="selCount">0</span>)</button>
    </div>

    <!-- Modais -->
    <div id="routeConfigModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex flex-col justify-end sm:justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl h-[85vh] flex flex-col animate-slide-up">
            <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Agenda Semanal</h3>
            <div class="grid grid-cols-7 gap-1 mb-4" id="routeConfigDays"></div>
            <div id="currentConfigDay" class="text-[10px] font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded w-fit mb-3 uppercase tracking-widest">...</div>
            <div id="routeChecklist" class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scroll"></div>
            <div class="flex gap-3 mt-4 pt-4 border-t">
                <button onclick="AppUI.modals.closeRouteConfig()" class="flex-1 py-3.5 text-slate-400 font-bold text-xs">Fechar</button>
                <button onclick="AppCore.saveRouteConfig()" class="flex-1 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg">SALVAR</button>
            </div>
        </div>
    </div>

    <div id="addModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex flex-col justify-end sm:justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl animate-slide-up">
            <h3 id="modalTitle" class="text-lg font-bold mb-6">Registo Indústria</h3>
            <input type="hidden" id="editIndId">
            <div class="space-y-4 mb-6">
                <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Nome</label><input type="text" id="newIndName" class="input-modern mt-1 dark:bg-slate-800 dark:text-white"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Horas/Sem</label><input type="number" id="newIndHours" class="input-modern mt-1 text-center font-bold dark:bg-slate-800 dark:text-white"></div>
                    <div><label class="text-[10px] font-bold uppercase text-slate-400 ml-1">URL Imagem Capa</label><input type="text" id="newIndCover" class="input-modern mt-1 text-xs dark:bg-slate-800 dark:text-white" placeholder="https://..."></div>
                </div>
            </div>
            <button id="btnDeleteInd" onclick="AppCore.deleteCurrentIndustry()" class="w-full py-3 mb-3 text-red-500 font-bold text-xs bg-red-50 rounded-xl hidden border border-red-100">Eliminar Local</button>
            <div class="flex gap-3">
                <button onclick="AppUI.modals.closeAdd()" class="flex-1 py-3.5 text-slate-400 font-bold text-xs">Cancelar</button>
                <button onclick="AppCore.saveIndustry()" class="flex-1 btn-primary py-3.5 text-xs shadow-lg">GUARDAR</button>
            </div>
        </div>
    </div>

    <div id="photoModal" class="fixed inset-0 bg-black/95 z-[110] hidden flex flex-col justify-center items-center opacity-0 transition-opacity duration-300">
        <div class="absolute top-0 w-full p-4 flex justify-between z-20">
            <button onclick="AppUI.modals.closePhoto()" class="w-10 h-10 bg-white/10 rounded-full text-white flex items-center justify-center active:scale-90 transition"><i class="fas fa-times text-xl"></i></button>
            <button onclick="AppCore.deleteSinglePhoto()" class="w-10 h-10 bg-red-500/80 rounded-full text-white flex items-center justify-center active:scale-90 shadow-lg"><i class="fas fa-trash text-sm"></i></button>
        </div>
        <img id="previewImg" src="" class="max-h-[65vh] max-w-full object-contain mb-4 shadow-2xl">
        <div class="w-full max-w-sm px-6">
            <div class="bg-white/10 backdrop-blur-md p-1.5 rounded-2xl border border-white/20 flex gap-2">
                <input type="text" id="photoDescInput" placeholder="Anotação..." class="bg-transparent text-white text-sm flex-1 px-3 py-2 outline-none">
                <button onclick="AppCore.savePhotoDescription()" class="bg-blue-600 text-white px-4 rounded-xl font-bold text-xs active:scale-95 transition">OK</button>
            </div>
        </div>
    </div>

    <div id="statusToast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl shadow-slate-500/20 text-xs font-bold flex items-center gap-3 transition-all opacity-0 -translate-y-10 z-[130]"><div id="toastIcon"></div><span id="toastMsg">Notificação</span></div>

    <!-- SCRIPTS -->
    <script>
        const SUPABASE_URL = 'https://hluxaxbjdpbezvffisns.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsdXhheGJqZHBiZXp2ZmZpc25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTg3NDgsImV4cCI6MjA4MDU5NDc0OH0.lia_McknZ7SD2EGlNchRVZ9d359bFkk7hSJXJYhJzig';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const BUCKET = 'galeria';
        const WEEK_DAYS = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];

        const AppState = {
            currentIndustry: null, industryPhotos: [], allIndustries: [], lateIndustries: [],
            routes: { 'Domingo': [], 'Segunda': [], 'Terça': [], 'Quarta': [], 'Quinta': [], 'Sexta': [], 'Sábado': [] },
            isSelectionMode: false, selectedPhotos: new Set(),
            calendarCursor: new Date(), availableDates: new Set(),
            viewSelectedDay: null, viewHistory: []
        };

        const AppUtils = {
            minutesToHM: (m) => `${String(Math.floor(m / 60)).padStart(2,'0')}:${String(m % 60).padStart(2,'0')}`,
            hmToMinutes: (hm) => hm ? hm.split(':').map(Number).reduce((h, m) => h * 60 + m) : 0,
            sanitize: (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_"),
            showToast: (msg, type = 'loading') => {
                const toast = document.getElementById('statusToast'); const msgEl = document.getElementById('toastMsg'); if(!toast || !msgEl) return;
                msgEl.innerText = msg; toast.classList.remove('opacity-0', '-translate-y-10'); const icon = document.getElementById('toastIcon');
                if (type === 'success') icon.innerHTML = '<i class="fas fa-check text-green-400"></i>'; else if (type === 'error') icon.innerHTML = '<i class="fas fa-times text-red-400"></i>'; else icon.innerHTML = '<div class="loader !border-t-white"></div>';
                setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 2500);
            },
            toggleDarkMode: () => { 
                document.documentElement.classList.toggle('dark'); 
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                document.querySelector('meta[name="theme-color"]').setAttribute('content', isDark ? '#0f172a' : '#2563eb');
            }
        };

        const AppCore = {
            init: async () => {
                const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'dark') document.documentElement.classList.add('dark');
                const now = new Date(); const todayIso = now.toISOString().split('T')[0];
                if(document.getElementById('reportStartDate')) document.getElementById('reportStartDate').value = todayIso;
                if(document.getElementById('reportEndDate')) document.getElementById('reportEndDate').value = todayIso;

                try {
                    await Promise.all([AppCore.loadIndustries(), AppCore.fetchRoutes()]);
                    const today = WEEK_DAYS[now.getDay()];
                    AppState.viewSelectedDay = today;
                    AppUI.renderRouteList(today);
                    AppUI.updateDashboard();
                    AppCore.checkAlerts();
                } catch (e) { AppUtils.showToast("Falha ao carregar dados", "error"); }
            },
            loadIndustries: async () => {
                const { data } = await sb.from('industrias').select('*').order('nome');
                AppState.allIndustries = data || [];
                AppUI.renderIndustries(AppState.allIndustries);
            },
            fetchRoutes: async () => {
                const { data } = await sb.from('rotas').select('*');
                if (data) data.forEach(r => AppState.routes[r.dia] = r.industrias || []);
            },
            uploadPhoto: async (input) => {
                const f = input.files[0]; if (!f || !AppState.currentIndustry) return;
                AppUtils.showToast("A processar...");
                try {
                    const safeName = AppUtils.sanitize(AppState.currentIndustry.nome);
                    const now = new Date(); const targetDate = AppState.currentDateFolder || now.toLocaleDateString('pt-PT').replace(/\//g, '-');
                    const fileName = `${safeName}/${targetDate}/FOTO_${now.getTime()}.jpg`;
                    await sb.storage.from(BUCKET).upload(fileName, f, { contentType: 'image/jpeg' });
                    const { data: urlData } = sb.storage.from(BUCKET).getPublicUrl(fileName);
                    await sb.from('fotos').insert({ created_at: now.toISOString(), nome_arquivo: fileName, url_publica: urlData.publicUrl, industria_id: AppState.currentIndustry.id, descricao: '' }).select();
                    AppUtils.showToast("Guardado!", "success"); await AppCore.loadDates(AppState.currentIndustry.nome);
                    if (document.getElementById('view-gallery').classList.contains('active')) AppUI.loadGalleryPhotos();
                    AppCore.checkAlerts();
                } catch (e) { AppUtils.showToast("Erro no envio", "error"); } finally { input.value = ''; }
            },
            loadDates: async (name) => {
                const safe = AppUtils.sanitize(name);
                const { data } = await sb.from('fotos').select('*').like('nome_arquivo', `${safe}/%`).order('created_at', { ascending: false });
                AppState.industryPhotos = data || []; AppState.availableDates.clear();
                AppState.industryPhotos.forEach(p => AppState.availableDates.add(new Date(p.created_at).toLocaleDateString('pt-PT')));
                AppUI.renderCalendar();
            },
            changeCalendarMonth: (o) => { AppState.calendarCursor.setMonth(AppState.calendarCursor.getMonth() + o); AppUI.renderCalendar(); },
            checkAlerts: async () => {
                const { data } = await sb.from('fotos').select('industria_id, created_at').order('created_at', { ascending: false });
                const lastVisits = {}; data?.forEach(f => { if(!lastVisits[f.industria_id]) lastVisits[f.industria_id] = new Date(f.created_at); });
                const threshold = new Date(); threshold.setDate(threshold.getDate() - 7);
                AppState.lateIndustries = AppState.allIndustries.filter(i => !lastVisits[i.id] || lastVisits[i.id] < threshold);
                const alertEl = document.getElementById('visitAlerts');
                if(AppState.lateIndustries.length > 0) {
                    if(alertEl) alertEl.classList.remove('hidden');
                    const msgEl = document.getElementById('visitAlertMsg'); if(msgEl) msgEl.innerText = `${AppState.lateIndustries.length} locais sem visitas há mais de 7 dias.`;
                } else if(alertEl) alertEl.classList.add('hidden');
            },
            downloadSelectedPhotos: async () => {
                const selected = AppState.industryPhotos.filter(f => AppState.selectedPhotos.has(f.id));
                if(selected.length === 0) return AppUtils.showToast("Nada selecionado", "error");
                AppUtils.showToast("A baixar...", "loading");
                for(const photo of selected) { const a = document.createElement('a'); a.href = photo.url_publica; a.download = `Industrial_${photo.id.substring(0,4)}.jpg`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
                AppUtils.showToast("Concluído!", "success");
            },
            shareJpgFiles: async (isReportsTab) => {
                const customMsg = isReportsTab ? document.getElementById('shareCustomTextReports').value : document.getElementById('galleryShareText').value;
                const start = isReportsTab ? document.getElementById('reportStartDate').value : null;
                const end = isReportsTab ? document.getElementById('reportEndDate').value : null;
                AppUtils.showToast("A processar fotos...", "loading");
                try {
                    let photosToShare = [];
                    if(isReportsTab) { const { data } = await sb.from('fotos').select('*').gte('created_at', `${start}T00:00:00Z`).lte('created_at', `${end}T23:59:59Z`); photosToShare = data || []; }
                    else { photosToShare = AppState.industryPhotos.filter(f => AppState.selectedPhotos.has(f.id)); if(photosToShare.length === 0) photosToShare = AppState.industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-PT') === AppState.currentDateFolder); }
                    if(photosToShare.length === 0) return AppUtils.showToast("Sem fotos", "error");
                    const files = []; for(const p of photosToShare) { const blob = await fetch(p.url_publica).then(r => r.blob()); files.push(new File([blob], `Ind_${p.id.substring(0,4)}.jpg`, { type: 'image/jpeg' })); }
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: files })) {
                        await navigator.share({ files: files, title: 'Registos', text: customMsg || "Registos Industriais." }); AppUtils.showToast("Enviado!", "success");
                    } else {
                        AppUtils.showToast("A baixar e abrir WhatsApp...", "error");
                        for(const f of files) { const a = document.createElement('a'); a.href = URL.createObjectURL(f); a.download = f.name; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
                        setTimeout(() => window.open(`https://wa.me/?text=${encodeURIComponent((customMsg || "Segue o relatório.") + " (Anexe as fotos baixadas manualmente)")}`, '_blank'), 1500);
                    }
                } catch(e) { AppUtils.showToast("Erro na partilha", "error"); }
            },
            saveIndustry: async () => {
                const id = document.getElementById('editIndId').value;
                const name = document.getElementById('newIndName').value.trim();
                const hours = parseInt(document.getElementById('newIndHours').value) || 0;
                const cover = document.getElementById('newIndCover').value.trim();
                if(!name || !confirm("Gravar?")) return;
                const payload = { nome: name, carga_semanal: hours, cover_url: cover || null };
                if(id) await sb.from('industrias').update(payload).eq('id', id).select();
                else await sb.from('industrias').insert(payload).select();
                AppUI.modals.closeAdd(); AppCore.loadIndustries(); AppUtils.showToast("Guardado!", "success");
            },
            savePhotoDescription: async () => {
                if(!AppState.currentModalPhoto) return;
                const desc = document.getElementById('photoDescInput').value;
                await sb.from('fotos').update({ descricao: desc }).eq('id', AppState.currentModalPhoto.id).select();
                AppState.currentModalPhoto.descricao = desc; AppUtils.showToast("Salvo", "success"); AppUI.loadGalleryPhotos();
            },
            saveRouteConfig: async () => {
                if(!confirm("Gravar planeamento?")) return; AppUtils.showToast("A guardar...");
                await sb.from('rotas').upsert({ dia: AppState.configSelectedDay, industrias: AppState.routes[AppState.configSelectedDay] }, { onConflict: 'dia' }).select();
                if (AppState.configSelectedDay === AppState.viewSelectedDay) AppUI.renderRouteList(AppState.configSelectedDay);
                AppUI.modals.closeRouteConfig(); AppUI.updateDashboard(); AppUtils.showToast("Salvo!", "success");
            },
            switchMainTab: (t) => { AppState.viewHistory = []; const m = { general: 'view-home', reports: 'view-reports', routes: 'view-routes' }; AppUI.navigateTo(m[t], false); },
            goBack: () => { AppUI.navigateTo(AppState.viewHistory.pop() || 'view-home', false); },
            toggleSelectionMode: () => {
                AppState.isSelectionMode = !AppState.isSelectionMode; const b = document.getElementById('selectBtn');
                if (AppState.isSelectionMode) { b.innerText = "Cancelar"; b.classList.add('text-red-500'); document.getElementById('selectionControls').classList.remove('hidden-bar'); } 
                else { b.innerText = "Select"; b.classList.remove('text-red-500'); document.getElementById('selectionControls').classList.add('hidden-bar'); AppState.selectedPhotos.clear(); }
                AppUI.loadGalleryPhotos(); if(document.getElementById('view-all').classList.contains('active')) AppCore.openAllPhotos();
            },
            handlePhotoClick: (f) => {
                if (AppState.isSelectionMode) { 
                    if (AppState.selectedPhotos.has(f.id)) AppState.selectedPhotos.delete(f.id); else AppState.selectedPhotos.add(f.id); 
                    document.getElementById('selCount').innerText = AppState.selectedPhotos.size; AppUI.loadGalleryPhotos(); 
                    if(document.getElementById('view-all').classList.contains('active')) AppCore.openAllPhotos();
                } else { AppState.currentModalPhoto = f; AppUI.modals.openPhoto(f); }
            },
            filterIndustries: () => { const term = document.getElementById('searchInput').value.toLowerCase(); const filtered = AppState.allIndustries.filter(i => i.nome.toLowerCase().includes(term)); AppUI.renderIndustries(filtered); },
            selectAllPhotos: () => { const isAll = document.getElementById('view-all').classList.contains('active'); if(!isAll) AppState.industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-PT') === AppState.currentDateFolder).forEach(f => AppState.selectedPhotos.add(f.id)); document.getElementById('selCount').innerText = AppState.selectedPhotos.size; AppUI.loadGalleryPhotos(); },
            deleteSelected: async () => { if(!confirm("Eliminar fotos?")) return; await sb.from('fotos').delete().in('id', Array.from(AppState.selectedPhotos)); AppState.selectedPhotos.clear(); AppCore.toggleSelectionMode(); if(AppState.currentIndustry) AppCore.loadDates(AppState.currentIndustry.nome); },
            deleteSinglePhoto: async () => { if(!confirm("Eliminar?")) return; await sb.from('fotos').delete().eq('id', AppState.currentModalPhoto.id); AppUI.modals.closePhoto(); if(AppState.currentIndustry) AppCore.loadDates(AppState.currentIndustry.nome); AppUI.loadGalleryPhotos(); },
            openAllPhotos: async () => {
                AppUI.navigateTo('view-all'); const c = document.getElementById('allPhotosContainer'); if(!c.hasChildNodes()) c.innerHTML = '<div class="col-span-3 py-20 flex justify-center"><div class="loader"></div></div>';
                const { data } = await sb.from('fotos').select('*').order('created_at', { ascending: false }).limit(60); c.innerHTML = '';
                const groups = {}; data?.forEach(f => { const d = new Date(f.created_at).toLocaleDateString('pt-PT'); if(!groups[d]) groups[d] = []; groups[d].push(f); });
                Object.keys(groups).forEach(dateStr => {
                    const h = document.createElement('div'); h.className = 'w-full mt-6 px-1 border-b border-slate-100 dark:border-slate-800 pb-1 text-left'; h.innerHTML = `<span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${dateStr}</span>`; c.appendChild(h);
                    const grid = document.createElement('div'); grid.className = 'photo-grid w-full';
                    groups[dateStr].forEach(f => { const d = document.createElement('div'); d.className = `photo-thumb ${AppState.selectedPhotos.has(f.id) ? 'selected' : ''}`; d.onclick = () => AppCore.handlePhotoClick(f); d.innerHTML = `<img src="${f.url_publica}" loading="lazy">`; grid.appendChild(d); });
                    c.appendChild(grid);
                });
            }
        };

        const AppUI = {
            navigateTo: (id, hist = true) => {
                const active = document.querySelector('.view-section.active'); if (hist && active) AppState.viewHistory.push(active.id);
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active');
                const show = (el, s) => { const e = document.getElementById(el); if(e) e.classList.toggle('hidden', !s); };
                show('backBtn', !['view-home', 'view-routes', 'view-reports'].includes(id)); show('configRouteBtn', id === 'view-home'); show('selectBtn', ['view-routes', 'view-gallery', 'view-all'].includes(id)); show('editIndBtn', id === 'view-dates');
                document.getElementById('mainNavBar').classList.toggle('hidden-nav', !['view-home', 'view-routes', 'view-reports'].includes(id));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const navMap = { 'view-home': 'general', 'view-routes': 'routes', 'view-reports': 'reports' };
                if(navMap[id]) document.getElementById('nav-' + navMap[id]).classList.add('active');
                if(id === 'view-reports') AppUI.renderDailyIndustries();
            },
            updateDashboard: () => {
                const day = AppState.viewSelectedDay || WEEK_DAYS[new Date().getDay()]; const route = AppState.routes[day] || [];
                let totalMins = 0; route.forEach(i => totalMins += (i.minutos || 0));
                document.getElementById('dashTotalInd').innerText = route.length;
                document.getElementById('dashWorkLoad').innerText = AppUtils.minutesToHM(totalMins) + 'h';
                document.getElementById('dashCountLabel').innerText = `Locais ${day}`;
                document.getElementById('dashWorkLabel').innerText = `Carga ${day}`;
            },
            renderIndustries: (list) => {
                const c = document.getElementById('industriesList'); if(!c) return; c.innerHTML = '';
                list.forEach(ind => {
                    const d = document.createElement('div'); d.className = `ind-card border dark:border-slate-700`;
                    d.onclick = () => { AppState.currentIndustry = ind; AppState.calendarCursor = new Date(); AppUI.navigateTo('view-dates'); AppCore.loadDates(ind.nome); };
                    const coverEl = ind.cover_url ? `<img src="${ind.cover_url}">` : '<i class="fas fa-industry text-2xl text-slate-300"></i>';
                    d.innerHTML = `<div class="cover-wrapper">${coverEl}</div><h3 class="font-bold text-[10px] text-center truncate w-full px-1 dark:text-white">${ind.nome}</h3><span class="text-[8px] text-slate-400 font-bold uppercase">${ind.carga_semanal || 0}H/SEM</span>`;
                    c.appendChild(d);
                });
            },
            renderRouteList: (day) => {
                const c = document.getElementById('routeListContent'); if(!c) return; c.innerHTML = '';
                const tabs = document.getElementById('routeTabsContainer'); if(!tabs) return; tabs.innerHTML = '';
                WEEK_DAYS.forEach(d => {
                    const t = document.createElement('div'); t.innerText = d.substring(0, 3); t.className = `day-tab ${d === day ? 'active' : ''}`;
                    t.onclick = () => { AppState.viewSelectedDay = d; AppUI.renderRouteList(d); AppUI.updateDashboard(); }; tabs.appendChild(t);
                });
                const items = AppState.routes[day] || [];
                if(items.length === 0) { c.innerHTML = '<div class="py-16 flex flex-col items-center justify-center text-slate-300"><i class="fas fa-calendar-check text-4xl mb-3"></i><p class="text-[10px] uppercase font-bold">Dia Livre</p></div>'; return; }
                items.forEach(item => {
                    const ind = AppState.allIndustries.find(i => i.nome === (item.nome || item)); if(!ind) return;
                    const row = document.createElement('div'); row.className = 'route-item hover:bg-slate-50 dark:hover:bg-slate-800/50';
                    row.onclick = () => { AppState.currentIndustry = ind; AppUI.navigateTo('view-dates'); AppCore.loadDates(ind.nome); };
                    row.innerHTML = `<div class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-800 flex items-center justify-center mr-3"><i class="fas fa-industry text-slate-300"></i></div><div class="flex-1 overflow-hidden text-left"><div class="font-bold text-sm truncate dark:text-white">${ind.nome}</div></div><div class="text-xs font-mono font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded-lg">${AppUtils.minutesToHM(item.minutos || 0)}h</div>`;
                    c.appendChild(row);
                });
            },
            renderCalendar: () => {
                const c = document.getElementById('calendarGrid'); if(!c) return;
                c.innerHTML = '<div class="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] font-bold text-slate-400 uppercase"><span>D</span><span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span></div>';
                const grid = document.createElement('div'); grid.className = 'cal-grid';
                const title = document.getElementById('calendarTitle'); if(title) title.innerText = new Date(AppState.calendarCursor.getFullYear(), AppState.calendarCursor.getMonth()).toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
                const first = new Date(AppState.calendarCursor.getFullYear(), AppState.calendarCursor.getMonth(), 1).getDay();
                const days = new Date(AppState.calendarCursor.getFullYear(), AppState.calendarCursor.getMonth() + 1, 0).getDate();
                for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
                for(let d=1; d<=days; d++) {
                    const dateStr = new Date(AppState.calendarCursor.getFullYear(), AppState.calendarCursor.getMonth(), d).toLocaleDateString('pt-PT');
                    const b = document.createElement('div'); b.className = `cal-day ${AppState.availableDates.has(dateStr) ? 'active' : ''}`; b.innerText = d;
                    if(AppState.availableDates.has(dateStr)) b.onclick = () => { AppState.currentDateFolder = dateStr; AppUI.navigateTo('view-gallery'); AppUI.loadGalleryPhotos(); };
                    grid.appendChild(b);
                }
                c.appendChild(grid);
            },
            loadGalleryPhotos: () => {
                const c = document.getElementById('photosContainer'); if(!c) return; c.innerHTML = '';
                const p = AppState.industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-PT') === AppState.currentDateFolder);
                p.forEach(f => { const d = document.createElement('div'); d.className = `photo-thumb ${AppState.selectedPhotos.has(f.id) ? 'selected' : ''}`; d.onclick = () => AppCore.handlePhotoClick(f); d.innerHTML = `<img src="${f.url_publica}" loading="lazy">`; c.appendChild(d); });
            },
            renderDailyIndustries: () => {
                const c = document.getElementById('dailyIndustriesList'); if(!c) return; c.innerHTML = '';
                const today = WEEK_DAYS[new Date().getDay()]; const items = AppState.routes[today] || [];
                items.forEach(item => { const d = document.createElement('div'); d.className = 'flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border dark:border-slate-700'; d.innerHTML = `<span class="text-sm font-bold dark:text-white text-left">${item.nome || item}</span><i class="fas fa-check-circle text-blue-500"></i>`; c.appendChild(d); });
            },
            renderRouteChecklist: () => {
                const l = document.getElementById('routeChecklist'); if(!l) return; l.innerHTML = '';
                const day = AppState.configSelectedDay || 'Segunda';
                AppState.allIndustries.forEach(ind => {
                    const item = AppState.routes[day]?.find(r => (r.nome || r) === ind.nome);
                    const d = document.createElement('div'); d.className = 'flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700';
                    d.innerHTML = `<input type="checkbox" ${item?'checked':''} onchange="AppUI.toggleRouteCheck('${ind.nome.replace(/'/g, "\\'")}', this.checked)"><span class="flex-1 text-xs font-bold truncate dark:text-white text-left">${ind.nome}</span><input type="time" class="time-input dark:bg-slate-700 dark:text-white" value="${AppUtils.minutesToHM(item?.minutos || 0)}" onchange="AppUI.updateRouteMins('${ind.nome.replace(/'/g, "\\'")}', this.value)">`;
                    l.appendChild(d);
                });
            },
            toggleRouteCheck: (name, checked) => {
                const day = AppState.configSelectedDay; if(!AppState.routes[day]) AppState.routes[day] = [];
                if(checked) AppState.routes[day].push({ nome: name, minutos: 0 }); else AppState.routes[day] = AppState.routes[day].filter(r => (r.nome || r) !== name);
                AppUI.renderRouteChecklist();
            },
            updateRouteMins: (name, val) => { const item = AppState.routes[AppState.configSelectedDay]?.find(r => (r.nome || r) === name); if(item) item.minutos = AppUtils.hmToMinutes(val); },
            modals: {
                openLateAlerts: () => {
                    document.getElementById('lateAlertsModal').classList.remove('hidden'); const c = document.getElementById('lateIndustriesList'); if(!c) return; c.innerHTML = '';
                    AppState.lateIndustries.forEach(ind => {
                        const d = document.createElement('div'); d.className = 'flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border dark:border-slate-700 cursor-pointer active:scale-95 transition-transform';
                        d.onclick = () => { AppState.currentIndustry = ind; AppCore.loadDates(ind.nome); AppUI.navigateTo('view-dates'); AppUI.modals.closeLateAlerts(); };
                        d.innerHTML = `<span class="text-sm font-bold dark:text-white">${ind.nome}</span><i class="fas fa-history text-red-400"></i>`; c.appendChild(d);
                    });
                },
                closeLateAlerts: () => document.getElementById('lateAlertsModal')?.classList.add('hidden'),
                openRouteConfig: () => { 
                    AppState.configSelectedDay = WEEK_DAYS[new Date().getDay()]; document.getElementById('routeConfigModal').classList.remove('hidden');
                    const c = document.getElementById('routeConfigDays'); if(!c) return; c.innerHTML = '';
                    WEEK_DAYS.forEach(d => {
                        const b = document.createElement('button'); b.innerText = d.substring(0,1);
                        b.className = `p-2.5 rounded-lg text-[10px] font-black ${d === AppState.configSelectedDay ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-50 dark:bg-slate-800 text-slate-400'}`;
                        b.onclick = () => { AppState.configSelectedDay = d; AppUI.modals.updateRouteConfigUI(); }; c.appendChild(b);
                    });
                    document.getElementById('currentConfigDay').innerText = AppState.configSelectedDay; AppUI.renderRouteChecklist();
                },
                updateRouteConfigUI: () => {
                    const day = AppState.configSelectedDay;
                    document.querySelectorAll('#routeConfigDays button').forEach((btn, idx) => { btn.className = `p-2.5 rounded-lg text-[10px] font-black transition ${WEEK_DAYS[idx] === day ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-50 dark:bg-slate-800'}`; });
                    document.getElementById('currentConfigDay').innerText = day; AppUI.renderRouteChecklist();
                },
                closeRouteConfig: () => document.getElementById('routeConfigModal')?.classList.add('hidden'),
                openAddIndustry: () => { document.getElementById('addModal').classList.remove('hidden'); document.getElementById('editIndId').value=""; document.getElementById('newIndName').value=""; document.getElementById('newIndHours').value=""; document.getElementById('newIndCover').value=""; },
                openEditIndustry: () => { if(!AppState.currentIndustry) return; AppUI.modals.openAddIndustry(); document.getElementById('modalTitle').innerText="Editar Local"; document.getElementById('editIndId').value = AppState.currentIndustry.id; document.getElementById('newIndName').value = AppState.currentIndustry.nome; document.getElementById('newIndHours').value = AppState.currentIndustry.carga_semanal; document.getElementById('newIndCover').value = AppState.currentIndustry.cover_url || ""; },
                closeAdd: () => document.getElementById('addModal')?.classList.add('hidden'),
                openPhoto: (f) => { document.getElementById('previewImg').src = f.url_publica; document.getElementById('photoDescInput').value = f.descricao || ''; const m = document.getElementById('photoModal'); if(m) { m.classList.remove('hidden'); setTimeout(() => m.classList.add('opacity-100'), 10); } },
                closePhoto: () => { const m = document.getElementById('photoModal'); if(m) { m.classList.remove('opacity-100'); setTimeout(() => m.classList.add('hidden'), 300); } }
            }
        };

        window.onload = AppCore.init;
    </script>
</body>
</html>

