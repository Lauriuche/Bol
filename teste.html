<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>Gestor Industrial Pro</title>
    
    <!-- PWA Meta Tags -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4300/4300058.png">
    <link rel="manifest" href="data:application/manifest+json,{'name':'Gestor Industrial Pro','short_name':'IndustrialPro','start_url':'.','display':'standalone','background_color':'#ffffff','theme_color':'#2563eb'}">

    <!-- Depend√™ncias Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9', border: '#334155', muted: '#94a3b8' },
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.2s ease-out', 'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)' }
                } 
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* === VARI√ÅVEIS & RESET === */
        :root {
            --bg-body: #f8fafc; --bg-card: #ffffff; --bg-glass: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
            --primary: #3b82f6; --safe-bottom: env(safe-area-inset-bottom);
        }
        html.dark :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-glass: rgba(15, 23, 42, 0.95);
            --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155;
        }
        
        body { 
            font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main);
            padding-bottom: calc(100px + var(--safe-bottom)); 
            -webkit-tap-highlight-color: transparent; user-select: none;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        .glass { background: var(--bg-glass); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); }
        .card-modern { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        .ind-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
            padding: 6px; aspect-ratio: 1/1; display: flex; flex-direction: column; 
            justify-content: space-between; position: relative; overflow: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .ind-card:active { transform: scale(0.96); }
        .ind-card.selected-item { border: 2.3px solid var(--primary); background-color: rgba(59, 130, 246, 0.05); } 

        .ind-card .cover-wrapper { width: 100%; flex: 1; border-radius: 8px; overflow: hidden; background: var(--bg-body); position: relative; margin-bottom: 4px; }
        .ind-card img { width: 100%; height: 100%; object-fit: cover; }

        .input-modern { width: 100%; background: var(--bg-body); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; font-size: 14px; color: var(--text-main); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 12px; font-weight: 700; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); transition: transform 0.1s; border: none; }
        .btn-primary:active { transform: scale(0.97); }

        .day-tab { font-weight: 700; font-size: 10px; color: var(--text-muted); padding: 10px 0; border-radius: 10px; transition: all 0.2s; cursor: pointer; text-transform: uppercase; display: flex; justify-content: center; align-items: center; }
        .day-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        
        .route-item { display: flex; align-items: center; padding: 14px; border-bottom: 1px solid var(--border); transition: background 0.15s; cursor: pointer; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .cal-day { aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; color: var(--text-muted); transition: all 0.2s; border: 1px solid transparent; cursor: pointer; }
        .cal-day.active { background: rgba(59, 130, 246, 0.15); color: var(--primary); border-color: var(--primary); }
        .cal-day.today { border-color: var(--primary); color: var(--primary); font-weight: 800; }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fade-in 0.2s forwards; }
        
        /* === ESTILO DE SELE√á√ÉO DE FOTO CORRIGIDO === */
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .photo-thumb { 
            aspect-ratio: 1; overflow: hidden; border-radius: 12px; 
            background: var(--border); position: relative; cursor: pointer; 
            border: 3px solid transparent; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; transition: all 0.3s; }
        
        .photo-thumb.selected { border-color: #3b82f6; transform: scale(0.95); box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .photo-thumb.selected img { opacity: 0.4; filter: grayscale(30%); }
        .photo-thumb.selected::after {
            content: "\f058"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #3b82f6; font-size: 24px; z-index: 10;
        }

        .fixed-bar-anim { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden-bar { transform: translateY(150%); }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: calc(65px + var(--safe-bottom));
            background: var(--bg-glass); backdrop-filter: blur(20px); border-top: 1px solid var(--border);
            z-index: 50; display: flex; justify-content: space-around; align-items: center;
            padding-bottom: var(--safe-bottom);
        }

        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; color: var(--text-muted); font-size: 10px; font-weight: 700; transition: all 0.2s; cursor: pointer; }
        .nav-btn.active { color: var(--primary); }
        
        .loader { border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid #3b82f6; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        html.dark .card-modern { background: #1e293b; border-color: #334155; }
        html.dark .input-modern, html.dark textarea { background: #0f172a; border-color: #334155; color: #f1f5f9; }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="fixed top-0 w-full h-16 glass z-50 flex items-center justify-between px-4 shadow-sm transition-colors duration-300">
        <div class="flex items-center gap-3 w-3/4">
            <button id="backBtn" onclick="AppCore.goBack()" class="hidden w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex items-center justify-center active:scale-90 shadow-sm flex-shrink-0 transition-colors"><i class="fas fa-chevron-left text-sm"></i></button>
            <div class="overflow-hidden">
                <h1 id="pageTitle" class="font-bold text-base truncate leading-tight transition-colors">Industrial Pro</h1>
                <p id="pageSubtitle" class="text-[10px] font-medium text-slate-500 uppercase truncate tracking-wider">Vis√£o Geral</p>
            </div>
        </div>
        <div class="flex gap-2 flex-shrink-0">
            <button onclick="AppUtils.toggleDarkMode()" class="w-9 h-9 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-500 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 transition shadow-sm"><i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline text-yellow-400"></i></button>
            <button id="configRouteBtn" onclick="AppUI.modals.openRouteConfig()" class="w-9 h-9 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-500 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 transition shadow-sm"><i class="fas fa-sliders-h"></i></button>
            <button id="selectBtn" onclick="AppCore.toggleSelectionMode()" class="hidden px-3 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-800 text-blue-600 dark:text-blue-400 text-[10px] font-bold uppercase border border-slate-200 dark:border-slate-700 transition">Select</button>
            <button id="editIndBtn" onclick="AppUI.modals.openEditIndustry()" class="hidden w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-blue-600 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 shadow-sm"><i class="fas fa-pen text-xs"></i></button>
        </div>
    </header>

    <div class="h-16"></div>

    <!-- MAIN VIEWS -->
    <main class="max-w-md mx-auto px-4 pb-24 pt-4">

        <!-- VIEW 1: HOME -->
        <div id="view-home" class="view-section active">
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="card-modern p-4 bg-gradient-to-br from-blue-500/5 to-transparent border-blue-100 dark:border-blue-900/30">
                    <div class="text-2xl font-black text-blue-600" id="dashTotalInd">0</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="dashCountLabel">Locais</div>
                </div>
                <div class="card-modern p-4">
                    <div class="text-2xl font-black text-slate-800 dark:text-white" id="dashWorkLoad">00:00h</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest" id="dashWorkLabel">Carga Hoje</div>
                </div>
            </div>

            <div id="visitAlerts" onclick="AppUI.modals.openLateAlerts()" class="hidden mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 rounded-2xl flex items-center gap-3 active:scale-95 transition-transform cursor-pointer">
                <div class="w-10 h-10 bg-red-100 dark:bg-red-800/40 text-red-600 dark:text-red-400 rounded-full flex items-center justify-center"><i class="fas fa-bell"></i></div>
                <div class="flex-1">
                    <p class="text-[11px] font-bold text-red-800 dark:text-red-400 uppercase">Atraso detetado</p>
                    <p class="text-[10px] text-red-600 dark:text-red-500/80" id="visitAlertMsg">Existem locais sem visitas recentes.</p>
                </div>
                <i class="fas fa-chevron-right text-red-300 text-xs"></i>
            </div>

            <div class="grid grid-cols-7 gap-1 mb-3" id="routeTabsContainer"></div>
            <div class="card-modern min-h-[300px] flex flex-col justify-start overflow-hidden" id="routeListContent"></div>

            <button onclick="AppCore.openAllPhotos()" class="mt-6 w-full py-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 font-bold text-xs uppercase shadow-sm active:scale-95 transition flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700">
                <i class="fas fa-layer-group text-lg"></i> Galeria Global
            </button>
        </div>

        <!-- VIEW 2: RELAT√ìRIOS (PARTILHA) -->
        <div id="view-reports" class="view-section">
            <div class="text-center py-6 mb-4">
                <div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fas fa-paper-plane"></i></div>
                <h2 class="text-lg font-bold">Partilha de Registos</h2>
                <p class="text-xs text-slate-500 mt-1">Seleccione o per√≠odo para enviar as fotos via WhatsApp.</p>
            </div>

            <div class="card-modern p-4 mb-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Data In√≠cio</label>
                        <input type="date" id="reportStartDate" class="input-modern !py-2 !text-xs dark:bg-slate-800">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Data Fim</label>
                        <input type="date" id="reportEndDate" class="input-modern !py-2 !text-xs dark:bg-slate-800">
                    </div>
                </div>
                <div>
                    <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Texto da Mensagem (Opcional)</label>
                    <textarea id="shareCustomTextReports" rows="3" class="input-modern !py-2 !text-xs w-full resize-none dark:bg-slate-800" placeholder="Ex: Ol√°! Seguem as fotos das visitas realizadas entre os dias seleccionados."></textarea>
                </div>
            </div>

            <button onclick="AppCore.shareJpgFiles(true)" class="btn-primary w-full py-5 flex items-center justify-center gap-3 text-sm tracking-wide shadow-lg">
                <i class="fab fa-whatsapp text-xl"></i> ENVIAR JPG VIA WHATSAPP
            </button>
        </div>

        <!-- VIEW 3: LOCAIS -->
        <div id="view-routes" class="view-section">
            <div class="sticky top-16 z-30 bg-body/95 dark:bg-dark-bg/95 backdrop-blur-md py-2 space-y-2 transition-colors">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                    <input type="text" id="searchInput" onkeyup="AppCore.filterIndustries()" placeholder="Pesquisar local..." class="input-modern pl-10 dark:bg-slate-800 dark:border-slate-700">
                </div>
            </div>
            <div id="industriesList" class="grid grid-cols-3 gap-2 pb-20 mt-4"></div>
            <button onclick="AppUI.modals.openAddIndustry()" class="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl active:scale-90 z-40 transition shadow-blue-500/30"><i class="fas fa-plus"></i></button>
        </div>

        <!-- VIEW 4: DATAS -->
        <div id="view-dates" class="view-section">
            <div class="flex items-center justify-between mb-6 px-1">
                <button onclick="AppCore.changeCalendarMonth(-1)" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center active:scale-90 border border-transparent dark:text-white"><i class="fas fa-chevron-left"></i></button>
                <span id="calendarTitle" class="text-base font-bold capitalize">M√™s</span>
                <button onclick="AppCore.changeCalendarMonth(1)" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center active:scale-90 border border-transparent dark:text-white"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="card-modern p-4 mb-6" id="calendarGrid"></div>
            <div class="grid grid-cols-2 gap-4">
                <label class="btn-primary py-5 flex flex-col items-center justify-center gap-2 cursor-pointer shadow-blue-500/20">
                    <i class="fas fa-camera text-2xl"></i><span class="text-[10px] font-bold">C√ÇMARA</span>
                    <input type="file" accept="image/*" capture="environment" class="hidden" onchange="AppCore.uploadPhoto(this)">
                </label>
                <label class="btn-primary py-5 flex flex-col items-center justify-center gap-2 cursor-pointer bg-slate-800 dark:bg-slate-700 shadow-slate-500/20">
                    <i class="fas fa-images text-2xl"></i><span class="text-[10px] font-bold">GALERIA</span>
                    <input type="file" accept="image/*" class="hidden" onchange="AppCore.uploadPhoto(this)">
                </label>
            </div>
        </div>

        <!-- VIEW 5: GALERIA -->
        <div id="view-gallery" class="view-section">
            <div id="photosContainer" class="photo-grid mb-6"></div>
            
            <div class="card-modern p-4 mb-4">
                <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">Mensagem de Acompanhamento</label>
                <textarea id="galleryShareText" rows="2" class="input-modern !py-2 !text-xs w-full resize-none dark:bg-slate-800" placeholder="Escreva a mensagem para o WhatsApp..."></textarea>
            </div>
            
            <button onclick="AppCore.shareJpgFiles(false)" class="btn-primary w-full py-4 flex items-center justify-center gap-3 text-xs tracking-wider shadow-blue-500/30 mb-20">
                <i class="fab fa-whatsapp text-lg"></i> PARTILHAR SELECCIONADAS (.JPG)
            </button>
        </div>

        <!-- VIEW 6: TODAS AS FOTOS -->
        <div id="view-all" class="view-section">
            <div id="allPhotosContainer" class="pb-24 space-y-6"></div>
        </div>

    </main>

    <!-- Barra Inferior -->
    <nav id="mainNavBar" class="bottom-nav">
        <div id="nav-general" class="nav-btn active" onclick="AppCore.switchMainTab('general')">
            <i class="fas fa-calendar-day text-lg"></i><span>Hoje</span>
        </div>
        <div id="nav-reports" class="nav-btn" onclick="AppCore.switchMainTab('reports')">
            <i class="fas fa-share-alt text-lg"></i><span>Partilhar</span>
        </div>
        <div id="nav-routes" class="nav-btn" onclick="AppCore.switchMainTab('routes')">
            <i class="fas fa-industry text-lg"></i><span>Locais</span>
        </div>
    </nav>

    <!-- Dock de A√ß√µes Flutuante -->
    <div id="selectionControls" class="fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t p-4 z-[60] fixed-bar-anim hidden-bar flex gap-3 shadow-[0_-10px_25px_rgba(0,0,0,0.15)]">
        <button onclick="AppCore.selectAllPhotos()" class="px-6 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 font-bold text-xs dark:text-white">Todas</button>
        <button onclick="AppCore.deleteSelected()" class="w-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center text-xl active:scale-95 transition"><i class="fas fa-trash-alt"></i></button>
        <button onclick="AppCore.shareJpgFiles(false)" class="flex-1 bg-blue-600 text-white rounded-xl font-bold active:scale-95 transition shadow-lg">Partilhar JPG (<span id="selCount">0</span>)</button>
    </div>

    <!-- Modais -->
    <div id="lateAlertsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] hidden flex flex-col justify-end sm:justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl h-[60vh] flex flex-col animate-slide-up">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 class="font-bold text-lg mb-4 text-red-600">Locais em Atraso (+7 dias)</h3>
            <div id="lateIndustriesList" class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scroll"></div>
            <button onclick="AppUI.modals.closeLateAlerts()" class="w-full mt-4 py-4 bg-slate-100 dark:bg-slate-800 rounded-xl text-xs font-bold uppercase tracking-wider">Fechar</button>
        </div>
    </div>

    <div id="routeConfigModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex flex-col justify-end sm:justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl h-[85vh] flex flex-col animate-slide-up">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Agenda Semanal</h3>
            <div class="grid grid-cols-7 gap-1 mb-4" id="routeConfigDays"></div>
            <div id="currentConfigDay" class="text-[10px] font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded w-fit mb-3 uppercase tracking-wider">...</div>
            <div id="routeChecklist" class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scroll"></div>
            <div class="flex gap-3 mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                <button onclick="AppUI.modals.closeRouteConfig()" class="flex-1 py-3.5 text-slate-400 font-bold text-xs hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition">Fechar</button>
                <button onclick="AppCore.saveRouteConfig()" class="flex-1 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition">SALVAR</button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="fixed inset-0 bg-black/95 z-[110] hidden flex flex-col justify-center items-center opacity-0 transition-opacity duration-300">
        <div class="absolute top-0 w-full p-4 flex justify-between z-20">
            <button onclick="AppUI.modals.closePhoto()" class="w-10 h-10 bg-white/10 rounded-full text-white flex items-center justify-center active:scale-90 transition"><i class="fas fa-times text-xl"></i></button>
            <button onclick="AppCore.deleteSinglePhoto()" class="w-10 h-10 bg-red-500/80 rounded-full text-white flex items-center justify-center active:scale-90 transition shadow-lg shadow-red-500/20"><i class="fas fa-trash text-sm"></i></button>
        </div>
        <img id="previewImg" src="" class="max-h-[65vh] max-w-full object-contain mb-4 rounded-lg shadow-2xl">
        <div class="w-full max-w-sm px-6">
            <div class="bg-white/10 backdrop-blur-md p-1.5 rounded-2xl border border-white/20 flex gap-2">
                <input type="text" id="photoDescInput" placeholder="Anota√ß√£o ou GPS..." class="bg-transparent text-white text-sm flex-1 px-3 py-2 outline-none font-medium">
                <button onclick="AppCore.savePhotoDescription()" class="bg-blue-600 text-white px-4 rounded-xl font-bold text-xs active:scale-95 transition">OK</button>
            </div>
        </div>
    </div>

    <div id="statusToast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl shadow-slate-500/20 text-xs font-bold flex items-center gap-3 transition-all opacity-0 -translate-y-10 z-[130]">
        <div id="toastIcon"></div>
        <span id="toastMsg">Notifica√ß√£o</span>
    </div>

    <!-- SCRIPT -->
    <script>
        const SUPABASE_URL = 'https://hluxaxbjdpbezvffisns.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsdXhheGJqZHBiZXp2ZmZpc25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTg3NDgsImV4cCI6MjA4MDU5NDc0OH0.lia_McknZ7SD2EGlNchRVZ9d359bFkk7hSJXJYhJzig';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const BUCKET = 'galeria';
        const WEEK_DAYS = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        const CATEGORY_COLORS = ['bg-blue-100 text-blue-600', 'bg-green-100 text-green-600', 'bg-purple-100 text-purple-600', 'bg-orange-100 text-orange-600', 'bg-pink-100 text-pink-600', 'bg-teal-100 text-teal-600'];

        const AppState = {
            currentIndustry: null, currentDateFolder: null, industryPhotos: [], allIndustries: [], categories: [], lateIndustries: [],
            routes: { 'Domingo': [], 'Segunda': [], 'Ter√ßa': [], 'Quarta': [], 'Quinta': [], 'Sexta': [], 'S√°bado': [] },
            isSelectionMode: false, selectedPhotos: new Set(), selectedIndustries: new Set(),
            currentModalPhoto: null, coverImageFile: null, calendarCursor: new Date(), availableDates: new Set(),
            configSelectedDay: null, viewSelectedDay: null, viewHistory: [], userId: 'anonymous'
        };

        const AppUtils = {
            minutesToHM: (m) => `${String(Math.floor(m / 60)).padStart(2,'0')}:${String(m % 60).padStart(2,'0')}`,
            hmToMinutes: (hm) => hm ? hm.split(':').map(Number).reduce((h, m) => h * 60 + m) : 0,
            sanitize: (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_"),
            showToast: (msg, type = 'loading') => {
                const toast = document.getElementById('statusToast'); 
                const msgEl = document.getElementById('toastMsg');
                if(!toast || !msgEl) return;
                msgEl.innerText = msg;
                toast.classList.remove('opacity-0', '-translate-y-10');
                const icon = document.getElementById('toastIcon');
                if (type === 'success') icon.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                else if (type === 'error') icon.innerHTML = '<i class="fas fa-times text-red-400"></i>';
                else icon.innerHTML = '<div class="loader"></div>';
                setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 2500);
            },
            toggleDarkMode: () => { 
                document.documentElement.classList.toggle('dark'); 
                localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); 
            },
            getGPS: () => new Promise((res) => {
                if(!navigator.geolocation) return res(null);
                navigator.geolocation.getCurrentPosition((p) => res(`${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`), () => res(null), { timeout: 3000 });
            }),
            resizeImage: (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const max = 1200;
                            const scale = max / Math.max(img.width, img.height);
                            canvas.width = img.width * scale; canvas.height = img.height * scale;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.85);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        };

        const AppCore = {
            init: async () => {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') document.documentElement.classList.add('dark');
                
                const now = new Date();
                const todayIso = now.toISOString().split('T')[0];
                if(document.getElementById('reportStartDate')) document.getElementById('reportStartDate').value = todayIso;
                if(document.getElementById('reportEndDate')) document.getElementById('reportEndDate').value = todayIso;

                try {
                    await Promise.all([AppCore.loadIndustries(), AppCore.fetchRoutes(), AppCore.loadCategories()]);
                    const today = WEEK_DAYS[now.getDay()];
                    AppState.viewSelectedDay = today;
                    AppUI.renderRouteList(today);
                    AppUI.updateDashboard();
                    AppCore.checkAlerts();
                } catch (e) { console.error(e); }
            },
            loadIndustries: async () => {
                const { data } = await sb.from('industrias').select('*, categorias(nome)').order('nome');
                AppState.allIndustries = data || [];
                AppUI.renderIndustries(AppState.allIndustries);
            },
            fetchRoutes: async () => {
                const { data } = await sb.from('rotas').select('*');
                if (data) data.forEach(r => AppState.routes[r.dia] = r.industrias || []);
            },
            loadCategories: async () => {
                const { data } = await sb.from('categorias').select('*').order('nome');
                AppState.categories = data || [];
                AppUI.renderCategoryOptions();
            },
            uploadPhoto: async (input) => {
                const f = input.files[0]; if (!f || !AppState.currentIndustry) return;
                AppUtils.showToast("A processar imagem...");
                const gps = await AppUtils.getGPS();
                try {
                    const safeName = AppUtils.sanitize(AppState.currentIndustry.nome);
                    const now = new Date();
                    const targetDate = AppState.currentDateFolder || now.toLocaleDateString('pt-PT').replace(/\//g, '-');
                    const fileName = `${safeName}/${targetDate}/FOTO_${now.getTime()}.jpg`;
                    const blob = await AppUtils.resizeImage(f);
                    await sb.storage.from(BUCKET).upload(fileName, blob, { contentType: 'image/jpeg' });
                    const { data: urlData } = sb.storage.from(BUCKET).getPublicUrl(fileName);
                    await sb.from('fotos').insert({
                        created_at: now.toISOString(), nome_arquivo: fileName, url_publica: urlData.publicUrl,
                        industria_id: AppState.currentIndustry.id, descricao: gps ? `üìç GPS: ${gps}` : ''
                    }).select();
                    AppUtils.showToast("Foto salva!", "success");
                    await AppCore.loadDates(AppState.currentIndustry.nome);
                    if (document.getElementById('view-gallery').classList.contains('active')) AppUI.loadGalleryPhotos();
                    AppCore.checkAlerts();
                } catch (e) { AppUtils.showToast("Erro no envio", "error"); } finally { input.value = ''; }
            },
            loadDates: async (name) => {
                const safe = AppUtils.sanitize(name);
                const { data: allPhotos } = await sb.from('fotos').select('*').like('nome_arquivo', `${safe}/%`).order('created_at', { ascending: false });
                AppState.industryPhotos = allPhotos || [];
                AppState.availableDates.clear();
                AppState.industryPhotos.forEach(p => AppState.availableDates.add(new Date(p.created_at).toLocaleDateString('pt-PT')));
                AppUI.renderCalendar();
            },
            changeCalendarMonth: (o) => { AppState.calendarCursor.setMonth(AppState.calendarCursor.getMonth() + o); AppUI.renderCalendar(); },
            checkAlerts: async () => {
                const { data } = await sb.from('fotos').select('industria_id, created_at').order('created_at', { ascending: false });
                const lastVisits = {};
                data?.forEach(f => { if(!lastVisits[f.industria_id]) lastVisits[f.industria_id] = new Date(f.created_at); });
                const threshold = new Date(); threshold.setDate(threshold.getDate() - 7);
                AppState.lateIndustries = AppState.allIndustries.filter(i => !lastVisits[i.id] || lastVisits[i.id] < threshold);
                const alertEl = document.getElementById('visitAlerts');
                if(AppState.lateIndustries.length > 0) {
                    if(alertEl) alertEl.classList.remove('hidden');
                    const msgEl = document.getElementById('visitAlertMsg');
                    if(msgEl) msgEl.innerText = `${AppState.lateIndustries.length} locais sem visitas recentes.`;
                } else if(alertEl) alertEl.classList.add('hidden');
            },
            shareJpgFiles: async (isReportsTab) => {
                const customMsg = isReportsTab ? document.getElementById('shareCustomTextReports').value : document.getElementById('galleryShareText').value;
                const start = isReportsTab ? document.getElementById('reportStartDate').value : null;
                const end = isReportsTab ? document.getElementById('reportEndDate').value : null;

                AppUtils.showToast("A preparar fotos...", "loading");
                
                try {
                    let photosToShare = [];
                    if(isReportsTab) {
                        const { data } = await sb.from('fotos').select('*')
                            .gte('created_at', `${start}T00:00:00Z`)
                            .lte('created_at', `${end}T23:59:59Z`);
                        photosToShare = data || [];
                    } else {
                        photosToShare = AppState.industryPhotos.filter(f => AppState.selectedPhotos.has(f.id));
                        if(photosToShare.length === 0) {
                             photosToShare = AppState.industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-PT') === AppState.currentDateFolder);
                        }
                    }

                    if(photosToShare.length === 0) return AppUtils.showToast("Sem fotos para enviar", "error");
                    
                    const fileObjects = [];
                    for(const p of photosToShare) {
                        try {
                            const blob = await fetch(p.url_publica).then(r => r.blob());
                            fileObjects.push(new File([blob], `Registo_${p.id.substring(0,4)}.jpg`, { type: 'image/jpeg' }));
                        } catch(e) { console.warn("Falha ao carregar imagem para partilha", e); }
                    }

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: fileObjects })) {
                        await navigator.share({
                            files: fileObjects,
                            title: 'Registos Industriais',
                            text: customMsg || "Seguem as fotografias dos registos industriais."
                        });
                        AppUtils.showToast("Partilha conclu√≠da!", "success");
                    } else {
                        AppUtils.showToast("A partilha nativa n√£o √© suportada neste navegador.", "error");
                    }
                } catch(e) { console.error(e); AppUtils.showToast("Erro na partilha.", "error"); }
            },
            saveIndustry: async () => {
                const id = document.getElementById('editIndId').value;
                const name = document.getElementById('newIndName').value.trim();
                const hours = parseInt(document.getElementById('newIndHours').value) || 0;
                if(!name || !confirm("Gravar altera√ß√µes?")) return;
                AppUtils.showToast("A guardar...");
                const payload = { nome: name, carga_semanal: hours };
                if(id) await sb.from('industrias').update(payload).eq('id', id).select();
                else await sb.from('industrias').insert(payload).select();
                AppUI.modals.closeAdd(); AppCore.loadIndustries(); AppUtils.showToast("Guardado!", "success");
            },
            savePhotoDescription: async () => {
                if(!AppState.currentModalPhoto) return;
                const desc = document.getElementById('photoDescInput').value;
                await sb.from('fotos').update({ descricao: desc }).eq('id', AppState.currentModalPhoto.id).select();
                AppState.currentModalPhoto.descricao = desc; AppUtils.showToast("Guardado", "success"); AppUI.loadGalleryPhotos();
            },
            saveRouteConfig: async () => {
                if(!confirm(`Deseja guardar o planeamento para ${AppState.configSelectedDay}?`)) return;
                AppUtils.showToast("A guardar...");
                await sb.from('rotas').upsert({ dia: AppState.configSelectedDay, industrias: AppState.routes[AppState.configSelectedDay] }, { onConflict: 'dia' }).select();
                if (AppState.configSelectedDay === AppState.viewSelectedDay) AppUI.renderRouteList(AppState.configSelectedDay);
                AppUI.modals.closeRouteConfig(); AppUI.updateDashboard(); AppUtils.showToast("Agenda Guardada", "success");
            },
            switchMainTab: (t) => { AppState.viewHistory = []; const m = { general: 'view-home', reports: 'view-reports', routes: 'view-routes' }; AppUI.navigateTo(m[t], false); },
            goBack: () => { AppUI.navigateTo(AppState.viewHistory.pop() || 'view-home', false); },
            toggleSelectionMode: () => {
                AppState.isSelectionMode = !AppState.isSelectionMode;
                const b = document.getElementById('selectBtn');
                if (AppState.isSelectionMode) {
                    b.innerText = "Cancelar"; b.classList.add('text-red-500');
                    document.getElementById('selectionControls').classList.remove('hidden-bar');
                } else {
                    b.innerText = "Select"; b.classList.remove('text-red-500');
                    document.getElementById('selectionControls').classList.add('hidden-bar');
                    AppState.selectedPhotos.clear();
                }
                AppUI.loadGalleryPhotos();
            },
            handlePhotoClick: (f) => {
                if (AppState.isSelectionMode) { 
                    if (AppState.selectedPhotos.has(f.id)) AppState.selectedPhotos.delete(f.id); 
                    else AppState.selectedPhotos.add(f.id); 
                    document.getElementById('selCount').innerText = AppState.selectedPhotos.size; 
                    AppUI.loadGalleryPhotos(); 
                } else { AppState.currentModalPhoto = f; AppUI.modals.openPhoto(f); }
            },
            handleCoverChange: (e) => { const f = e.target.files[0]; if(!f) return; AppState.coverImageFile = f; document.getElementById('coverPreview').src = URL.createObjectURL(f); document.getElementById('coverPreview').classList.remove('hidden'); document.getElementById('coverPlaceholder').classList.add('hidden'); },
            filterIndustries: () => {
                const term = document.getElementById('searchInput').value.toLowerCase();
                const filtered = AppState.allIndustries.filter(i => i.nome.toLowerCase().includes(term));
                AppUI.renderIndustries(filtered);
            },
            selectAllPhotos: () => { 
                AppState.industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-PT') === AppState.currentDateFolder).forEach(f => AppState.selectedPhotos.add(f.id)); 
                document.getElementById('selCount').innerText = AppState.selectedPhotos.size;
                AppUI.loadGalleryPhotos(); 
            },
            deleteSelected: async () => { if(!confirm("Apagar fotos selecionadas?")) return; await sb.from('fotos').delete().in('id', Array.from(AppState.selectedPhotos)); AppState.selectedPhotos.clear(); AppCore.toggleSelectionMode(); if(AppState.currentIndustry) AppCore.loadDates(AppState.currentIndustry.nome); },
            deleteSinglePhoto: async () => { if(!confirm("Apagar?")) return; await sb.from('fotos').delete().eq('id', AppState.currentModalPhoto.id); AppUI.modals.closePhoto(); if(AppState.currentIndustry) AppCore.loadDates(AppState.currentIndustry.nome); AppUI.loadGalleryPhotos(); },
            openAllPhotos: async () => {
                AppUI.navigateTo('view-all');
                const c = document.getElementById('allPhotosContainer');
                c.innerHTML = '<div class="col-span-3 py-20 flex justify-center"><div class="loader"></div></div>';
                const { data } = await sb.from('fotos').select('*').order('created_at', { ascending: false }).limit(60);
                c.innerHTML = '';
                if(!data || data.length === 0) { c.innerHTML = '<div class="col-span-3 py-20 text-center opacity-40 italic text-sm">Sem fotos</div>'; return; }
                const groups = {};
                data.forEach(f => {
                    const d = new Date(f.created_at).toLocaleDateString('pt-PT');
                    if(!groups[d]) groups[d] = [];
                    groups[d].push(f);
                });
                Object.keys(groups).forEach(dateStr => {
                    const header = document.createElement('div');
                    header.className = 'w-full mt-6 mb-2 px-1 border-b border-slate-100 dark:border-slate-800 pb-1 transition-colors';
                    header.innerHTML = `<span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${dateStr}</span>`;
                    c.appendChild(header);
                    const grid = document.createElement('div'); grid.className = 'photo-grid w-full';
                    groups[dateStr].forEach(f => {
                        const d = document.createElement('div');
                        d.className = `photo-thumb ${AppState.selectedPhotos.has(f.id) ? 'selected' : ''}`;
                        d.onclick = () => AppCore.handlePhotoClick(f);
                        d.innerHTML = `<img src="${f.url_publica}" loading="lazy">`;
                        grid.appendChild(d);
                    });
                    c.appendChild(grid);
                });
            }
        };

        const AppUI = {
            navigateTo: (id, hist = true) => {
                const activeSection = document.querySelector('.view-section.active');
                if (hist && activeSection) AppState.viewHistory.push(activeSection.id);
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                const target = document.getElementById(id);
                if (target) target.classList.add('active');
                const els = { back: 'backBtn', config: 'configRouteBtn', sel: 'selectBtn', nav: 'mainNavBar', edit: 'editIndBtn' };
                const show = (eid) => document.getElementById(els[eid])?.classList.remove('hidden');
                const hide = (eid) => document.getElementById(els[eid])?.classList.add('hidden');
                hide('back'); hide('config'); hide('sel'); hide('edit');
                if (id === 'view-home') show('config');
                else if (id === 'view-routes') show('sel');
                else if (id === 'view-dates') { show('back'); show('edit'); }
                else if (id === 'view-gallery' || id === 'view-all') { show('back'); show('sel'); }
                else show('back');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const navMap = { 'view-home': 'general', 'view-routes': 'routes', 'view-reports': 'reports' };
                if(navMap[id]) document.getElementById('nav-' + navMap[id]).classList.add('active');
                if(id === 'view-reports') AppUI.renderDailyIndustries();
            },
            updateDashboard: () => {
                const day = AppState.viewSelectedDay || WEEK_DAYS[new Date().getDay()];
                const route = AppState.routes[day] || [];
                let totalMins = 0; route.forEach(i => totalMins += (i.minutos || 0));
                if(document.getElementById('dashTotalInd')) document.getElementById('dashTotalInd').innerText = route.length;
                if(document.getElementById('dashWorkLoad')) document.getElementById('dashWorkLoad').innerText = AppUtils.minutesToHM(totalMins) + 'h';
                if(document.getElementById('dashCountLabel')) document.getElementById('dashCountLabel').innerText = `Locais ${day}`;
                if(document.getElementById('dashWorkLabel')) document.getElementById('dashWorkLabel').innerText = `Carga ${day}`;
            },
            renderIndustries: (list) => {
                const c = document.getElementById('industriesList'); if(!c) return;
                c.innerHTML = '';
                list.forEach(ind => {
                    const d = document.createElement('div'); d.className = `ind-card cursor-pointer border dark:border-slate-700 ${AppState.selectedIndustries.has(ind.id) ? 'selected-item' : ''}`;
                    d.onclick = () => { AppState.currentIndustry = ind; AppState.calendarCursor = new Date(); AppUI.navigateTo('view-dates'); AppCore.loadDates(ind.nome); };
                    const img = ind.cover_url ? `<img src="${ind.cover_url}">` : '<i class="fas fa-industry text-2xl text-slate-200"></i>';
                    d.innerHTML = `<div class="cover-wrapper flex items-center justify-center dark:bg-slate-800">${img}</div><h3 class="font-bold text-[10px] text-center truncate w-full px-1 dark:text-white">${ind.nome}</h3><span class="text-[8px] text-slate-400 font-bold uppercase">${ind.carga_semanal || 0}H/SEM</span>`;
                    c.appendChild(d);
                });
            },
            renderRouteList: (day) => {
                const c = document.getElementById('routeListContent'); if(!c) return;
                c.innerHTML = '';
                const tabs = document.getElementById('routeTabsContainer'); if(!tabs) return;
                tabs.innerHTML = '';
                WEEK_DAYS.forEach(d => {
                    const t = document.createElement('div'); t.innerText = d.substring(0, 3);
                    t.className = `day-tab ${d === day ? 'active' : ''} ${d === 'Domingo' ? 'text-red-400' : ''}`;
                    t.onclick = () => { AppState.viewSelectedDay = d; AppUI.renderRouteList(d); AppUI.updateDashboard(); };
                    tabs.appendChild(t);
                });
                const items = AppState.routes[day] || [];
                if(items.length === 0) { c.innerHTML = '<div class="py-12 flex flex-col items-center justify-center text-slate-300 dark:text-slate-600"><i class="fas fa-calendar-check text-4xl mb-2"></i><p class="text-[10px] uppercase font-bold">Dia Livre</p></div>'; return; }
                items.forEach(item => {
                    const ind = AppState.allIndustries.find(i => i.nome === (item.nome || item));
                    if(!ind) return;
                    const row = document.createElement('div'); row.className = 'route-item hover:bg-slate-50 dark:hover:bg-slate-800/50';
                    row.onclick = () => { AppState.currentIndustry = ind; AppUI.navigateTo('view-dates'); AppCore.loadDates(ind.nome); };
                    row.innerHTML = `<div class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-800 overflow-hidden mr-3 flex-shrink-0">${ind.cover_url ? `<img src="${ind.cover_url}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center bg-slate-50 dark:bg-slate-800"><i class="fas fa-industry text-slate-300"></i></div>'}</div><div class="flex-1 overflow-hidden"><div class="font-bold text-sm truncate dark:text-white">${ind.nome}</div></div><div class="text-xs font-mono font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded-lg">${AppUtils.minutesToHM(item.minutos || 0)}h</div>`;
                    c.appendChild(row);
                });
            },
            renderCalendar: () => {
                const c = document.getElementById('calendarGrid'); if(!c) return;
                c.innerHTML = '<div class="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] font-bold text-slate-400 uppercase tracking-tighter"><span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span></div>';
                const grid = document.createElement('div'); grid.className = 'cal-grid';
                const y = AppState.calendarCursor.getFullYear(), m = AppState.calendarCursor.getMonth();
                document.getElementById('calendarTitle').innerText = new Date(y, m).toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
                const first = new Date(y, m, 1).getDay(); const days = new Date(y, m + 1, 0).getDate();
                for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
                const todayStr = new Date().toLocaleDateString('pt-PT');
                for(let d=1; d<=days; d++) {
                    const dateStr = new Date(y, m, d).toLocaleDateString('pt-PT');
                    const b = document.createElement('div'); b.className = `cal-day ${AppState.availableDates.has(dateStr) ? 'active' : ''} ${dateStr === todayStr ? 'today' : ''}`; b.innerText = d;
                    if(AppState.availableDates.has(dateStr)) b.onclick = () => { AppState.currentDateFolder = dateStr; AppUI.navigateTo('view-gallery'); AppUI.loadGalleryPhotos(); };
                    grid.appendChild(b);
                }
                c.appendChild(grid);
            },
            loadGalleryPhotos: () => {
                const c = document.getElementById('photosContainer'); if(!c) return;
                c.innerHTML = '';
                const p = AppState.industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-PT') === AppState.currentDateFolder);
                if(p.length === 0) { c.innerHTML = '<div class="col-span-3 py-10 text-center opacity-40 text-xs italic text-sm">Sem fotografias nesta data</div>'; return; }
                p.forEach(f => {
                    const d = document.createElement('div'); 
                    d.className = `photo-thumb ${AppState.selectedPhotos.has(f.id) ? 'selected' : ''}`;
                    d.onclick = () => AppCore.handlePhotoClick(f); 
                    d.innerHTML = `<img src="${f.url_publica}" loading="lazy">${f.descricao ? '<div class="absolute bottom-1 right-1 w-2.5 h-2.5 bg-yellow-400 border-2 border-white dark:border-slate-900 rounded-full shadow-sm"></div>' : ''}`;
                    c.appendChild(d);
                });
            },
            renderDailyIndustries: () => {
                const c = document.getElementById('dailyIndustriesList'); if(!c) return;
                c.innerHTML = '';
                const today = WEEK_DAYS[new Date().getDay()];
                const items = AppState.routes[today] || [];
                if(items.length === 0) { c.innerHTML = '<p class="text-center py-4 text-xs italic opacity-50">Nenhum local agendado para hoje.</p>'; return; }
                items.forEach(item => {
                    const d = document.createElement('div'); d.className = 'flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border dark:border-slate-700';
                    d.innerHTML = `<span class="text-sm font-bold dark:text-white">${item.nome || item}</span><i class="fas fa-check-circle text-blue-500"></i>`;
                    c.appendChild(d);
                });
            },
            renderRouteChecklist: () => {
                const l = document.getElementById('routeChecklist'); if(!l) return;
                l.innerHTML = '';
                const day = AppState.configSelectedDay || 'Segunda';
                AppState.allIndustries.forEach(ind => {
                    const item = AppState.routes[day]?.find(r => (r.nome || r) === ind.nome);
                    const d = document.createElement('div'); d.className = 'flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm border dark:border-slate-700';
                    d.innerHTML = `<input type="checkbox" ${item?'checked':''} onchange="AppUI.toggleRouteCheck('${ind.nome.replace(/'/g, "\\'")}', this.checked)"><span class="flex-1 text-xs font-bold truncate dark:text-white">${ind.nome}</span><input type="time" class="time-input dark:bg-slate-700 dark:text-white" value="${AppUtils.minutesToHM(item?.minutos || 0)}" onchange="AppUI.updateRouteMins('${ind.nome.replace(/'/g, "\\'")}', this.value)">`;
                    l.appendChild(d);
                });
            },
            toggleRouteCheck: (name, checked) => {
                const day = AppState.configSelectedDay;
                if(!AppState.routes[day]) AppState.routes[day] = [];
                if(checked) AppState.routes[day].push({ nome: name, minutos: 0 });
                else AppState.routes[day] = AppState.routes[day].filter(r => (r.nome || r) !== name);
                AppUI.renderRouteChecklist();
            },
            updateRouteMins: (name, val) => {
                const item = AppState.routes[AppState.configSelectedDay]?.find(r => (r.nome || r) === name);
                if(item) item.minutos = AppUtils.hmToMinutes(val);
            },
            renderCategoryOptions: () => {
                ['catSelect', 'catSelectFilter'].forEach(id => {
                    const s = document.getElementById(id); if(!s) return;
                    s.innerHTML = id === 'catSelectFilter' ? '<option value="">Categorias</option>' : '<option value="">Geral</option>';
                    AppState.categories.forEach(c => s.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
                });
            },
            modals: {
                openLateAlerts: () => {
                    document.getElementById('lateAlertsModal').classList.remove('hidden');
                    const c = document.getElementById('lateIndustriesList'); c.innerHTML = '';
                    AppState.lateIndustries.forEach(ind => {
                        const d = document.createElement('div'); d.className = 'flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-800 rounded-xl border dark:border-slate-700 cursor-pointer active:bg-slate-100';
                        d.onclick = () => { AppState.currentIndustry = ind; AppState.calendarCursor = new Date(); AppUI.navigateTo('view-dates'); AppCore.loadDates(ind.nome); AppUI.modals.closeLateAlerts(); };
                        d.innerHTML = `<span class="text-sm font-bold dark:text-white">${ind.nome}</span><i class="fas fa-history text-red-400"></i>`;
                        c.appendChild(d);
                    });
                },
                closeLateAlerts: () => document.getElementById('lateAlertsModal')?.classList.add('hidden'),
                openRouteConfig: () => { 
                    if(!AppState.configSelectedDay) AppState.configSelectedDay = WEEK_DAYS[new Date().getDay()];
                    document.getElementById('routeConfigModal').classList.remove('hidden');
                    const c = document.getElementById('routeConfigDays'); c.innerHTML = '';
                    WEEK_DAYS.forEach(d => {
                        const b = document.createElement('button'); b.innerText = d.substring(0,1);
                        b.className = `p-2.5 rounded-lg text-[10px] font-black transition ${d === AppState.configSelectedDay ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-50 dark:bg-slate-800 text-slate-400'}`;
                        b.onclick = () => { AppState.configSelectedDay = d; AppUI.modals.updateRouteConfigUI(); };
                        c.appendChild(b);
                    });
                    const currentDayEl = document.getElementById('currentConfigDay');
                    if(currentDayEl) currentDayEl.innerText = AppState.configSelectedDay; 
                    AppUI.renderRouteChecklist();
                },
                updateRouteConfigUI: () => {
                    const day = AppState.configSelectedDay;
                    document.querySelectorAll('#routeConfigDays button').forEach((btn, idx) => {
                        const d = WEEK_DAYS[idx];
                        btn.className = `p-2.5 rounded-lg text-[10px] font-black transition ${d === day ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-50 dark:bg-slate-800 text-slate-400'}`;
                    });
                    const currentDayEl = document.getElementById('currentConfigDay');
                    if(currentDayEl) currentDayEl.innerText = day;
                    AppUI.renderRouteChecklist();
                },
                closeRouteConfig: () => document.getElementById('routeConfigModal')?.classList.add('hidden'),
                openAddIndustry: () => { 
                    const modal = document.getElementById('addModal'); if(!modal) return;
                    modal.classList.remove('hidden');
                    document.getElementById('editIndId').value="";
                    document.getElementById('newIndName').value="";
                    document.getElementById('newIndHours').value="";
                },
                openEditIndustry: () => { if(!AppState.currentIndustry) return; AppUI.modals.openAddIndustry(); document.getElementById('modalTitle').innerText="Editar"; document.getElementById('editIndId').value = AppState.currentIndustry.id; document.getElementById('newIndName').value = AppState.currentIndustry.nome; document.getElementById('newIndHours').value = AppState.currentIndustry.carga_semanal; },
                closeAdd: () => document.getElementById('addModal')?.classList.add('hidden'),
                openPhoto: (f) => { 
                    const previewImg = document.getElementById('previewImg');
                    if(previewImg) previewImg.src = f.url_publica;
                    const descInput = document.getElementById('photoDescInput');
                    if(descInput) descInput.value = f.descricao || '';
                    const m = document.getElementById('photoModal');
                    if(m) {
                        m.classList.remove('hidden');
                        setTimeout(() => m.classList.add('opacity-100'), 10);
                    }
                },
                closePhoto: () => { const m = document.getElementById('photoModal'); if(m) { m.classList.remove('opacity-100'); setTimeout(() => m.classList.add('hidden'), 300); } }
            }
        };

        window.onload = AppCore.init;
    </script>
</body>
</html>
