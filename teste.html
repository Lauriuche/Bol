<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <title>Gestor Industrial Pro</title>
    
    <!-- PWA Meta Tags -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4300/4300058.png">
    <link rel="manifest" href="data:application/manifest+json,{'name':'Gestor Industrial Pro','short_name':'IndustrialPro','start_url':'.','display':'standalone','background_color':'#ffffff','theme_color':'#2563eb'}">

    <!-- Depend√™ncias Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f1f5f9', border: '#334155', muted: '#94a3b8' },
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.2s ease-out', 'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    }
                } 
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* === VARI√ÅVEIS & RESET === */
        :root {
            --bg-body: #f8fafc; --bg-card: #ffffff; --bg-glass: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b; --text-muted: #64748b; --border: #e2e8f0;
            --primary: #3b82f6; --danger: #ef4444;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        html.dark :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-glass: rgba(15, 23, 42, 0.95);
            --text-main: #f8fafc; --text-muted: #94a3b8; --border: #334155;
        }
        
        body { 
            font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main);
            padding-bottom: calc(100px + var(--safe-bottom)); 
            -webkit-tap-highlight-color: transparent; user-select: none;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        /* === COMPONENTES DE UI === */
        .glass { background: var(--bg-glass); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); }
        .card-modern { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        /* Ind√∫stria Card 1:1 Grelha de 3 */
        .ind-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px;
            padding: 6px; aspect-ratio: 1/1; display: flex; flex-direction: column; 
            justify-content: space-between; position: relative; overflow: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .ind-card:active { transform: scale(0.96); }
        .ind-card.selected-item { border: 2.3px solid var(--primary); background-color: rgba(59, 130, 246, 0.05); } 

        .ind-card .cover-wrapper { width: 100%; flex: 1; border-radius: 8px; overflow: hidden; background: var(--bg-body); position: relative; margin-bottom: 4px; }
        .ind-card img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }

        .input-modern { width: 100%; background: var(--bg-body); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; font-size: 14px; color: var(--text-main); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 12px; font-weight: 700; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); transition: transform 0.1s; border: none; }
        .btn-primary:active { transform: scale(0.97); }

        .day-tab { font-weight: 700; font-size: 10px; color: var(--text-muted); padding: 10px 0; border-radius: 10px; transition: all 0.2s; cursor: pointer; text-transform: uppercase; display: flex; justify-content: center; align-items: center; }
        .day-tab.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid var(--border); }
        
        .route-item { display: flex; align-items: center; padding: 14px; border-bottom: 1px solid var(--border); transition: background 0.15s; cursor: pointer; }
        .route-item:active { background: var(--bg-body); }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .cal-day { aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; color: var(--text-muted); transition: all 0.2s; border: 1px solid transparent; cursor: pointer; }
        .cal-day.active { background: rgba(59, 130, 246, 0.15); color: var(--primary); border-color: var(--primary); }
        .cal-day.today { border-color: var(--primary); color: var(--primary); font-weight: 800; }
        .cal-day .dot { width: 4px; height: 4px; background: currentColor; border-radius: 50%; margin-top: 4px; }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fade-in 0.2s forwards; }
        
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .photo-thumb { aspect-ratio: 1; overflow: hidden; border-radius: 8px; background: var(--border); position: relative; cursor: pointer; }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .photo-thumb.selected { box-shadow: inset 0 0 0 3px var(--primary); }
        .photo-thumb.selected img { opacity: 0.6; }

        .fixed-bar-anim { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden-bar { transform: translateY(150%); }

        .cat-badge { font-size: 8px; font-weight: 800; text-transform: uppercase; padding: 2px 8px; border-radius: 6px; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.5px; }

        /* === DOCK DE NAVEGA√á√ÉO === */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: calc(65px + var(--safe-bottom));
            background: var(--bg-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border); z-index: 50;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: var(--safe-bottom); box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; color: var(--text-muted); font-size: 10px; font-weight: 700;
            transition: all 0.2s; cursor: pointer;
        }
        .nav-btn i { font-size: 20px; margin-bottom: 5px; }
        .nav-btn.active { color: var(--primary); }
        
        .loader { border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid #3b82f6; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .time-input { background: var(--bg-body); border: 1px solid var(--border); border-radius: 8px; padding: 4px; font-size: 12px; width: 75px; text-align: center; font-weight: bold; }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="fixed top-0 w-full h-16 glass z-50 flex items-center justify-between px-4 shadow-sm transition-colors duration-300">
        <div class="flex items-center gap-3 w-3/4">
            <button id="backBtn" onclick="AppCore.goBack()" class="hidden w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex items-center justify-center active:scale-90 shadow-sm flex-shrink-0"><i class="fas fa-chevron-left text-sm"></i></button>
            <div class="overflow-hidden">
                <h1 id="pageTitle" class="font-bold text-base truncate leading-tight">Cronograma</h1>
                <p id="pageSubtitle" class="text-[10px] font-medium text-slate-500 uppercase truncate">Vis√£o Geral</p>
            </div>
        </div>
        <div class="flex gap-2 flex-shrink-0">
            <button onclick="AppUtils.toggleDarkMode()" class="w-9 h-9 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-500 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 transition shadow-sm"><i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:inline"></i></button>
            <button id="configRouteBtn" onclick="AppUI.modals.openRouteConfig()" class="w-9 h-9 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-500 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90 transition"><i class="fas fa-sliders-h"></i></button>
            <button id="selectBtn" onclick="AppCore.toggleSelectionMode()" class="hidden px-3 py-1.5 rounded-lg bg-slate-100 dark:bg-slate-800 text-blue-600 dark:text-blue-400 text-[10px] font-bold uppercase border border-slate-200 dark:border-slate-700">Select</button>
            <button id="editIndBtn" onclick="AppUI.modals.openEditIndustry()" class="hidden w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-blue-600 flex items-center justify-center border border-slate-200 dark:border-slate-700 active:scale-90"><i class="fas fa-pen text-xs"></i></button>
        </div>
    </header>

    <div class="h-16"></div>

    <!-- √ÅREA PRINCIPAL -->
    <main class="max-w-md mx-auto px-4 pb-24 pt-4">

        <!-- VIEW 1: HOME -->
        <div id="view-home" class="view-section active">
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="card-modern p-4 bg-gradient-to-br from-blue-500/5 to-transparent border-blue-100">
                    <div class="text-2xl font-black text-blue-600" id="dashTotalInd">0</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Locais</div>
                </div>
                <div class="card-modern p-4">
                    <div class="text-2xl font-black text-slate-800 dark:text-white" id="dashWorkLoad">00:00h</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Carga Hoje</div>
                </div>
            </div>

            <!-- Alertas de Visita -->
            <div id="visitAlerts" class="hidden mb-6 p-3 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 rounded-2xl flex items-center gap-3 animate-fade-in">
                <i class="fas fa-bell text-red-500 text-lg"></i>
                <div class="flex-1">
                    <p class="text-[11px] font-bold text-red-800 dark:text-red-400 uppercase">Aten√ß√£o ao Cronograma</p>
                    <p class="text-[10px] text-red-600 dark:text-red-500/80" id="visitAlertMsg">Existem locais sem visitas recentes.</p>
                </div>
            </div>

            <div class="grid grid-cols-7 gap-1 mb-3" id="routeTabsContainer"></div>
            <div class="card-modern min-h-[300px] flex flex-col justify-start" id="routeListContent">
                <div class="p-4 space-y-4">
                    <div class="skeleton w-full h-12"></div>
                    <div class="skeleton w-full h-12"></div>
                </div>
            </div>

            <button onclick="AppCore.openAllPhotos()" class="mt-6 w-full py-4 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 font-bold text-xs uppercase shadow-sm active:scale-95 transition flex items-center justify-center gap-2 hover:bg-slate-50">
                <i class="fas fa-layer-group text-lg"></i> Galeria Global de Fotos
            </button>
        </div>

        <!-- VIEW 2: RELAT√ìRIOS -->
        <div id="view-reports" class="view-section">
            <div class="text-center py-6 mb-4">
                <div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <h2 class="text-lg font-bold">Relat√≥rio Di√°rio</h2>
                <p class="text-xs text-slate-500 mt-1">Consolida√ß√£o autom√°tica das visitas.</p>
            </div>

            <div class="card-modern p-4 mb-6">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Ind√∫strias na Rota</h3>
                <div id="dailyIndustriesList" class="space-y-3"></div>
            </div>

            <button onclick="AppCore.generateDailyConsolidatedReport()" class="btn-primary w-full py-5 flex items-center justify-center gap-3 text-sm tracking-wide shadow-lg">
                <i class="fas fa-file-pdf text-xl"></i> GERAR RELAT√ìRIO DO DIA
            </button>
        </div>

        <!-- VIEW 3: LOCAIS (CRUD) -->
        <div id="view-routes" class="view-section">
            <div class="sticky top-16 z-30 bg-body/95 backdrop-blur-md py-2 space-y-2">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                    <input type="text" id="searchInput" onkeyup="AppCore.filterIndustries()" placeholder="Pesquisar local..." class="input-modern pl-10">
                </div>
                <select id="catSelectFilter" onchange="AppCore.filterIndustries()" class="input-modern appearance-none py-3 text-xs font-medium cursor-pointer">
                    <option value="">Todas as Categorias</option>
                </select>
            </div>

            <div class="flex justify-between items-end px-1 mb-3 mt-4">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Cat√°logo</span>
                <span id="indCount" class="text-[10px] bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 px-2 py-1 rounded-md font-mono font-bold">0</span>
            </div>

            <div id="industriesList" class="grid grid-cols-3 gap-2 pb-20"></div>

            <button onclick="AppUI.modals.openAddIndustry()" class="fixed bottom-24 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl active:scale-90 z-40 transition">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- VIEW 4: DATAS -->
        <div id="view-dates" class="view-section">
            <div class="flex items-center justify-between mb-6 px-1">
                <button onclick="AppCore.changeCalendarMonth(-1)" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center active:scale-90 border border-transparent"><i class="fas fa-chevron-left"></i></button>
                <span id="calendarTitle" class="text-lg font-bold capitalize">M√™s</span>
                <button onclick="AppCore.changeCalendarMonth(1)" class="w-10 h-10 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center active:scale-90 border border-transparent"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div class="card-modern p-4 mb-6" id="calendarGrid"></div>

            <div class="grid grid-cols-2 gap-4">
                <label class="btn-primary py-4 flex flex-col items-center justify-center gap-2 cursor-pointer shadow-blue-500/20">
                    <i class="fas fa-camera text-2xl"></i><span class="text-[10px] font-bold">C√ÇMARA</span>
                    <input type="file" accept="image/*" capture="environment" class="hidden" onchange="AppCore.uploadPhoto(this)">
                </label>
                <label class="btn-primary py-4 flex flex-col items-center justify-center gap-2 cursor-pointer bg-slate-800 dark:bg-slate-700">
                    <i class="fas fa-images text-2xl"></i><span class="text-[10px] font-bold">GALERIA</span>
                    <input type="file" accept="image/*" class="hidden" onchange="AppCore.uploadPhoto(this)">
                </label>
            </div>
        </div>

        <!-- VIEW 5: GALERIA -->
        <div id="view-gallery" class="view-section">
            <button onclick="AppCore.generatePDF()" class="w-full mb-4 py-3.5 rounded-xl bg-slate-800 text-white font-bold text-xs flex items-center justify-center gap-2 shadow-lg">
                <i class="fas fa-file-pdf text-red-400 text-lg"></i> Gerar Relat√≥rio PDF
            </button>
            <div id="photosContainer" class="photo-grid pb-24"></div>
        </div>

        <!-- VIEW 6: TODAS AS FOTOS -->
        <div id="view-all" class="view-section">
            <div id="allPhotosContainer" class="photo-grid pb-24"></div>
        </div>

    </main>

    <!-- Barra de A√ß√µes (Docks) -->
    <div id="selectionControls" class="fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t p-4 z-[60] fixed-bar-anim hidden-bar flex gap-3 shadow-[0_-10px_25px_rgba(0,0,0,0.1)]">
        <button onclick="AppCore.selectAllPhotos()" class="px-6 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 font-bold text-xs">Todas</button>
        <button onclick="AppCore.deleteSelected()" class="w-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center text-xl active:scale-95 transition"><i class="fas fa-trash-alt"></i></button>
        <button onclick="AppUtils.showToast('Partilha em breve', 'loading')" class="flex-1 bg-blue-600 text-white rounded-xl font-bold active:scale-95 transition shadow-lg">Partilhar (<span id="selCount">0</span>)</button>
    </div>
    
    <div id="selectionControlsAll" class="fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t p-4 z-[60] fixed-bar-anim hidden-bar flex gap-3 shadow-lg">
        <button onclick="AppCore.selectAllPhotos()" class="px-6 py-3 rounded-xl bg-slate-100 font-bold text-xs">Todas</button>
        <button onclick="AppCore.deleteSelected()" class="w-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center text-xl active:scale-95 transition"><i class="fas fa-trash-alt"></i></button>
        <button onclick="AppCore.shareReport()" class="flex-1 bg-blue-600 text-white rounded-xl font-bold active:scale-95 transition shadow-lg">Partilhar (<span id="selCountAll">0</span>)</button>
    </div>

    <div id="industryActions" class="fixed bottom-0 w-full bg-white dark:bg-slate-900 border-t p-4 z-[60] fixed-bar-anim hidden-bar flex gap-3">
        <button onclick="AppCore.deleteSelectedIndustries()" class="w-14 bg-red-50 text-red-500 rounded-xl flex items-center justify-center text-xl active:scale-95 transition"><i class="fas fa-trash-alt"></i></button>
        <button onclick="AppUI.modals.openBulkCategory()" class="flex-1 bg-blue-600 text-white rounded-xl font-bold active:scale-95 transition shadow-lg shadow-blue-500/30">Mudar Categoria</button>
    </div>

    <!-- Navega√ß√£o Inferior (Dock) -->
    <nav id="mainNavBar" class="bottom-nav">
        <div id="nav-general" class="nav-btn active" onclick="AppCore.switchMainTab('general')">
            <i class="fas fa-calendar-day"></i><span>Hoje</span>
        </div>
        <div id="nav-reports" class="nav-btn" onclick="AppCore.switchMainTab('reports')">
            <i class="fas fa-file-invoice"></i><span>Relat√≥rio</span>
        </div>
        <div id="nav-routes" class="nav-btn" onclick="AppCore.switchMainTab('routes')">
            <i class="fas fa-map-marked-alt"></i><span>Locais</span>
        </div>
    </nav>

    <!-- Modais -->
    <div id="routeConfigModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex flex-col justify-end sm:justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl h-[85vh] flex flex-col animate-slide-up">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Agenda Semanal</h3>
            
            <div class="grid grid-cols-7 gap-1 mb-4" id="routeConfigDays"></div>

            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Aloca√ß√£o de Horas</span>
                <span id="currentConfigDay" class="text-[10px] font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-400 px-2 py-1 rounded">...</span>
            </div>

            <div id="routeChecklist" class="flex-1 overflow-y-auto space-y-2 pr-1 custom-scroll"></div>

            <div class="flex gap-3 mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                <button onclick="AppUI.modals.closeRouteConfig()" class="flex-1 py-3.5 text-slate-400 font-bold text-xs hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition">Cancelar</button>
                <button onclick="AppCore.saveRouteConfig()" class="flex-1 bg-blue-600 text-white rounded-xl text-xs font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition">SALVAR</button>
            </div>
        </div>
    </div>

    <div id="addModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex flex-col justify-end sm:justify-center p-0 sm:p-4">
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm sm:rounded-2xl rounded-t-3xl p-6 shadow-2xl animate-slide-up">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 id="modalTitle" class="text-lg font-bold text-slate-800 dark:text-white mb-6">Novo Registo</h3>
            
            <input type="hidden" id="editIndId">
            <div class="space-y-4 mb-6">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Nome</label>
                    <input type="text" id="newIndName" placeholder="Ex: F√°brica Central" class="input-modern mt-1">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Carga (H/Sem)</label>
                        <input type="number" id="newIndHours" placeholder="0" class="input-modern mt-1 text-center font-bold">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Categoria</label>
                        <select id="catSelect" class="input-modern mt-1 appearance-none cursor-pointer"><option value="">Geral</option></select>
                    </div>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Foto de Capa</label>
                    <div class="mt-2 flex items-center gap-4">
                        <div class="w-20 h-20 rounded-2xl bg-slate-100 dark:bg-slate-800 border-2 border-dashed border-slate-300 dark:border-slate-700 flex items-center justify-center overflow-hidden relative group cursor-pointer" onclick="document.getElementById('coverInput').click()">
                            <img id="coverPreview" src="" class="absolute w-full h-full object-cover hidden">
                            <i id="coverPlaceholder" class="fas fa-image text-2xl text-slate-300 group-hover:text-blue-500 transition"></i>
                        </div>
                        <label for="coverInput" class="btn-primary px-5 py-2.5 text-xs cursor-pointer bg-slate-800 text-white shadow-md active:scale-95 transition">Alterar</label>
                        <input type="file" id="coverInput" class="hidden" onchange="AppCore.handleCoverChange(event)">
                    </div>
                </div>
            </div>

            <button id="btnDeleteInd" onclick="AppCore.deleteCurrentIndustry()" class="w-full py-3.5 mb-3 text-red-500 font-bold text-xs bg-red-50 dark:bg-red-900/10 rounded-xl hidden border border-red-100 dark:border-red-900/30 active:scale-95 transition">Excluir Local</button>

            <div class="flex gap-3">
                <button onclick="AppUI.modals.closeAdd()" class="flex-1 py-3.5 text-slate-400 font-bold text-xs hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition">Cancelar</button>
                <button onclick="AppCore.saveIndustry()" class="flex-1 btn-primary py-3.5 text-xs shadow-lg shadow-blue-500/30">SALVAR</button>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="fixed inset-0 bg-black/95 z-[110] hidden flex flex-col justify-center items-center opacity-0 transition-opacity duration-300">
        <div class="absolute top-0 w-full p-4 flex justify-between z-20">
            <button onclick="AppUI.modals.closePhoto()" class="w-10 h-10 bg-white/10 rounded-full text-white flex items-center justify-center active:scale-90 transition"><i class="fas fa-times text-xl"></i></button>
            <button onclick="AppCore.deleteSinglePhoto()" class="w-10 h-10 bg-red-500/80 backdrop-blur-md rounded-full text-white flex items-center justify-center active:scale-90 transition shadow-lg shadow-red-500/20"><i class="fas fa-trash"></i></button>
        </div>
        <img id="previewImg" src="" class="max-h-[65vh] max-w-full object-contain mb-4 rounded-lg shadow-2xl">
        
        <div class="w-full max-w-sm px-6">
            <div class="bg-white/10 backdrop-blur-md p-1.5 rounded-2xl border border-white/20 flex gap-2">
                <input type="text" id="photoDescInput" placeholder="Adicionar nota..." class="bg-transparent text-white placeholder-white/50 text-sm flex-1 px-3 py-2 outline-none font-medium">
                <button onclick="AppCore.savePhotoDescription()" class="bg-blue-600 text-white px-4 rounded-xl font-bold text-xs shadow-lg active:scale-95 transition">OK</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="statusToast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl shadow-slate-500/20 text-xs font-bold flex items-center gap-3 transition-all opacity-0 -translate-y-10 z-[120]">
        <div id="toastIcon"></div>
        <span id="toastMsg">Notifica√ß√£o</span>
    </div>

    <!-- === L√ìGICA JAVASCRIPT === -->
    <script>
        const SUPABASE_URL = 'https://hluxaxbjdpbezvffisns.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhsdXhheGJqZHBiZXp2ZmZpc25zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTg3NDgsImV4cCI6MjA4MDU5NDc0OH0.lia_McknZ7SD2EGlNchRVZ9d359bFkk7hSJXJYhJzig';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const BUCKET = 'galeria';
        const WEEK_DAYS = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        const CATEGORY_COLORS = ['bg-blue-100 text-blue-600', 'bg-green-100 text-green-600', 'bg-purple-100 text-purple-600', 'bg-orange-100 text-orange-600', 'bg-pink-100 text-pink-600', 'bg-teal-100 text-teal-600'];

        const AppState = {
            currentIndustry: null, currentDateFolder: null, industryPhotos: [], allIndustries: [], categories: [],
            routes: { 'Domingo': [], 'Segunda': [], 'Ter√ßa': [], 'Quarta': [], 'Quinta': [], 'Sexta': [], 'S√°bado': [] },
            isSelectionMode: false, selectedPhotos: new Set(), selectedIndustries: new Set(),
            currentModalPhoto: null, coverImageFile: null, calendarCursor: new Date(), availableDates: new Set(),
            configSelectedDay: null, viewSelectedDay: null, viewHistory: [], userId: 'anonymous', searchTimeout: null
        };

        const AppUtils = {
            minutesToHM: (m) => `${String(Math.floor(m / 60)).padStart(2,'0')}:${String(m % 60).padStart(2,'0')}`,
            hmToMinutes: (hm) => hm ? hm.split(':').map(Number).reduce((h, m) => h * 60 + m) : 0,
            sanitize: (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "_"),
            showToast: (msg, type = 'loading') => {
                const toast = document.getElementById('statusToast'); 
                const msgEl = document.getElementById('toastMsg');
                if(!toast || !msgEl) return;
                msgEl.innerText = msg;
                toast.classList.remove('opacity-0', '-translate-y-10');
                const icon = document.getElementById('toastIcon');
                if (type === 'success') icon.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                else if (type === 'error') icon.innerHTML = '<i class="fas fa-times text-red-400"></i>';
                else icon.innerHTML = '<div class="loader"></div>';
                setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 2500);
            },
            toggleDarkMode: () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); },
            getGPS: () => new Promise((res) => {
                if(!navigator.geolocation) return res(null);
                navigator.geolocation.getCurrentPosition((p) => res(`${p.coords.latitude.toFixed(5)}, ${p.coords.longitude.toFixed(5)}`), () => res(null), { timeout: 3000 });
            }),
            resizeImage: (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const max = 1200;
                            const scale = max / Math.max(img.width, img.height);
                            canvas.width = img.width * scale; canvas.height = img.height * scale;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.85);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        };

        const AppCore = {
            init: async () => {
                if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
                try {
                    await Promise.all([AppCore.loadIndustries(), AppCore.fetchRoutes(), AppCore.loadCategories()]);
                    const today = WEEK_DAYS[new Date().getDay()];
                    AppState.viewSelectedDay = today;
                    AppUI.renderRouteList(today);
                    AppUI.updateDashboard();
                    AppCore.checkAlerts();
                } catch (e) { console.error(e); }
            },
            loadIndustries: async () => {
                const { data } = await sb.from('industrias').select('*, categorias(nome)').order('nome');
                AppState.allIndustries = data || [];
                AppUI.renderIndustries(AppState.allIndustries);
                AppUI.renderCategoryOptions();
            },
            fetchRoutes: async () => {
                const { data } = await sb.from('rotas').select('*');
                if (data) data.forEach(r => AppState.routes[r.dia] = r.industrias || []);
            },
            loadCategories: async () => {
                const { data } = await sb.from('categorias').select('*').order('nome');
                AppState.categories = data || [];
                AppUI.renderCategoryOptions();
            },
            uploadPhoto: async (input) => {
                const f = input.files[0]; if (!f || !AppState.currentIndustry) return;
                AppUtils.showToast("A processar imagem e GPS...");
                const gps = await AppUtils.getGPS();
                try {
                    const safeName = AppUtils.sanitize(AppState.currentIndustry.nome);
                    const now = new Date();
                    const targetDate = AppState.currentDateFolder || now.toLocaleDateString('pt-PT').replace(/\//g, '-');
                    const fileName = `${safeName}/${targetDate}/FOTO_${now.getTime()}.jpg`;
                    const blob = await AppUtils.resizeImage(f);
                    await sb.storage.from(BUCKET).upload(fileName, blob, { contentType: 'image/jpeg' });
                    const { data: urlData } = sb.storage.from(BUCKET).getPublicUrl(fileName);
                    await sb.from('fotos').insert({
                        created_at: now.toISOString(), nome_arquivo: fileName, url_publica: urlData.publicUrl,
                        industria_id: AppState.currentIndustry.id, descricao: gps ? `üìç GPS: ${gps}` : ''
                    }).select();
                    AppUtils.showToast("Foto guardada!", "success");
                    await AppCore.loadDates(AppState.currentIndustry.nome);
                    if (document.getElementById('view-gallery').classList.contains('active')) AppUI.loadGalleryPhotos();
                } catch (e) { AppUtils.showToast("Erro no envio", "error"); } finally { input.value = ''; }
            },
            loadDates: async (name) => {
                const safe = AppUtils.sanitize(name);
                const { data: allPhotos } = await sb.from('fotos').select('*').like('nome_arquivo', `${safe}/%`).order('created_at', { ascending: false });
                AppState.industryPhotos = allPhotos || [];
                AppState.availableDates.clear();
                AppState.industryPhotos.forEach(p => AppState.availableDates.add(new Date(p.created_at).toLocaleDateString('pt-PT')));
                AppUI.renderCalendar();
            },
            changeCalendarMonth: (o) => { AppState.calendarCursor.setMonth(AppState.calendarCursor.getMonth() + o); AppUI.renderCalendar(); },
            checkAlerts: async () => {
                const { data } = await sb.from('fotos').select('industria_id, created_at').order('created_at', { ascending: false });
                const lastVisits = {};
                data?.forEach(f => { if(!lastVisits[f.industria_id]) lastVisits[f.industria_id] = new Date(f.created_at); });
                const threshold = new Date(); threshold.setDate(threshold.getDate() - 7);
                const late = AppState.allIndustries.filter(i => !lastVisits[i.id] || lastVisits[i.id] < threshold);
                if(late.length > 0) {
                    document.getElementById('visitAlerts').classList.remove('hidden');
                    document.getElementById('visitAlertMsg').innerText = `${late.length} locais sem visitas h√° mais de 7 dias.`;
                }
            },
            generateDailyConsolidatedReport: async () => {
                const today = WEEK_DAYS[new Date().getDay()];
                const route = AppState.routes[today] || [];
                if(route.length === 0) return AppUtils.showToast("Nada agendado para hoje.", "error");
                AppUtils.showToast("A gerar PDF di√°rio...", "loading");
                const { jsPDF } = window.jspdf; const doc = new jsPDF();
                doc.setFontSize(18); doc.text("Relat√≥rio Industrial Di√°rio", 10, 20);
                doc.setFontSize(10); doc.text("Data: " + new Date().toLocaleDateString('pt-PT'), 10, 28);
                doc.line(10, 32, 200, 32);
                let y = 45;
                for(const item of route) {
                    const ind = AppState.allIndustries.find(i => i.nome === (item.nome || item));
                    if(!ind) continue;
                    const todayStart = new Date(); todayStart.setHours(0,0,0,0);
                    const { data: photos } = await sb.from('fotos').select('*').eq('industria_id', ind.id).gte('created_at', todayStart.toISOString());
                    if (y > 240) { doc.addPage(); y = 20; }
                    doc.setFontSize(14); doc.setTextColor(37, 99, 235); doc.text(ind.nome, 10, y); doc.setTextColor(0); y += 10;
                    if(photos?.length > 0) {
                        for(const f of photos) {
                            try {
                                const img = await fetch(f.url_publica).then(r => r.blob()).then(b => new Promise(res => { const fr = new FileReader(); fr.onloadend = () => res(fr.result); fr.readAsDataURL(b); }));
                                if (y > 230) { doc.addPage(); y = 20; }
                                doc.addImage(img, 'JPEG', 15, y, 40, 40);
                                doc.setFontSize(9); const split = doc.splitTextToSize(f.descricao || "Sem notas.", 120); doc.text(split, 60, y + 5);
                                y += 45;
                            } catch(e) {}
                        }
                    } else { doc.setFontSize(9); doc.text("Nenhuma actividade hoje.", 15, y); y += 8; }
                    y += 5;
                }
                doc.save(`Relatorio_Hoje.pdf`); AppUtils.showToast("Relat√≥rio Conclu√≠do!", "success");
            },
            saveIndustry: async () => {
                const id = document.getElementById('editIndId').value;
                const name = document.getElementById('newIndName').value.trim();
                const hours = parseInt(document.getElementById('newIndHours').value) || 0;
                const catId = document.getElementById('catSelect').value || null;
                if(!name || !confirm("Deseja gravar as altera√ß√µes?")) return;
                AppUtils.showToast("A guardar...");
                const payload = { nome: name, categoria_id: catId, carga_semanal: hours };
                if(id) await sb.from('industrias').update(payload).eq('id', id).select();
                else await sb.from('industrias').insert(payload).select();
                AppUI.modals.closeAdd(); AppCore.loadIndustries(); AppUtils.showToast("Guardado!", "success");
            },
            deleteIndustry: async (id, e, indName) => {
                if(e) e.stopPropagation();
                if(!confirm(`Apagar "${indName}" e TODAS as fotos?`)) return;
                AppUtils.showToast("A apagar...");
                await sb.from('industrias').delete().eq('id', id);
                AppCore.loadIndustries(); AppUtils.showToast("Eliminado", "success");
            },
            deleteCurrentIndustry: async () => { if(!confirm("Eliminar local atual?")) return; AppUI.modals.closeAdd(); await AppCore.deleteIndustry(AppState.currentIndustry.id, null, AppState.currentIndustry.nome); AppUI.navigateTo('view-home'); },
            savePhotoDescription: async () => {
                if(!AppState.currentModalPhoto) return;
                const desc = document.getElementById('photoDescInput').value;
                await sb.from('fotos').update({ descricao: desc }).eq('id', AppState.currentModalPhoto.id).select();
                AppState.currentModalPhoto.descricao = desc; AppUtils.showToast("Guardado", "success"); AppUI.loadGalleryPhotos();
            },
            saveRouteConfig: async () => {
                if(!confirm("Salvar agenda semanal?")) return;
                AppUtils.showToast("A guardar...");
                await sb.from('rotas').upsert({ dia: AppState.configSelectedDay, industrias: AppState.routes[AppState.configSelectedDay] }, { onConflict: 'dia' }).select();
                if (AppState.configSelectedDay === AppState.viewSelectedDay) AppUI.renderRouteList(AppState.configSelectedDay);
                AppUI.modals.closeRouteConfig(); AppUI.updateDashboard(); AppUtils.showToast("Agenda Guardada", "success");
            },
            switchMainTab: (t) => { AppState.viewHistory = []; const m = { general: 'view-home', reports: 'view-reports', routes: 'view-routes' }; AppUI.navigateTo(m[t], false); },
            goBack: () => { AppUI.navigateTo(AppState.viewHistory.pop() || 'view-home', false); },
            toggleSelectionMode: () => {
                AppState.isSelectionMode = !AppState.isSelectionMode;
                const b = document.getElementById('selectBtn');
                const bars = ['selectionControls', 'selectionControlsAll', 'industryActions'];
                bars.forEach(id => document.getElementById(id).classList.add('hidden-bar'));
                if (AppState.isSelectionMode) {
                    b.innerText = "Cancelar"; b.classList.add('text-red-500');
                    if (document.getElementById('view-routes').classList.contains('active')) document.getElementById('industryActions').classList.remove('hidden-bar');
                    else if (document.getElementById('view-all').classList.contains('active')) document.getElementById('selectionControlsAll').classList.remove('hidden-bar');
                    else document.getElementById('selectionControls').classList.remove('hidden-bar');
                } else {
                    b.innerText = "Select"; b.classList.remove('text-red-500');
                    AppState.selectedPhotos.clear(); AppState.selectedIndustries.clear();
                }
                if (document.getElementById('view-routes').classList.contains('active')) AppUI.renderIndustries(AppState.allIndustries);
                else AppUI.loadGalleryPhotos();
            },
            handlePhotoClick: (f) => {
                if (AppState.isSelectionMode) { if (AppState.selectedPhotos.has(f.id)) AppState.selectedPhotos.delete(f.id); else AppState.selectedPhotos.add(f.id); document.getElementById('selCount').innerText = AppState.selectedPhotos.size; AppUI.loadGalleryPhotos(); } 
                else { AppState.currentModalPhoto = f; AppUI.modals.openPhoto(f); }
            },
            handleCoverChange: (e) => { const f = e.target.files[0]; if(!f) return; AppState.coverImageFile = f; document.getElementById('coverPreview').src = URL.createObjectURL(f); document.getElementById('coverPreview').classList.remove('hidden'); document.getElementById('coverPlaceholder').classList.add('hidden'); },
            filterIndustries: () => {
                const term = document.getElementById('searchInput').value.toLowerCase();
                const cat = document.getElementById('catSelectFilter').value;
                const filtered = AppState.allIndustries.filter(i => i.nome.toLowerCase().includes(term) && (cat === "" || i.categoria_id == cat));
                AppUI.renderIndustries(filtered);
            },
            selectAllPhotos: () => { AppState.industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-PT') === AppState.currentDateFolder).forEach(f => AppState.selectedPhotos.add(f.id)); AppUI.loadGalleryPhotos(); },
            deleteSelected: async () => { if(!confirm("Apagar fotos?")) return; await sb.from('fotos').delete().in('id', Array.from(AppState.selectedPhotos)); AppState.selectedPhotos.clear(); AppCore.toggleSelectionMode(); if(AppState.currentIndustry) AppCore.loadDates(AppState.currentIndustry.nome); },
            deleteSinglePhoto: async () => { if(!confirm("Apagar?")) return; await sb.from('fotos').delete().eq('id', AppState.currentModalPhoto.id); AppUI.modals.closePhoto(); if(AppState.currentIndustry) AppCore.loadDates(AppState.currentIndustry.nome); AppUI.loadGalleryPhotos(); },
            openAllPhotos: async () => {
                AppUI.navigateTo('view-all'); const c = document.getElementById('allPhotosContainer'); c.innerHTML = '<div class="col-span-3 py-20 flex justify-center"><div class="loader"></div></div>';
                const { data } = await sb.from('fotos').select('*').order('created_at', { ascending: false }).limit(60);
                c.innerHTML = '';
                data?.forEach(f => {
                    const d = document.createElement('div'); d.className = `photo-thumb ${AppState.selectedPhotos.has(f.id) ? 'selected' : ''}`;
                    d.onclick = () => AppCore.handlePhotoClick(f); d.innerHTML = `<img src="${f.url_publica}">`; c.appendChild(d);
                });
            },
            saveBulkCategory: async () => { const catId = document.getElementById('bulkCatSelect').value || null; const ids = Array.from(AppState.selectedIndustries); if(!confirm("Aplicar categorias?")) return; AppUtils.showToast("Atualizando...", "loading"); try { await sb.from('industrias').update({ categoria_id: catId }).in('id', ids); AppUtils.showToast("Atualizado!", "success"); document.getElementById('bulkCatModal').classList.add('hidden'); AppState.selectedIndustries.clear(); await AppCore.loadIndustries(); } catch (e) { AppUtils.showToast("Erro", "error"); } },
            deleteSelectedIndustries: async () => { if (AppState.selectedIndustries.size === 0) return; if (!confirm("Apagar selecionados?")) return; AppUtils.showToast("Apagando...", "loading"); try { await sb.from('industrias').delete().in('id', Array.from(AppState.selectedIndustries)); AppState.selectedIndustries.clear(); await AppCore.loadIndustries(); AppUtils.showToast("Apagado!", "success"); } catch (e) { AppUtils.showToast("Erro", "error"); } },
            generatePDF: async () => {
                AppUtils.showToast("A gerar PDF...");
                const { jsPDF } = window.jspdf; const doc = new jsPDF();
                doc.setFontSize(16); doc.text(AppState.currentIndustry.nome, 10, 15);
                doc.setFontSize(10); doc.text("Data: " + AppState.currentDateFolder, 10, 22);
                doc.line(10, 25, 200, 25);
                let y = 35;
                const photos = AppState.industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-PT') === AppState.currentDateFolder);
                for(const f of photos) {
                    try {
                        const img = await fetch(f.url_publica).then(r => r.blob()).then(b => new Promise(res => { const fr = new FileReader(); fr.onloadend = () => res(fr.result); fr.readAsDataURL(b); }));
                        if (y > 240) { doc.addPage(); y = 20; }
                        doc.addImage(img, 'JPEG', 10, y, 60, 60);
                        doc.setFontSize(9); const splitText = doc.splitTextToSize(f.descricao || "Sem notas.", 120); doc.text(splitText, 75, y + 10);
                        y += 65;
                    } catch(e) {}
                }
                doc.save(`Relatorio_${AppUtils.sanitize(AppState.currentIndustry.nome)}.pdf`);
                AppUtils.showToast("PDF Transferido!", "success");
            },
            shareReport: async () => {
                AppUtils.showToast("A preparar relat√≥rio...", "loading");
                // Fallback para download simples j√° que Share API com ficheiro requer contexto HTTPS seguro e ficheiro f√≠sico.
                AppCore.generatePDF();
            }
        };

        const AppUI = {
            navigateTo: (id, hist = true) => {
                const active = document.querySelector('.view-section.active');
                if (hist && active) AppState.viewHistory.push(active.id);
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                const els = { back: 'backBtn', config: 'configRouteBtn', sel: 'selectBtn', nav: 'mainNavBar', edit: 'editIndBtn' };
                const show = (eid) => document.getElementById(els[eid])?.classList.remove('hidden');
                const hide = (eid) => document.getElementById(els[eid])?.classList.add('hidden');
                hide('back'); hide('config'); hide('sel'); hide('edit');
                ['selectionControls', 'selectionControlsAll', 'industryActions'].forEach(dock => document.getElementById(dock)?.classList.add('hidden-bar'));
                if (id === 'view-home') show('config');
                else if (id === 'view-routes') show('sel');
                else if (id === 'view-dates') { show('back'); show('edit'); }
                else if (id === 'view-gallery' || id === 'view-all') { show('back'); show('sel'); }
                else show('back');
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const navMap = { 'view-home': 'general', 'view-routes': 'routes', 'view-reports': 'reports' };
                if(navMap[id]) document.getElementById('nav-' + navMap[id]).classList.add('active');
                if(id === 'view-reports') AppUI.renderDailyIndustries();
            },
            updateDashboard: () => {
                document.getElementById('dashTotalInd').innerText = AppState.allIndustries.length;
                const today = WEEK_DAYS[new Date().getDay()];
                const route = AppState.routes[today] || [];
                let total = 0; route.forEach(i => total += (i.minutos || 0));
                document.getElementById('dashWorkLoad').innerText = AppUtils.minutesToHM(total) + 'h';
            },
            renderIndustries: (list) => {
                const c = document.getElementById('industriesList'); c.innerHTML = '';
                if(list.length === 0) { c.innerHTML = '<div class="col-span-3 py-20 text-center opacity-40 italic">Sem locais</div>'; return; }
                list.forEach(ind => {
                    const d = document.createElement('div'); d.className = `ind-card cursor-pointer ${AppState.selectedIndustries.has(ind.id) ? 'selected-item' : ''}`;
                    d.onclick = () => {
                        if (AppState.isSelectionMode) { 
                            if(AppState.selectedIndustries.has(ind.id)) AppState.selectedIndustries.delete(ind.id); 
                            else AppState.selectedIndustries.add(ind.id);
                            AppUI.renderIndustries(AppState.allIndustries);
                        } else { AppState.currentIndustry = ind; AppState.calendarCursor = new Date(); AppUI.navigateTo('view-dates'); AppCore.loadDates(ind.nome); }
                    };
                    const cat = ind.categorias ? `<div class="cat-badge ${CATEGORY_COLORS[(ind.categoria_id - 1) % 6]}">${ind.categorias.nome}</div>` : '';
                    const img = ind.cover_url ? `<img src="${ind.cover_url}">` : '<i class="fas fa-industry text-2xl text-slate-200"></i>';
                    d.innerHTML = `<div class="cover-wrapper flex items-center justify-center">${img}</div><h3 class="font-bold text-[10px] text-center truncate w-full px-1">${ind.nome}</h3>${cat}<span class="text-[8px] text-slate-400 font-bold uppercase">${ind.carga_semanal || 0}H/SEM</span>`;
                    c.appendChild(d);
                });
            },
            renderRouteList: (day) => {
                const c = document.getElementById('routeListContent'); c.innerHTML = '';
                const tabs = document.getElementById('routeTabsContainer'); tabs.innerHTML = '';
                WEEK_DAYS.forEach(d => {
                    const t = document.createElement('div'); t.innerText = d.substring(0, 3);
                    t.className = `day-tab ${d === day ? 'active' : ''} ${d === 'Domingo' ? 'text-red-400' : ''}`;
                    t.onclick = () => AppUI.renderRouteList(d); tabs.appendChild(t);
                });
                const items = AppState.routes[day] || [];
                if(items.length === 0) { c.innerHTML = '<div class="py-12 flex flex-col items-center justify-center text-slate-300"><i class="fas fa-calendar-check text-4xl mb-2"></i><p class="text-[10px] uppercase font-bold">Dia Livre</p></div>'; return; }
                items.forEach(item => {
                    const ind = AppState.allIndustries.find(i => i.nome === (item.nome || item));
                    if(!ind) return;
                    const row = document.createElement('div'); row.className = 'route-item';
                    row.onclick = () => { AppState.currentIndustry = ind; AppUI.navigateTo('view-dates'); AppCore.loadDates(ind.nome); };
                    row.innerHTML = `<div class="w-10 h-10 rounded-lg bg-slate-100 overflow-hidden mr-3 flex-shrink-0">${ind.cover_url ? `<img src="${ind.cover_url}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center bg-slate-50"><i class="fas fa-industry text-slate-300"></i></div>'}</div><div class="flex-1 overflow-hidden"><div class="font-bold text-sm truncate">${ind.nome}</div><div class="text-[9px] text-slate-400 font-bold uppercase">${ind.categorias?.nome || 'Geral'}</div></div><div class="text-xs font-mono font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">${AppUtils.minutesToHM(item.minutos || 0)}h</div>`;
                    c.appendChild(row);
                });
            },
            renderCalendar: () => {
                const c = document.getElementById('calendarGrid'); c.innerHTML = '<div class="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] font-bold text-slate-400 uppercase tracking-tighter"><span>Dom</span><span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span></div>';
                const grid = document.createElement('div'); grid.className = 'cal-grid';
                const y = AppState.calendarCursor.getFullYear(), m = AppState.calendarCursor.getMonth();
                document.getElementById('calendarTitle').innerText = new Date(y, m).toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
                const first = new Date(y, m, 1).getDay(); const days = new Date(y, m + 1, 0).getDate();
                for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
                const todayStr = new Date().toLocaleDateString('pt-PT');
                for(let d=1; d<=days; d++) {
                    const dateStr = new Date(y, m, d).toLocaleDateString('pt-PT');
                    const b = document.createElement('div'); b.className = `cal-day ${AppState.availableDates.has(dateStr) ? 'active' : ''} ${dateStr === todayStr ? 'today' : ''}`; b.innerText = d;
                    if(AppState.availableDates.has(dateStr)) b.onclick = () => { AppState.currentDateFolder = dateStr; AppUI.navigateTo('view-gallery'); AppUI.loadGalleryPhotos(); };
                    grid.appendChild(b);
                }
                c.appendChild(grid);
            },
            loadGalleryPhotos: () => {
                const c = document.getElementById('photosContainer'); c.innerHTML = '';
                const p = AppState.industryPhotos.filter(f => new Date(f.created_at).toLocaleDateString('pt-PT') === AppState.currentDateFolder);
                p.forEach(f => {
                    const d = document.createElement('div'); d.className = `photo-thumb ${AppState.selectedPhotos.has(f.id) ? 'selected' : ''}`;
                    d.onclick = () => AppCore.handlePhotoClick(f); d.innerHTML = `<img src="${f.url_publica}" loading="lazy">${f.descricao ? '<div class="absolute bottom-1 right-1 w-2 h-2 bg-yellow-400 rounded-full shadow-sm"></div>' : ''}`;
                    c.appendChild(d);
                });
            },
            renderDailyIndustries: () => {
                const c = document.getElementById('dailyIndustriesList'); c.innerHTML = '';
                const today = WEEK_DAYS[new Date().getDay()];
                const route = AppState.routes[today] || [];
                if(route.length === 0) { c.innerHTML = '<p class="text-center py-4 text-xs italic opacity-50">Nenhum local na rota de hoje.</p>'; return; }
                route.forEach(item => {
                    const d = document.createElement('div'); d.className = 'flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg';
                    d.innerHTML = `<span class="text-sm font-bold">${item.nome || item}</span><i class="fas fa-check-circle text-blue-500"></i>`;
                    c.appendChild(d);
                });
            },
            renderRouteChecklist: () => {
                const l = document.getElementById('routeChecklist'); l.innerHTML = '';
                const day = AppState.configSelectedDay || 'Segunda';
                AppState.allIndustries.forEach(ind => {
                    const item = AppState.routes[day]?.find(r => (r.nome || r) === ind.nome);
                    const d = document.createElement('div'); d.className = 'flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm';
                    d.innerHTML = `<input type="checkbox" ${item?'checked':''} onchange="AppUI.toggleRouteCheck('${ind.nome.replace(/'/g, "\\'")}', this.checked)"><span class="flex-1 text-xs font-bold truncate">${ind.nome}</span><input type="time" class="time-input" value="${AppUtils.minutesToHM(item?.minutos || 0)}" onchange="AppUI.updateRouteMins('${ind.nome.replace(/'/g, "\\'")}', this.value)">`;
                    l.appendChild(d);
                });
            },
            toggleRouteCheck: (name, checked) => {
                const day = AppState.configSelectedDay;
                if(!AppState.routes[day]) AppState.routes[day] = [];
                if(checked) AppState.routes[day].push({ nome: name, minutos: 0 });
                else AppState.routes[day] = AppState.routes[day].filter(r => (r.nome || r) !== name);
                AppUI.renderRouteChecklist();
            },
            updateRouteMins: (name, val) => {
                const item = AppState.routes[AppState.configSelectedDay]?.find(r => (r.nome || r) === name);
                if(item) item.minutos = AppUtils.hmToMinutes(val);
            },
            renderCategoryOptions: () => {
                ['catSelect', 'catSelectFilter', 'bulkCatSelect'].forEach(id => {
                    const s = document.getElementById(id); if(!s) return;
                    s.innerHTML = id === 'catSelectFilter' ? '<option value="">Categorias</option>' : '<option value="">Geral</option>';
                    AppState.categories.forEach(c => s.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
                });
            },
            modals: {
                openRouteConfig: () => { 
                    AppState.configSelectedDay = WEEK_DAYS[new Date().getDay()];
                    document.getElementById('routeConfigModal').classList.remove('hidden');
                    const c = document.getElementById('routeConfigDays'); c.innerHTML = '';
                    WEEK_DAYS.forEach(d => {
                        const b = document.createElement('button'); b.innerText = d.substring(0,1);
                        b.className = `p-2.5 rounded-lg text-[10px] font-black ${d === AppState.configSelectedDay ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-50 dark:bg-slate-800 text-slate-400'}`;
                        b.onclick = () => { AppState.configSelectedDay = d; AppUI.modals.openRouteConfig(); };
                        c.appendChild(b);
                    });
                    document.getElementById('currentConfigDay').innerText = AppState.configSelectedDay; AppUI.renderRouteChecklist();
                },
                closeRouteConfig: () => document.getElementById('routeConfigModal').classList.add('hidden'),
                openAddIndustry: () => { document.getElementById('addModal').classList.remove('hidden'); document.getElementById('btnDeleteInd').classList.add('hidden'); document.getElementById('modalTitle').innerText="Novo Local"; document.getElementById('editIndId').value=""; document.getElementById('newIndName').value=""; document.getElementById('newIndHours').value=""; document.getElementById('coverPreview').classList.add('hidden'); document.getElementById('coverPlaceholder').classList.remove('hidden'); },
                openEditIndustry: () => { if(!AppState.currentIndustry) return; AppUI.modals.openAddIndustry(); document.getElementById('modalTitle').innerText="Editar"; document.getElementById('btnDeleteInd').classList.remove('hidden'); document.getElementById('editIndId').value = AppState.currentIndustry.id; document.getElementById('newIndName').value = AppState.currentIndustry.nome; document.getElementById('newIndHours').value = AppState.currentIndustry.carga_semanal; },
                closeAdd: () => document.getElementById('addModal').classList.add('hidden'),
                openPhoto: (f) => { document.getElementById('previewImg').src = f.url_publica; document.getElementById('photoDescInput').value = f.descricao || ''; const m = document.getElementById('photoModal'); m.classList.remove('hidden'); setTimeout(() => m.classList.add('opacity-100'), 10); },
                closePhoto: () => { const m = document.getElementById('photoModal'); m.classList.remove('opacity-100'); setTimeout(() => m.classList.add('hidden'), 300); },
                openBulkCategory: () => { if(AppState.selectedIndustries.size === 0) return; document.getElementById('bulkCatModal').classList.remove('hidden'); document.getElementById('bulkCountDisplay').innerText = AppState.selectedIndustries.size; }
            }
        };

        window.onload = AppCore.init;
    </script>
</body>
</html>
